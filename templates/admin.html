<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Товары — Админка | Piligrim</title>
      <meta name="csrf-token" content="{{ csrf_token() }}">

  <script>
// Глобальное хранилище актуального токена
window.csrfToken = "{{ csrf_token() }}";

// Автоматически обновляем токен при любом успешном ответе от сервера
function updateCsrfTokenFromResponse(data) {
    if (data.csrf_token) {
        window.csrfToken = data.csrf_token;
        document.querySelector('meta[name="csrf-token"]')?.setAttribute('content', data.csrf_token);
    }
}

// Перехватываем ВСЕ fetch-запросы (POST, PUT, DELETE и т.д.)
const { fetch: origFetch } = window;
window.fetch = async (...args) => {
    let [resource, config] = args;
    
    // Только для мутирующих методов
    if (config && ['POST','PUT','DELETE','PATCH'].includes((config.method || 'GET').toUpperCase())) {
        config = config || {};
        config.headers = config.headers || {};
        config.headers['X-CSRF-Token'] = window.csrfToken;
        config.headers['X-Requested-With'] = 'XMLHttpRequest';
        
        // Если отправляем FormData — не трогаем Content-Type (браузер сам поставит с boundary)
        if (!(config.body instanceof FormData)) {
            config.headers['Content-Type'] = 'application/json';
        }
    }

    const response = await origFetch(resource, config);
    
    // Автоматически обновляем токен после любого успешного JSON-ответа
    if (response.ok && response.headers.get('content-type')?.includes('application/json')) {
        try {
            const data = await response.clone().json();
            updateCsrfTokenFromResponse(data);
        } catch (e) { /* не JSON — игнорируем */ }
    }

    return response;
};
  </script>


    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

    <link rel="stylesheet" href="/static/css/admin/admin_reviews.css">
    <link rel="stylesheet" href="/static/css/admin/admin_goods.css">
    <link rel="stylesheet" href="/static/css/admin/admin_good.css">

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="icon" href="/favicon.ico">
    <link rel="manifest" href="/site.webmanifest">

</head>
<body>

    <header>
        <a href="/" class="logo"><img src="/static/assets/logo.png" alt="ZAZA" class="logo-img"></a>
        <nav style="margin-left: auto;"><a href="/" class="nav-link">Главная</a></nav>
    </header>

<aside class="sidebar">
    <h3 class="sidebar-title">Админка</h3>
    <div class="sidebar-menu">
        <a href="/admin" class="sidebar-item active"><i class="fas fa-box"></i><span>Товары</span></a>
        <a href="/admin_services" class="sidebar-item"><i class="fas fa-balance-scale"></i><span>Услуги</span></a>
        <a href="/admin_news" class="sidebar-item"><i class="fas fa-newspaper"></i><span>Новости</span></a>
        <a href="/carousel-editor" class="sidebar-item"><i class="fas fa-images"></i><span>Редактор баннеров</span></a>
        <a href="/admin_dispatch" class="sidebar-item"><i class="fas fa-paper-plane"></i><span>Рассылки</span></a>
        <a href="/admin_bills" class="sidebar-item"><i class="fas fa-file-invoice"></i><span>Счета</span></a>
        <a href="/admin_documents" class="sidebar-item"><i class="fas fa-file-contract"></i><span>Документы</span></a>
        <a href="/admin_feedback" class="sidebar-item"><i class="fas fa-envelope"></i><span>Обратная связь<div class="sidebar-badge">{{ total_feedback }}</div></span></a>
        <a href="/admin_users" class="sidebar-item"><i class="fas fa-users"></i><span>Пользователи<div class="sidebar-badge">{{ total_users }}</div></span></a>
        <a href="/admin_reviews" class="sidebar-item"><i class="fas fa-star"></i><span>Отзывы<div class="sidebar-badge">{{ total_reviews }}</div></span></a>
        <a href="/admin_orders" class="sidebar-item"><i class="fas fa-shopping-cart"></i><span>Заказы<div class="sidebar-badge">{{ total_orders }}</div></span></a>
    </div>
</aside>

    <main class="main-content">
        <div class="admin-container">
            <h1 class="section-title">Товары</h1>

            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                {% for category, message in messages %}
                  <div class="flash {{ 'success' if category != 'error' else 'error' }}">{{ message | safe }}</div>
                {% endfor %}
              {% endif %}
            {% endwith %}

            <!-- Сворачиваемая форма добавления -->
            <div class="add-form-wrapper" id="addFormWrapper">
                <div class="add-form-header" onclick="document.getElementById('addFormWrapper').classList.toggle('collapsed')">
                    <h3>Добавить новый товар</h3>
                    <i class="fas fa-chevron-down"></i>
                </div>

                <div class="add-form-body">
                    <form id="addForm" enctype="multipart/form-data">
                        <input type="hidden" name="action" value="add">

                        <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 1.2rem;">
                            <div class="form-group">
                                <label>Название <span style="color:#ff4444;">*</span></label>
                                <div class="input-wrapper">
                                    <i class="fas fa-tag input-icon"></i>
                                    <input type="text" name="title" placeholder="iPhone 15 Pro Max" required>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Цена (₽) <span style="color:#ff4444;">*</span></label>
                                <div class="input-wrapper">
                                    <i class="fas fa-ruble-sign input-icon"></i>
                                    <input type="number" step="0.01" name="price_rub" placeholder="129990.00" min="0.01" required>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Категория <span style="color:#ff4444;">*</span></label>
                                <div class="input-wrapper">
                                    <i class="fas fa-folder input-icon"></i>
                                    <input type="text" name="category" placeholder="phones" required>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Бренд</label>
                                <div class="input-wrapper">
                                    <i class="fas fa-copyright input-icon"></i>
                                    <input type="text" name="brand" placeholder="Apple">
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Количество <small style="color:#888;">(-1 = ∞)</small></label>
                                <div class="input-wrapper">
                                    <i class="fas fa-boxes input-icon"></i>
                                    <input type="number" name="stock" value="-1">
                                </div>
                            </div>

                            <div class="form-group" style="align-self: end;">
                                <label class="checkbox-wrapper">
                                    <input type="checkbox" name="in_stock" checked>
                                    <span class="checkmark"></span>
                                    В наличии
                                </label>
                            </div>
                        </div>

                        <div class="form-group" style="grid-column: 1 / -1; margin-top: 1.2rem;">
                            <label>Описание</label>
                            <div class="input-wrapper">
                                <i class="fas fa-align-left input-icon" style="top:14px;"></i>
                                <textarea name="full_desc" rows="5" placeholder="Краткое описание..."></textarea>
                            </div>
                        </div>

                        <div class="form-group" style="grid-column: 1 / -1; margin-top: 1rem;">
                            <label>Фото товара</label>
                            <div class="drop-zone" id="addDropZone">
                                <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; margin-bottom: 0.5rem; color:#666;"></i>
                                <p>Перетащите фото сюда или <span style="color:#00ff9d; text-decoration:underline;">кликните для выбора</span></p>
                                <input type="file" name="images[]" multiple accept="image/*" id="addFileInput" style="display:none;">
                            </div>
                            <div class="image-preview" id="addPreview"></div>
                        </div>

                        <div style="grid-column: 1 / -1; margin-top: 1rem;">
                            <button type="button" class="btn-zaza-primary" id="addSubmitBtn">
                                <i class="fas fa-plus-circle"></i> Добавить товар
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Поиск по названию, категории, бренду..." onkeyup="filterProducts()">
            </div>

            <div class="card">
                {% if products|length == 0 %}
                <div class="no-products"><i class="fas fa-box-open"></i><p style="font-size:1.6rem;">Товаров пока нет</p></div>
                {% else %}
                <table class="products-table">
                    <thead>
                        <tr>
                            <th>Фото</th>
                            <th>Название</th>
                            <th>Цена</th>
                            <th>Категория / Бренд</th>
                            <th>Наличие</th>
                            <th style="width:140px;">Действия</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        {% for p in products %}
                        <tr class="product-row" data-id="{{ p.id }}">
<td>
    {% if p.image_filenames and p.image_filenames|length > 0 %}
        <img src="/static/uploads/goods/{{ p.image_filenames[0] }}" 
             class="product-thumb" 
             onerror="this.onerror=null; this.src='/static/assets/no-image.png'; this.style.opacity='0.6';">
    {% else %}
        <div style="width:56px;height:56px;background:#222;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#555;font-size:0.7rem;">—</div>
    {% endif %}
</td>
                            <td>
                                <div style="font-weight:600;">{{ p.title }}</div>
                                {% if p.full_desc %}
    <div style="font-size:0.85rem;color:#999;margin-top:0.3rem;max-width:360px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
        {{ p.description[:70] }}{% if p.full_desc|length > 70 %}...{% endif %}
    </div>
{% endif %}
                            </td>
                            <td class="price-cell">{{ '%.2f'|format(p.price / 100) }} ₽</td>
                            <td><div>{{ p.category }}</div>{% if p.brand %}<div style="color:#999;font-size:0.9rem;">{{ p.brand }}</div>{% endif %}</td>
                            <td><span class="stock-badge">{% if p.stock == -1 %}∞{% else %}{{ p.stock }}{% endif %}</span></td>
                            <td>
                                <div class="action-buttons">
<button class="action-btn edit" onclick="openEditModal(this)"
    data-id="{{ p.id }}"
    data-title="{{ p.title|e }}"
    data-price_rub="{{ (p.price / 100)|round(2) }}"
    data-category="{{ p.category|e }}"
    data-brand="{{ (p.brand or '')|e }}"
    data-full_desc="{{ (p.description or '')|replace('\n', '\\n')|replace('"', '&quot;')|safe }}"
    data-in_stock="{{ p.in_stock|int }}"
    data-stock="{{ p.stock }}"
    data-images={{ p.image_filenames|tojson }}>
    <i class="fas fa-edit"></i>
</button>
<button class="action-btn delete" onclick="deleteProduct('{{ p.id }}')">
    <i class="fas fa-trash-alt"></i>
</button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div class="pagination" id="pagination"></div>
                {% endif %}
            </div>
        </div>
    </main>

    <!-- Модалка редактирования -->
    <div id="editModal" class="modal-overlay">
        <div class="modal">
            <button class="modal-close" onclick="closeModal('editModal')">×</button>
            <h3><i class="fas fa-edit" style="margin-right:10px; color:#00ff9d;"></i> Редактировать товар</h3>
            
            <form id="editForm" enctype="multipart/form-data">
                <input type="hidden" name="product_id" id="edit_id">
                <input type="hidden" name="keep_images" id="keep_images">
                <div class="form-grid" style="gap:1.2rem;">
                    <div class="form-group">
                        <label>Название</label>
                        <div class="input-wrapper">
                            <i class="fas fa-tag input-icon"></i>
                            <input type="text" name="title" id="edit_title" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Цена (₽)</label>
                        <div class="input-wrapper">
                            <i class="fas fa-ruble-sign input-icon"></i>
                            <input type="number" step="0.01" name="price_rub" id="edit_price_rub" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Категория</label>
                        <div class="input-wrapper">
                            <i class="fas fa-folder input-icon"></i>
                            <input type="text" name="category" id="edit_category" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Бренд</label>
                        <div class="input-wrapper">
                            <i class="fas fa-copyright input-icon"></i>
                            <input type="text" name="brand" id="edit_brand">
                        </div>
                    </div>
                </div>

                <div class="form-group" style="margin-top:0.5rem;">
                    <label>Описание</label>
                    <div class="input-wrapper">
                        <i class="fas fa-align-left input-icon" style="top:14px;"></i>
                        <textarea name="full_desc" id="edit_description" rows="4"></textarea>
                    </div>
                </div>

                <div class="form-grid" style="gap:1.2rem; align-items:end;">
                    <div class="form-group">
                        <label>Количество</label>
                        <div class="input-wrapper">
                            <i class="fas fa-boxes input-icon"></i>
                            <input type="number" name="stock" id="edit_stock" value="-1">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-wrapper">
                            <input type="checkbox" name="in_stock" id="edit_in_stock">
                            <span class="checkmark"></span>
                            В наличии
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Текущие фото</label>
                    <div class="image-preview" id="editCurrentPreview"></div>
                </div>

                <div class="form-group">
                    <label>Добавить новые фото</label>
                    <div class="drop-zone" id="editDropZone">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 1.8rem; margin-bottom: 0.4rem; color:#666;"></i>
                        <p>Перетащите или <span style="color:#00ff9d; text-decoration:underline;">кликните</span></p>
                        <input type="file" name="images[]" multiple accept="image/*" id="editFileInput" style="display:none;">
                    </div>
                    <div class="image-preview" id="editNewPreview"></div>
                </div>

                <div class="modal-actions" style="margin-top:2rem;">
                    <button type="button" class="btn-zaza-primary" id="editSubmitBtn">
                        <i class="fas fa-save"></i> Сохранить изменения
                    </button>
                    <button type="button" onclick="closeModal('editModal')" class="btn-zaza-secondary">
                        Отмена
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Модалка с паролем -->
    <div id="passwordModal" class="modal-overlay" style="display:none;">
        <div class="modal" style="max-width: 460px;">
            <button class="modal-close" onclick="closePasswordModal()">×</button>
            <h3>Подтвердите действие</h3>
            <p style="color:#aaa; text-align:center; margin:1rem 0;">Введите пароль администратора</p>
            <input type="password" id="adminPassword" placeholder="Пароль" autofocus>
            <div id="passwordError" style="color:#ff4444; margin:0.5rem 0; display:none;">Неверный пароль</div>
            <div class="modal-actions">
                <button class="btn-zaza-primary" onclick="executePendingAction()">Подтвердить</button>
                <button type="button" class="btn-zaza-secondary" onclick="closePasswordModal()">Отмена</button>
            </div>
        </div>
    </div>

    <div class="theme-toggle-hanging">
        <input type="checkbox" id="theme-toggle" class="theme-toggle-input">
        <label for="theme-toggle" class="theme-toggle-label">
            <div class="rope top"></div>
            <div class="bulb">
                <div class="bulb-light"></div>
                <div class="bulb-glow"></div>
            </div>
            <div class="rope bottom"></div>
        </label>
    </div>

<script>
'use strict';

let pendingAction = null;

// Всплывающие сообщения
function showFlash(message, type = 'success') {
    const flash = document.createElement('div');
    flash.className = `flash ${type}`;
    flash.textContent = message;
    const container = document.querySelector('.admin-container');
    if (container) {
        container.insertBefore(flash, container.firstChild);
        setTimeout(() => flash.remove(), 5000);
    }
}

// Модальные окна
function closeModal(id) {
    const modal = document.getElementById(id);
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('active');  // ← и эту тоже добавь
    }
    document.body.style.overflow = '';
}

function openPasswordModal() {
    const modal = document.getElementById('passwordModal');
    modal.style.display = 'flex';
    modal.classList.add('active');  // ← ДОБАВЬ ЭТУ СТРОЧКУ
    document.getElementById('adminPassword').focus();
    document.body.style.overflow = 'hidden';
}

function closePasswordModal() {
    const modal = document.getElementById('passwordModal');
    modal.style.display = 'none';
    modal.classList.remove('active');  // ← И ЭТУ
    document.getElementById('adminPassword').value = '';
    document.getElementById('passwordError').style.display = 'none';
    pendingAction = null;
    document.body.style.overflow = '';
}
// Универсальная функция только для add и edit (где есть форма)
function prepareAction(type, form) {
    if (!form) {
        console.error('Форма не передана!');
        return;
    }

    const formData = new FormData();

    if (type === 'add') {
        formData.append('action', 'add');
        formData.append('title', form.querySelector('[name="title"]').value.trim());
        formData.append('price_rub', form.querySelector('[name="price_rub"]').value);
        formData.append('category', form.querySelector('[name="category"]').value.trim());
        formData.append('brand', form.querySelector('[name="brand"]').value.trim());
        formData.append('stock', form.querySelector('[name="stock"]').value || '-1');
        formData.append('in_stock', form.querySelector('[name="in_stock"]').checked ? '1' : '0');
        
        // ВОТ ЭТО ГЛАВНОЕ — БЕРЁМ ИЗ ПЕРЕДАННОЙ ФОРМЫ!
        const desc = form.querySelector('textarea[name="full_desc"]');
formData.append('full_desc', desc?.value?.trim() || '');
console.log('Добавляю описание:', desc?.value);
    }

    if (type === 'edit') {
        formData.append('action', 'edit');
        formData.append('product_id', form.querySelector('#edit_id').value);
        formData.append('title', form.querySelector('#edit_title').value.trim());
        formData.append('price_rub', form.querySelector('#edit_price_rub').value);
        formData.append('category', form.querySelector('#edit_category').value.trim());
        formData.append('brand', form.querySelector('#edit_brand').value.trim());
        formData.append('stock', form.querySelector('#edit_stock').value || '-1');
        formData.append('in_stock', form.querySelector('#edit_in_stock').checked ? '1' : '0');
        formData.append('full_desc', document.getElementById('edit_description').value);

        const keep = Array.from(form.querySelectorAll('#editCurrentPreview img'))
            .map(img => img.dataset.filename)
            .filter(Boolean);
        formData.append('keep_images', JSON.stringify(keep));
    }

    // Файлы — из правильного input
    const fileInput = type === 'add' ? form.querySelector('#addFileInput') : form.querySelector('#editFileInput');
    if (fileInput && fileInput.files.length > 0) {
        for (let file of fileInput.files) {
            formData.append('images[]', file);
        }
    }

    pendingAction = { type, formData };
    openPasswordModal();
}

// НОВАЯ ЧИСТАЯ ФУНКЦИЯ ТОЛЬКО ДЛЯ УДАЛЕНИЯ
function deleteProduct(productId) {
    event.stopPropagation(); // важно!

    pendingAction = {
        type: 'delete',
        productId: productId
    };
    openPasswordModal();
}

async function executePendingAction() {
    const pwd = document.getElementById('adminPassword').value.trim();
    if (!pwd || !pendingAction) return;

    let fd;

    if (pendingAction.type === 'delete') {
        fd = new FormData();
        fd.append('action', 'delete');
        fd.append('product_id', pendingAction.productId);
    } else {
        fd = pendingAction.formData; // ← берём уже готовый
    }

    // Добавляем пароль и ajax в ЛЮБОМ случае
    fd.append('password', pwd);
    fd.append('ajax', '1');

    try {
        const res = await fetch('/admin', { method: 'POST', body: fd });
        const data = await res.json();

        if (data.success) {
            showFlash(data.message || 'Успех!', 'success');
            closePasswordModal();
           setTimeout(() => location.reload(), 1500);
        } else {
            document.getElementById('passwordError').textContent = data.message || 'Ошибка';
            document.getElementById('passwordError').style.display = 'block';
        }
    } catch (e) {
        console.error(e);
        showFlash('Ошибка сети', 'error');
    }
}
// Открытие редактирования
function openEditModal(btn) {
    const d = btn.dataset;
    document.getElementById('edit_id').value = d.id;
    document.getElementById('edit_title').value = d.title;
    document.getElementById('edit_price_rub').value = d.price_rub;
    document.getElementById('edit_category').value = d.category;
    document.getElementById('edit_brand').value = d.brand || '';
    let desc = (d.full_desc || '').replace(/\\n/g, '\n').replace(/&quot;/g, '"');
document.getElementById('edit_description').value = desc;
    document.getElementById('edit_stock').value = d.stock || '-1';
    document.getElementById('edit_in_stock').checked = d.in_stock === '1';

    const prev = document.getElementById('editCurrentPreview');
    prev.innerHTML = '';
    
    let imgs = [];
    try {
        let raw = d.images || '[]';
        raw = raw.replace(/&quot;/g, '"').replace(/\\"/g, '"');
        imgs = JSON.parse(raw);
        console.log('Успешно загружены изображения:', imgs);
    } catch(e) {
        console.error('Ошибка парсинга data-images:', e);
        console.error('d.images содержит:', d.images);
    }

imgs.forEach(f => {
    const div = document.createElement('div');
    div.className = 'image-item sortable';
    div.draggable = true;
    div.innerHTML = `
        <img src="/static/uploads/goods/${f}" data-filename="${f}">
        <button type="button" class="remove-img" onclick="event.stopPropagation(); this.parentNode.remove()">x</button>
        <div class="main-badge">Главная</div>
    `;
    prev.appendChild(div);
});


makeSortable(prev);           // ← ЭТА СТРОЧКА БЫЛА, ОСТАВЬ
updateMainBadge(prev);        // ← ЭТА СТРОЧКА БЫЛА, ОСТАВЬ
makeSortable(document.getElementById('editNewPreview')); // ← ДОБАВЬ ЭТУ!

    document.getElementById('editNewPreview').innerHTML = '';
    
    const modal = document.getElementById('editModal');
    modal.style.display = 'flex';
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

// Drag & Drop
function setupDropZone(zoneId, previewId, inputId) {
    const zone = document.getElementById(zoneId);
    const preview = document.getElementById(previewId);
    const input = document.getElementById(inputId);
    if (!zone || !preview || !input) return;



    const handleFiles = files => {
        [...files].forEach(file => {
            if (!file.type.startsWith('image/')) return;
            const reader = new FileReader();
            reader.onload = e => {
                const item = document.createElement('div');
                item.className = 'image-item sortable';
                item.draggable = true;
                item.innerHTML = `
                    <img src="${e.target.result}">
                    <button type="button" class="remove-img" onclick="event.stopPropagation(); this.parentNode.remove()">x</button>
                    <div class="main-badge">Главная</div>
                `;
                preview.appendChild(item);
                updateMainBadge(preview);
            };
            reader.readAsDataURL(file);
        });
    };

    zone.addEventListener('click', () => input.click());
    zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
    zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
    zone.addEventListener('drop', e => {
        e.preventDefault();
        zone.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    });
    input.addEventListener('change', () => handleFiles(input.files));

    // === DRAG & DROP СОРТИРОВКА ===
    let draggedItem = null;

    preview.addEventListener('dragstart', e => {
        draggedItem = e.target.closest('.image-item');
        if (!draggedItem) return;
        setTimeout(() => draggedItem.style.opacity = '0.5', 0);
    });

    preview.addEventListener('dragend', () => {
        if (draggedItem) {
            draggedItem.style.opacity = '';
            draggedItem = null;
        }
    });

    preview.addEventListener('dragover', e => e.preventDefault());

    preview.addEventListener('drop', e => {
        e.preventDefault();
        const dropTarget = e.target.closest('.image-item');
        if (!dropTarget || !draggedItem || dropTarget === draggedItem) return;

        const allItems = [...preview.querySelectorAll('.image-item')];
        const draggedIdx = allItems.indexOf(draggedItem);
        const targetIdx = allItems.indexOf(dropTarget);

        if (draggedIdx < targetIdx) {
            dropTarget.after(draggedItem);
        } else {
            dropTarget.before(draggedItem);
        }

        updateMainBadge(preview);
    });
}

// Обновляет бейдж "Главная" — только у первой фотки
function updateMainBadge(preview) {
    const items = preview.querySelectorAll('.image-item');
    items.forEach((item, i) => {
        const badge = item.querySelector('.main-badge');
        if (badge) badge.style.display = i === 0 ? 'block' : 'none';
    });
}

// Поиск
window.filterProducts = () => {
    const q = (document.getElementById('searchInput').value || '').toLowerCase();
    document.querySelectorAll('.product-row').forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(q) ? '' : 'none';
    });
};

// Инициализация — САМОЕ ГЛАВНОЕ ИСПРАВЛЕНИЕ
document.addEventListener('DOMContentLoaded', () => {
    console.log('JS загружен и работает!');

    setupDropZone('addDropZone', 'addPreview', 'addFileInput');
    setupDropZone('editDropZone', 'editNewPreview', 'editFileInput');

    // Надёжная привязка кнопок (без optional chaining!)
    const addBtn = document.getElementById('addSubmitBtn');
    const editBtn = document.getElementById('editSubmitBtn');
    const pwdInput = document.getElementById('adminPassword');

if (addBtn) {
    addBtn.addEventListener('click', () => {
        const form = document.getElementById('addForm');
        if (form.checkValidity()) {
            prepareAction('add', form);   // ← ДВА аргумента: тип и форма
        } else {
            form.reportValidity();
        }
    });
}

if (editBtn) {
    editBtn.addEventListener('click', () => {
        const form = document.getElementById('editForm');
        if (form.checkValidity()) {
            prepareAction('edit', form);  // ← ДВА аргумента
        } else {
            form.reportValidity();
        }
    });
}

    if (pwdInput) {
        pwdInput.addEventListener('keypress', e => {
            if (e.key === 'Enter') executePendingAction();
        });
    }
  // === ЗАМЕНИ ВЕСЬ ЭТОТ БЛОК (от document.querySelectorAll('.product-row').forEach... до конца функции) ===
document.querySelectorAll('.product-row').forEach(row => {
    row.style.cursor = 'pointer';
    row.addEventListener('click', function(e) {
        if (e.target.closest('.action-btn')) return;

        const editBtn = this.querySelector('.action-btn.edit');
        if (!editBtn) return;
        const d = editBtn.dataset;

        // Заполняем текст
        document.getElementById('detailTitle').textContent = d.title || '—';
        document.getElementById('detailPrice').textContent = parseFloat(d.price_rub || 0).toLocaleString('ru-RU') + ' ₽';
        document.getElementById('detailCategory').textContent = 'Категория: ' + (d.category || '—');
        document.getElementById('detailBrand').textContent = 'Бренд: ' + (d.brand || '—');
        document.getElementById('detailStock').innerHTML = `
            <strong>Наличие:</strong> 
            ${d.stock == -1 ? 'Бесконечно' : d.stock + ' шт.'}
            <span style="color:${d.in_stock === '1' ? '#0f830f' : '#e02848'}; margin-left:10px; font-weight:600;">
                ${d.in_stock === '1' ? 'В наличии' : 'Нет в наличии'}
            </span>
        `;
        let rawDesc = d.full_desc || '';
let displayDesc = rawDesc 
    ? rawDesc.replace(/\\n/g, '\n').replace(/&quot;/g, '"') 
    : 'Нет описания';

document.getElementById('detailDesc').innerHTML = displayDesc.replace(/\n/g, '<br>');

        // ГАЛЕРЕЯ — ТОЧНО КАК В УСЛУГАХ (inline-стили!)
        const imagesDiv = document.getElementById('detailImages');
        imagesDiv.innerHTML = '';

        let images = [];
        try { images = JSON.parse(d.images || '[]'); } catch(e) { images = []; }

        if (images.length === 0) {
            imagesDiv.innerHTML = '<div style="width:320px;height:320px;background:#222;border-radius:16px;display:flex;align-items:center;justify-content:center;color:#666;font-size:1.1rem;">Нет фото</div>';
        } else {
            const wrapper = document.createElement('div');
            wrapper.style.cssText = 'position:relative;width:100%;max-width:480px;aspect-ratio:1;background:#000;border-radius:20px;overflow:hidden;border:2px solid #333;box-shadow:0 20px 60px rgba(0,0,0,0.6);';

            const mainImg = document.createElement('img');
            mainImg.src = '/static/uploads/goods/' + images[0];
            mainImg.style.cssText = 'width:100%;height:100%;object-fit:contain;';
            mainImg.onerror = () => mainImg.src = '/static/assets/no-image.png';
            wrapper.appendChild(mainImg);

            if (images.length > 1) {
                const thumbs = document.createElement('div');
                thumbs.style.cssText = 'position:absolute;bottom:0;left:0;right:0;padding:16px 12px;background:linear-gradient(transparent,rgba(0,0,0,0.85));display:flex;gap:8px;justify-content:center;';

                images.slice(0, 6).forEach((url, i) => {
                    const thumb = document.createElement('div');
                    thumb.style.cssText = `width:40px;height:40px;border-radius:10px;background:url(/static/uploads/goods/${url}) center/cover no-repeat;border:2px solid ${i===0?'#00ff9d':'transparent'};cursor:pointer;transition:all .3s;`;
                    thumb.onclick = (e) => {
                        e.stopPropagation();
                        mainImg.src = '/static/uploads/goods/' + url;
                        thumbs.querySelectorAll('div').forEach((t, j) => {
                            t.style.borderColor = j === i ? '#00ff9d' : 'transparent';
                        });
                    };
                    thumbs.appendChild(thumb);
                });

                if (images.length > 6) {
                    const more = document.createElement('div');
                    more.textContent = `+${images.length - 6}`;
                    more.style.cssText = 'width:40px;height:40px;border-radius:10px;background:rgba(255,255,255,0.15);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:600;cursor:pointer;';
                    more.onclick = (e) => {
                        e.stopPropagation();
                        openFullscreenGallery(images.map(f => '/static/uploads/goods/' + f));
                    };
                    thumbs.appendChild(more);
                }

                wrapper.appendChild(thumbs);
            }

            imagesDiv.appendChild(wrapper);
        }

        // Активация
        document.querySelectorAll('.product-row').forEach(r => r.classList.remove('active'));
        this.classList.add('active');
        document.getElementById('productDetail').classList.add('active');
        document.body.style.overflow = 'hidden';
    });
});
function openFullscreenGallery(images, start = 0) {
    const existing = document.getElementById('fullscreenGallery');
    if (existing) existing.remove();

    const overlay = document.createElement('div');
    overlay.id = 'fullscreenGallery';
    overlay.style.cssText = `position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.98);z-index:9999;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .4s;cursor:zoom-out;`;

    const mainImg = document.createElement('img');
    mainImg.src = images[start];
    mainImg.style.cssText = `max-width:94%;max-height:94vh;object-fit:contain;border-radius:16px;box-shadow:0 30px 80px rgba(0,0,0,0.9);transition:opacity .3s ease;`;
    mainImg.onerror = () => mainImg.src = '/static/assets/no-image.png';

    overlay.innerHTML = `
        <button style="position:absolute;top:20px;right:20px;background:none;border:none;color:white;font-size:3.5rem;cursor:pointer;z-index:10;opacity:0.8;" onclick="closeFullscreenGallery()">×</button>
        <button id="prevBtn" style="position:absolute;left:30px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.15);border:none;color:white;font-size:4rem;padding:20px 15px;border-radius:50%;cursor:pointer;backdrop-filter:blur(10px);">‹</button>
        <button id="nextBtn" style="position:absolute;right:30px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.15);border:none;color:white;font-size:4rem;padding:20px 15px;border-radius:50%;cursor:pointer;backdrop-filter:blur(10px);">›</button>
    `;
    overlay.appendChild(mainImg);
    document.body.appendChild(overlay);
    setTimeout(() => overlay.style.opacity = '1', 10);

    let current = start;
    const show = () => {
        mainImg.style.opacity = '0';
        setTimeout(() => {
            mainImg.src = images[current];
            mainImg.style.opacity = '1';
        }, 200);
    };

    overlay.querySelector('#prevBtn')?.addEventListener('click', e => { e.stopPropagation(); current = (current - 1 + images.length) % images.length; show(); });
    overlay.querySelector('#nextBtn')?.addEventListener('click', e => { e.stopPropagation(); current = (current + 1) % images.length; show(); });
    overlay.onclick = e => { if (e.target === overlay) closeFullscreenGallery(); };

    document.addEventListener('keydown', function esc(e) {
        if (e.key === 'Escape') closeFullscreenGallery();
        if (e.key === 'ArrowLeft') { current = (current - 1 + images.length) % images.length; show(); }
        if (e.key === 'ArrowRight') { current = (current + 1) % images.length; show(); }
    });

    window.closeFullscreenGallery = () => {
        overlay.style.opacity = '0';
        setTimeout(() => {
            overlay.remove();
            document.removeEventListener('keydown', esc);
        }, 400);
    };
}

    // Закрытие по клику вне карточки
    document.addEventListener('click', e => {
        const detail = document.getElementById('productDetail');
        if (!detail?.classList.contains('active')) return;
        if (e.target === detail || e.target.closest('.detail-close')) {
            detail.classList.remove('active');
            document.body.style.overflow = '';
            document.querySelectorAll('.product-row').forEach(r => r.classList.remove('active'));
        }
    });

    // Закрытие по Escape
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
            const detail = document.getElementById('productDetail');
            if (detail?.classList.contains('active')) {
                detail.classList.remove('active');
                document.body.style.overflow = '';
            }
        }
    });

    // Редактировать прямо из карточки
    window.editFromDetail = function() {
        const activeRow = document.querySelector('.product-row.active');
        if (activeRow) {
            activeRow.querySelector('.action-btn.edit').click();
            document.getElementById('productDetail').classList.remove('active');
            document.body.style.overflow = '';
        }
    };
});
function makeSortable(preview) {
    let dragged = null;
    preview.addEventListener('dragstart', e => {
        dragged = e.target.closest('.image-item');
        if (dragged) setTimeout(() => dragged.style.opacity = '0.4', 0);
    });
    preview.addEventListener('dragend', () => { if (dragged) dragged.style.opacity = ''; });
    preview.addEventListener('dragover', e => e.preventDefault());
    preview.addEventListener('drop', e => {
        e.preventDefault();
        const target = e.target.closest('.image-item');
        if (!target || !dragged || target === dragged) return;
        if (dragged.nextSibling === target) target.after(dragged);
        else target.before(dragged);
        updateMainBadge(preview);
    });
}

function updateMainBadge(preview) {
    preview.querySelectorAll('.image-item').forEach((el, i) => {
        const badge = el.querySelector('.main-badge');
        if (badge) badge.style.display = i === 0 ? 'block' : 'none';
    });
}
</script>
<script>
// ──────────────────────── ТУМБЛЕР ТЕМЫ — РАБОТАЕТ НА 100% ────────────────────────
const themeToggle = document.getElementById('theme-toggle');
const htmlEl = document.documentElement; // <html>

// Читаем сохранённую тему (если есть)
const savedTheme = localStorage.getItem('theme');
if (savedTheme) {
    htmlEl.setAttribute('data-theme', savedTheme);
    themeToggle.checked = (savedTheme === 'light');
}

// Основной обработчик
themeToggle.addEventListener('change', () => {
    if (themeToggle.checked) {
        htmlEl.setAttribute('data-theme', 'light');
        localStorage.setItem('theme', 'light');
    } else {
        htmlEl.setAttribute('data-theme', 'dark');
        localStorage.setItem('theme', 'dark');
    }
});
</script>
<script>
// === ЗАКРЫТИЕ КАРТОЧКИ ТОВАРА КЛИКОМ ВНЕ НЕЁ ===
// Работает в светлой и тёмной теме, без багов
document.addEventListener('click', function(e) {
    const detail = document.querySelector('.product-detail.active');
    if (!detail) return;

    // Если клик был НЕ по карточке и НЕ по строке товара в таблице
    const clickedInsideDetail = detail.contains(e.target);
    const clickedOnRow = e.target.closest('.product-row');

    if (!clickedInsideDetail && !clickedOnRow) {
        detail.classList.remove('active');
        document.body.style.overflow = ''; // возвращаем скролл страницы
    }
});

// Дополнительно: закрытие по клавише Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const detail = document.querySelector('.product-detail.active');
        if (detail) {
            detail.classList.remove('active');
            document.body.style.overflow = '';
        }
    }
});
</script>
<script>
// === БЕЗОПАСНОЕ ЗАКРЫТИЕ МОДАЛОК ТОЛЬКО ПРИ КЛИКЕ ПО ОВЕРЛЕЮ ===
document.addEventListener('click', function(e) {
    const overlay = e.target.closest('.modal-overlay');
    if (!overlay) return;

    const modal = overlay.querySelector('.modal');
    const clickedInside = modal && modal.contains(e.target);

    if (!clickedInside && overlay.classList.contains('active')) {
        overlay.style.display = 'none';
        overlay.classList.remove('active');
        document.body.style.overflow = '';
    }
});
</script>

<!-- Карточка товара — как в услугах -->

<div class="product-detail" id="productDetail">
    <button class="detail-close" onclick="closeProductDetail()">x</button>
    <div class="detail-grid">
        <div class="detail-images" id="detailImages"></div>
        <div class="detail-info">
            <h3 id="detailTitle"></h3>
            <div class="detail-price" id="detailPrice"></div>
            <div id="detailCategory" style="color:#aaa; margin:0.5rem 0;"></div>
            <div id="detailBrand" style="color:#aaa; margin:0.5rem 0;"></div>
            <div id="detailStock" style="margin:0.8rem 0; font-size:1.1rem;"></div>
            <div class="detail-desc" id="detailDesc"></div>

        </div>
    </div>
</div>
</body>
</html>