<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Услуги — Админка | Piligrim</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/admin/admin_reviews.css">
    <link rel="stylesheet" href="/static/css/admin/admin_goods.css">

    <style>
@import url('/static/css/fonts/inter.css');
</style>
</head>
<body>

    <header>
        <a href="/" class="logo"><img src="/static/assets/logo.png" alt="ZAZA" class="logo-img"></a>
        <nav style="margin-left: auto;"><a href="/" class="nav-link">Главная</a></nav>
    </header>

    <aside class="sidebar">
        <h3 class="sidebar-title">Админка</h3>
        <div class="sidebar-menu">
            <a href="/admin" class="sidebar-item"><i class="fas fa-box"></i><span>Товары</span></a>
            <a href="/admin_services" class="sidebar-item active"><i class="fas fa-balance-scale"></i><span>Услуги</span></a>
            <a href="/admin_news" class="sidebar-item"><i class="fas fa-newspaper"></i><span>Новости</span></a>
            <a href="/carousel-editor" class="sidebar-item"><i class="fas fa-images"></i><span>Редактор баннеров</span></a>
             <a href="/admin_dispatch" class="sidebar-item"><i class="fas fa-paper-plane"></i><span>Рассылки</span></a>
            <a href="/admin_feedback" class="sidebar-item"><i class="fas fa-envelope"></i><span>Обратная связь<div class="sidebar-badge">{{ total_feedback }}</div></span></a>
            <a href="/admin_users" class="sidebar-item"><i class="fas fa-users"></i><span>Пользователи<div class="sidebar-badge">{{ total_users }}</div></span></a>
            <a href="/admin_reviews" class="sidebar-item"><i class="fas fa-star"></i><span>Отзывы<div class="sidebar-badge">{{ total_reviews | e }}</div></span></a>
            <a href="/admin_orders" class="sidebar-item"><i class="fas fa-shopping-cart"></i><span>Заказы<div class="sidebar-badge">{{ total_orders | e }}</div></span></a>
        </div>
    </aside>




    <main class="main-content">
        <div class="admin-container">
            <h1 class="section-title">Услуги</h1>

            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                {% for category, message in messages %}
                  <div class="flash {{ 'success' if category != 'error' else 'error' }}">{{ message | safe }}</div>
                {% endfor %}
              {% endif %}
            {% endwith %}

            <!-- Форма добавления -->
            <div class="add-form-wrapper" id="addFormWrapper">
                <div class="add-form-header" onclick="document.getElementById('addFormWrapper').classList.toggle('collapsed')">
                    <h3>Добавить новую услугу</h3>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="add-form-body">
                    <form id="addForm">
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 1.2rem;">
                            <div class="form-group">
                                <label>Название <span style="color:#ff4444;">*</span></label>
                                <div class="input-wrapper"><i class="fas fa-tag input-icon"></i>
                                    <input type="text" name="title" placeholder="Развод под ключ" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Цена <span style="color:#ff4444;">*</span></label>
                                <div class="input-wrapper"><i class="fas fa-ruble-sign input-icon"></i>
                                    <input type="text" name="price" id="add_price" placeholder="150 000" required oninput="formatPrice(this)">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Краткое описание <span style="color:#ff4444;">*</span></label>
                                <div class="input-wrapper"><i class="fas fa-align-left input-icon" style="top:14px;"></i>
                                    <textarea name="short_desc" rows="2" placeholder="Быстро, без суда" required></textarea>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Категория</label>
                                <div class="input-wrapper"><i class="fas fa-folder input-icon"></i>
                                    <input type="text" name="category" placeholder="Юридические услуги">
                                </div>
                            </div>
                        </div>

                        <div class="form-group" style="margin-top:1rem;">
                            <label>Полное описание</label>
                            <div class="input-wrapper"><i class="fas fa-align-left input-icon" style="top:14px;"></i>
                                <textarea name="full_desc" rows="6" placeholder="Подробное описание услуги..."></textarea>
                            </div>
                        </div>

                        <div class="form-group" style="margin-top:1rem;">
                            <label>Фото услуги (макс. 4)</label>
                            <div class="drop-zone" id="addDropZone">
                                <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; margin-bottom: 0.5rem; color:#666;"></i>
                                <p>Перетащите фото сюда или <span style="color:#00ff9d; text-decoration:underline;">кликните</span></p>
                                <input type="file" name="images" multiple accept="image/*" id="addFileInput" style="display:none;">
                            </div>
                            <div class="image-preview" id="addPreview"></div>
                        </div>

                        <div style="margin-top: 1rem;">
                            <button type="submit" class="btn-zaza-primary">
                                <i class="fas fa-plus-circle"></i> Добавить услугу
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Поиск по названию, описанию, категории..." onkeyup="filterProducts()">
            </div>

            <div class="card">
                {% if services|length == 0 %}
                <div class="no-products"><i class="fas fa-balance-scale"></i><p style="font-size:1.6rem;">Услуг пока нет</p></div>
                {% else %}
                <table class="products-table">
        <thead>
            <tr>
                <th>Фото</th>
                <th>Название</th>
                <th>Цена</th>
                <th>Краткое описание</th>
                <th>Категория</th>
                <th style="width:140px;">Действия</th>
            </tr>
        </thead>
<tbody id="productsTableBody">
    {% for s in services %}
    <tr class="product-row" data-id="{{ s.id }}" draggable="true">
        <td>
            {% if s.image_urls | length > 0 %}
                <img src="{{ s.image_urls[0] }}" style="width:56px;height:56px;object-fit:cover;border-radius:10px;display:block;" onerror="this.src='/static/assets/no-image.png'">
            {% else %}
                <div style="width:56px;height:56px;background:#222;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#555;font-size:0.7rem;">—</div>
            {% endif %}
        </td>
        <td>
            <div style="font-weight:600;">{{ s.title }}</div>
            {% if s.full_desc %}
            <div style="font-size:0.85rem;color:#999;margin-top:0.3rem;max-width:360px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
                {{ s.full_desc[:70] }}{% if s.full_desc|length > 70 %}...{% endif %}
            </div>
            {% endif %}
        </td>
        <td class="price-cell">{{ s.price }}</td>
        <td>{{ s.short_desc }}</td>
        <td>{{ s.category or '—' }}</td>
        <td>
            <div class="action-buttons">
                <button class="action-btn edit" onclick="event.stopPropagation(); openEditModal(this)"
                    data-id="{{ s.id }}"
                    data-title="{{ s.title|e|replace('"', '&quot;') }}"
                    data-price="{{ s.price|e|replace('"', '&quot;') }}"
                    data-short_desc="{{ s.short_desc|e|replace('"', '&quot;') }}"
                    data-full_desc="{{ s.full_desc|e|replace('"', '&quot;') }}"
                    data-category="{{ (s.category or '')|e|replace('"', '&quot;') }}"
                    data-images='{{ (s.image_urls or []) | tojson }}'>
                    <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn delete" onclick="event.stopPropagation(); prepareAction('delete', {{ s.id }})">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>

            <div class="hidden-images-data" style="display:none;" data-images="{{ ([] if not s.image_urls or s.image_urls == '[' or s.image_urls == '' else s.image_urls) | tojson | safe }}"></div>
        </td>
    </tr>
    {% endfor %}
</tbody>
    </table>
                <div class="pagination" id="pagination"></div>
                {% endif %}
            </div>
        </div>
    </main>

    <!-- Карточка услуги -->
    <div class="product-detail" id="productDetail">
        <button class="detail-close" onclick="closeProductDetail()">×</button>
        <div class="detail-grid">
            <div class="detail-images" id="detailImages"></div>
            <div class="detail-info">
                <h3 id="detailTitle"></h3>
                <div class="detail-price" id="detailPrice"></div>
                <div id="detailCategory" style="color:#aaa; margin:0.5rem 0;"></div>
                <div class="detail-desc" id="detailShortDesc" style="margin-bottom:1rem;"></div>
                <div class="detail-desc" id="detailFullDesc"></div>
            </div>
        </div>
    </div>

    <!-- Модалка редактирования -->
    <div id="editModal" class="modal-overlay">
        <div class="modal">
            <button class="modal-close" onclick="closeModal('editModal')">×</button>
            <h3><i class="fas fa-edit" style="margin-right:10px; color:#00ff9d;"></i> Редактировать услугу</h3>
            
            <form id="editForm">
                <input type="hidden" name="product_id" id="edit_id">

                <div class="form-grid" style="gap:1.2rem;">
                    <div class="form-group">
                        <label>Название</label>
                        <div class="input-wrapper"><i class="fas fa-tag input-icon"></i>
                            <input type="text" name="title" id="edit_title" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Цена</label>
                        <div class="input-wrapper"><i class="fas fa-ruble-sign input-icon"></i>
                            <input type="text" name="price" id="edit_price" required oninput="formatPrice(this)">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Краткое описание</label>
                        <div class="input-wrapper"><i class="fas fa-align-left input-icon" style="top:14px;"></i>
                            <textarea name="short_desc" id="edit_short_desc" rows="3" required></textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Категория</label>
                        <div class="input-wrapper"><i class="fas fa-folder input-icon"></i>
                            <input type="text" name="category" id="edit_category">
                        </div>
                    </div>
                </div>

                <div class="form-group" style="margin-top:0.5rem;">
                    <label>Полное описание</label>
                    <div class="input-wrapper"><i class="fas fa-align-left input-icon" style="top:14px;"></i>
                        <textarea name="full_desc" id="edit_full_desc" rows="6"></textarea>
                    </div>
                </div>

                <div class="form-group">
                    <label>Текущие фото</label>
                    <div class="image-preview" id="editCurrentPreview"></div>
                </div>

                <div class="form-group">
                    <label>Добавить новые фото</label>
                    <div class="drop-zone" id="editDropZone">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 1.8rem; margin-bottom: 0.4rem; color:#666;"></i>
                        <p>Перетащите или <span style="color:#00ff9d; text-decoration:underline;">кликните</span></p>
                        <input type="file" name="images" multiple accept="image/*" id="editFileInput" style="display:none;">
                    </div>
                    <div class="image-preview" id="editNewPreview"></div>
                </div>

                <div class="modal-actions" style="margin-top:2rem;">
                    <button type="button" onclick="prepareAction('edit')" class="btn-zaza-primary">
                        <i class="fas fa-save"></i> Сохранить изменения
                    </button>
                    <button type="button" onclick="closeModal('editModal')" class="btn-zaza-secondary">
                        Отмена
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Модалка пароля -->
    <div id="passwordModal" class="modal-overlay">
        <div class="modal" style="max-width: 460px;">
            <button class="modal-close" onclick="closeModal('passwordModal')">×</button>
            <h3>Подтвердите действие</h3>
            <p style="color:#aaa; text-align:center; margin:1rem 0;">Введите пароль администратора</p>
            <input type="password" id="adminPassword" placeholder="Пароль" autofocus style="width:100%; padding:1rem; font-size:1rem;">
            <div id="passwordError">Неверный пароль</div>
            <div class="modal-actions">
                <button class="btn-primary" onclick="executePendingAction()">Подтвердить</button>
                <button class="cancel-btn" onclick="closeModal('passwordModal')">Отмена</button>
            </div>
        </div>
    </div>

    <div class="theme-toggle-hanging">
        <input type="checkbox" id="theme-toggle" class="theme-toggle-input">
        <label for="theme-toggle" class="theme-toggle-label">
            <div class="rope top"></div>
            <div class="bulb"><div class="bulb-light"></div><div class="bulb-glow"></div></div>
            <div class="rope bottom"></div>
        </label>
    </div>

<script>
fetch('/api/check_admin').then(r => r.json()).then(d => { if (!d.is_admin) location.href = '/404'; });

        let pendingAction = null;
        let pendingFormData = null;

        function showAlert(message, type = 'success') {
            document.querySelectorAll('.zaza-toast').forEach(t => t.remove());
            const toast = document.createElement('div');
            toast.className = `zaza-toast ${type}`;
            toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'}"></i><span>${message}</span>
                <button class="close" onclick="this.parentElement.remove()">×</button>`;
            document.body.appendChild(toast);
            setTimeout(() => toast.style.opacity = '1', 100);
            setTimeout(() => toast.remove(), 5000);
        }

        function validateForm(form) {
            let ok = true;
            form.querySelectorAll('.input-wrapper.error').forEach(el => el.classList.remove('error'));
            form.querySelectorAll('.field-error').forEach(el => el.remove());

            ['title', 'price', 'short_desc'].forEach(name => {
                const field = form.querySelector(`[name="${name}"]`);
                if (!field) return;
                let val = field.value.trim();
                if (name === 'price') val = val.replace(/\s/g, '');

                if (!val || (name === 'price' && (isNaN(val) || +val <= 0))) {
                    ok = false;
                    const wrapper = field.closest('.input-wrapper');
                    wrapper.classList.add('error');
                    const err = document.createElement('div');
                    err.className = 'field-error';
                    err.textContent = name === 'price' ? 'Введите корректную цену' : 'Обязательное поле';
                    wrapper.parentNode.appendChild(err);
                }
            });

            if (!ok) showAlert('Заполните обязательные поля', 'error');
            return ok;
        }

        function formatPrice(input) {
            let v = input.value.replace(/\D/g, '');
            v = v.replace(/\B(?=(\d{3})+(?!\d))/g, " ");
            input.value = v;
        }

        const MAX_PHOTOS = 4;

        // ГЛОБАЛЬНЫЕ ХРАНИЛИЩА ФАЙЛОВ (ЭТО РЕШЕНИЕ ВСЕХ ПРОБЛЕМ)
        const fileStorage = {
            add: [],
            edit: []
        };

        function initPhotoUploader(dropZoneId, fileInputId, previewId, storageKey) {
            const dropZone = document.getElementById(dropZoneId);
            const fileInput = document.getElementById(fileInputId);
            const preview = document.getElementById(previewId);

            dropZone.addEventListener('click', () => fileInput.click());

            ['dragover', 'dragenter'].forEach(evt => dropZone.addEventListener(evt, e => { e.preventDefault(); dropZone.classList.add('dragover'); }));
            ['dragleave', 'drop'].forEach(evt => dropZone.addEventListener(evt, e => { e.preventDefault(); dropZone.classList.remove('dragover'); }));

            dropZone.addEventListener('drop', e => handleFiles(e.dataTransfer.files));
            fileInput.addEventListener('change', e => handleFiles(e.target.files));

            function handleFiles(fileList) {
                const newFiles = Array.from(fileList).filter(f => f.type.startsWith('image/'));
                if (!newFiles.length) return;

                // Берём текущие из хранилища + новые
                const current = fileStorage[storageKey];
                const all = [...current, ...newFiles];

                // Убираем дубли
                const unique = new Map();
                all.forEach(f => {
                    const key = `${f.name}_${f.size}_${f.lastModified}`;
                    if (!unique.has(key)) unique.set(key, f);
                });

                const final = Array.from(unique.values()).slice(0, MAX_PHOTOS);
                fileStorage[storageKey] = final;

                // Обновляем input (важно!)
                const dt = new DataTransfer();
                final.forEach(f => dt.items.add(f));
                fileInput.files = dt.files;

                render(final);

                if (final.length === MAX_PHOTOS) {
                    showAlert('Максимум 4 фото', 'info');
                }
            }

            function render(files) {
                preview.innerHTML = '';
                files.forEach((file, i) => {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const div = document.createElement('div');
                        div.className = 'image-item';
                        div.draggable = true;
                        div.dataset.index = i;
                        div.innerHTML = `
                            <img src="${e.target.result}" style="width:80px;height:80px;object-fit:cover;border-radius:12px;">
                            ${i === 0 ? '<div class="main-badge">Главная</div>' : ''}
                            <button type="button" class="image-remove" onclick="removeFile(${i}, '${storageKey}')">×</button>
                        `;
                        preview.appendChild(div);
                    };
                    reader.readAsDataURL(file);
                });
            }

            window.removeFile = function(index, key) {
                fileStorage[key].splice(index, 1);
                const dt = new DataTransfer();
                fileStorage[key].forEach(f => dt.items.add(f));
                fileInput.files = dt.files;
                render(fileStorage[key]);
            };

            // Перетаскивание порядка
            preview.addEventListener('dragstart', e => {
                const item = e.target.closest('.image-item');
                if (item) {
                    item.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', item.dataset.index);
                }
            });

            preview.addEventListener('dragover', e => e.preventDefault());
            preview.addEventListener('drop', e => {
                e.preventDefault();
                const from = Number(e.dataTransfer.getData('text/plain'));
                const toItem = e.target.closest('.image-item');
                if (!toItem) return;
                const to = Number(toItem.dataset.index);
                if (from === to) return;

                const [moved] = fileStorage[storageKey].splice(from, 1);
                fileStorage[storageKey].splice(to, 0, moved);

                const dt = new DataTransfer();
                fileStorage[storageKey].forEach(f => dt.items.add(f));
                fileInput.files = dt.files;

                render(fileStorage[storageKey]);
                showAlert('Порядок изменён', 'success');
            });

            preview.addEventListener('dragend', () => preview.querySelectorAll('.image-item').forEach(el => el.classList.remove('dragging')));
        }

        // Инициализация
        initPhotoUploader('addDropZone', 'addFileInput', 'addPreview', 'add');

// ← ВАЖНО: инициализируем и для редактирования!
initPhotoUploader('editDropZone', 'editFileInput', 'editNewPreview', 'edit');


function loadExistingImagesIntoPreview(imagesArray, previewId) {
    const preview = document.getElementById(previewId);
    if (!preview || !Array.isArray(imagesArray) || imagesArray.length === 0) return;

    preview.innerHTML = '';

    imagesArray.forEach((url, i) => {
        const div = document.createElement('div');
        div.className = 'image-item';
        div.innerHTML = `
            <img src="${url}" 
                 style="width:80px;height:80px;object-fit:cover;border-radius:12px;border:2px solid #333;"
                 onerror="this.src='/static/assets/no-image.png'">
            ${i === 0 ? '<div class="main-badge">Главная</div>' : ''}
            <input type="hidden" name="keep_images" value="${url}">
            <button type="button" class="image-remove" onclick="this.parentElement.remove()">×</button>
        `;
        preview.appendChild(div);
    });
}

        // Остальной код (формы, модалки и т.д.) — оставь как есть
        document.getElementById('addForm').onsubmit = function(e) {
            e.preventDefault();
            if (!validateForm(this)) return;

            const priceInput = this.querySelector('[name="price"]');
            priceInput.value = priceInput.value.replace(/\s/g, '');

            pendingAction = 'add';
            pendingFormData = new FormData();

            pendingFormData.append('action', 'add');
            pendingFormData.append('title', this.querySelector('[name="title"]').value.trim());
            pendingFormData.append('price', priceInput.value);
            pendingFormData.append('short_desc', this.querySelector('[name="short_desc"]').value.trim());
            pendingFormData.append('full_desc', this.querySelector('[name="full_desc"]').value);
            pendingFormData.append('category', this.querySelector('[name="category"]').value.trim());

            fileStorage.add.forEach(file => pendingFormData.append('images', file));

            document.getElementById('passwordModal').classList.add('active');
            document.getElementById('adminPassword').focus();
        };
        document.querySelector('#editModal .btn-zaza-primary').onclick = function() {
            const form = document.getElementById('editForm');
            if (!validateForm(form)) return;
            form.querySelector('[name="price"]').value = form.querySelector('[name="price"]').value.replace(/\s/g, '');

            pendingAction = 'edit';
            pendingFormData = new FormData();
            pendingFormData.append('action', 'edit');
            pendingFormData.append('product_id', document.getElementById('edit_id').value);
            pendingFormData.append('title', document.getElementById('edit_title').value.trim());
            pendingFormData.append('price', form.querySelector('[name="price"]').value);
            pendingFormData.append('short_desc', document.getElementById('edit_short_desc').value.trim());
            pendingFormData.append('full_desc', document.getElementById('edit_full_desc').value);
            pendingFormData.append('category', document.getElementById('edit_category').value.trim());

            document.querySelectorAll('#editCurrentPreview input[name="keep_images"]').forEach(i => pendingFormData.append('keep_images', i.value));
            for (let file of document.getElementById('editFileInput').files) pendingFormData.append('images', file);

            document.getElementById('passwordModal').classList.add('active');
            document.getElementById('adminPassword').focus();
        };

        function prepareAction(action, serviceId = null) {
            pendingAction = action;
            pendingFormData = new FormData();
            if (action === 'delete') {
                pendingFormData.append('action', 'delete');
                pendingFormData.append('product_id', serviceId);
            }
            document.getElementById('passwordModal').classList.add('active');
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminPassword').focus();
            document.getElementById('passwordError').style.display = 'none';
        }

        async function executePendingAction() {
            const password = document.getElementById('adminPassword').value.trim();
            if (!password) return;

            const fd = new FormData();
            for (let [k, v] of pendingFormData.entries()) if (k !== 'password') fd.append(k, v);
            fd.append('password', password);

            try {
                const resp = await fetch('/admin_services', { method: 'POST', body: fd });
                const html = await resp.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const errorFlash = doc.querySelector('.flash.error');

                if (errorFlash && errorFlash.textContent.includes('Неверный пароль')) {
                    document.getElementById('passwordError').style.display = 'block';
                    document.getElementById('adminPassword').value = '';
                    showAlert('Неверный пароль', 'error');
                } else {
                    const msg = pendingAction === 'add' ? 'Услуга добавлена!' :
                                pendingAction === 'edit' ? 'Услуга обновлена!' : 'Услуга удалена!';
                    showAlert(msg, 'success');
                    closeModal('passwordModal');
                    setTimeout(() => location.reload(), 1300);
                }
            } catch (err) {
                showAlert('Нет связи с сервером', 'error');
            }
        }

function openEditModal(btn) {
    const d = btn.dataset;

    document.getElementById('edit_id').value = d.id;
    document.getElementById('edit_title').value = (d.title || '').replace(/&quot;/g, '"');
    document.getElementById('edit_price').value = (d.price || '').replace(/&quot;/g, '"');
    document.getElementById('edit_short_desc').value = (d.short_desc || '').replace(/&quot;/g, '"');
    document.getElementById('edit_full_desc').value = (d.full_desc || '').replace(/&quot;/g, '"');
    document.getElementById('edit_category').value = (d.category || '').replace(/&quot;/g, '"');

    // Очищаем превью
    document.getElementById('editCurrentPreview').innerHTML = '';
    document.getElementById('editNewPreview').innerHTML = '';
    fileStorage.edit = [];

    // ← БЕЗОПАСНЫЙ ПАРСИНГ
    let images = [];
    try {
        const raw = d.images || '[]';
        images = JSON.parse(raw);
        if (!Array.isArray(images)) images = [];
    } catch (e) {
        console.error('Ошибка парсинга изображений в openEditModal:', e);
        images = [];
    }

    loadExistingImagesIntoPreview(images, 'editCurrentPreview');
    document.getElementById('editModal').classList.add('active');
}

        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        document.addEventListener('click', e => {
            const detail = document.getElementById('productDetail');
            if (detail.classList.contains('active') && !e.target.closest('.product-detail > .detail-grid') && !e.target.closest('.product-row')) closeProductDetail();
            ['editModal', 'passwordModal'].forEach(id => {
                const modal = document.getElementById(id);
                if (modal.classList.contains('active') && !e.target.closest('.modal')) closeModal(id);
            });
        });

        function closeProductDetail() {
            document.getElementById('productDetail')?.classList.remove('active');
            document.querySelectorAll('.product-row').forEach(r => r.classList.remove('active'));
        }

// ← УДАЛИ СТАРЫЙ ОБРАБОТЧИК И ЭТУ ФУНКЦИЮ, ВСТАВЬ ВМЕСТО НИХ ЭТО:

document.addEventListener('click', function(e) {
    const row = e.target.closest('.product-row');
    if (!row) return;

    // Если клик по кнопкам действия — не открывать карточку
    if (e.target.closest('.action-btn')) return;

    showProductDetail(row);
});

function showProductDetail(row) {
    if (!row || !row.dataset?.id) return;

    // Получаем данные из data-атрибутов кнопки редактирования (там всё уже есть и безопасно)
    const editBtn = row.querySelector('.action-btn.edit');
    if (!editBtn) return;

    const d = editBtn.dataset;

    document.getElementById('detailTitle').textContent = d.title || '—';
    document.getElementById('detailPrice').textContent = d.price || '—';
    document.getElementById('detailCategory').textContent = 'Категория: ' + (d.category || '—');
    document.getElementById('detailShortDesc').textContent = d.short_desc || '—';
    document.getElementById('detailFullDesc').textContent = (d.full_desc || 'Нет подробного описания').replace(/&quot;/g, '"');

    // === ГАЛЕРЕЯ ===
    const imagesDiv = document.getElementById('detailImages');
    imagesDiv.innerHTML = '';

    let images = [];
    try {
        const raw = editBtn.dataset.images || '[]';
        images = JSON.parse(raw);
        if (!Array.isArray(images)) images = [];
    } catch (e) {
        console.error('Ошибка парсинга изображений:', e);
        images = [];
    }

    if (images.length === 0) {
        imagesDiv.innerHTML = '<div style="width:320px;height:320px;background:#222;border-radius:16px;display:flex;align-items:center;justify-content:center;color:#666;font-size:1.1rem;">Нет фото</div>';
    } else {
        const wrapper = document.createElement('div');
        wrapper.style.cssText = 'position:relative;width:100%;max-width:480px;aspect-ratio:1;background:#000;border-radius:20px;overflow:hidden;border:2px solid #333;box-shadow:0 20px 60px rgba(0,0,0,0.6);';

        const mainImg = document.createElement('img');
        mainImg.src = images[0];
        mainImg.style.cssText = 'width:100%;height:100%;object-fit:contain;';
        mainImg.onerror = () => mainImg.src = '/static/assets/no-image.png';
        wrapper.appendChild(mainImg);

        if (images.length > 1) {
            const thumbs = document.createElement('div');
            thumbs.style.cssText = 'position:absolute;bottom:0;left:0;right:0;padding:16px 12px;background:linear-gradient(transparent,rgba(0,0,0,0.85));display:flex;gap:8px;justify-content:center;';

            images.slice(0, 6).forEach((url, i) => {
                const thumb = document.createElement('div');
                thumb.style.cssText = `width:40px;height:40px;border-radius:10px;background:url(${url}) center/cover no-repeat;border:2px solid ${i===0?'#00ff9d':'transparent'};cursor:pointer;transition:all .3s;`;
                thumb.onclick = (e) => {
                    e.stopPropagation();
                    mainImg.src = url;
                    thumbs.querySelectorAll('div').forEach((t, j) => {
                        t.style.borderColor = j === i ? '#00ff9d' : 'transparent';
                    });
                };
                thumbs.appendChild(thumb);
            });

            if (images.length > 6) {
                const more = document.createElement('div');
                more.textContent = `+${images.length - 6}`;
                more.style.cssText = 'width:40px;height:40px;border-radius:10px;background:rgba(255,255,255,0.15);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:600;cursor:pointer;';
                more.onclick = (e) => { e.stopPropagation(); openFullscreenGallery(images); };
                thumbs.appendChild(more);
            }

            wrapper.appendChild(thumbs);
        }

        imagesDiv.appendChild(wrapper);
    }

    // Активация
    document.querySelectorAll('.product-row').forEach(r => r.classList.remove('active'));
    row.classList.add('active');
    document.getElementById('productDetail').classList.add('active');
}

function openFullscreenGallery(images, start = 0) {
    const existing = document.getElementById('fullscreenGallery');
    if (existing) existing.remove();

    const overlay = document.createElement('div');
    overlay.id = 'fullscreenGallery';
    overlay.style.cssText = `position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.98);z-index:9999;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .4s;cursor:zoom-out;`;

    const mainImg = document.createElement('img');
    mainImg.src = images[start];
    mainImg.style.cssText = `max-width:94%;max-height:94vh;object-fit:contain;border-radius:16px;box-shadow:0 30px 80px rgba(0,0,0,0.9);transition:opacity .3s ease;`;
    mainImg.onerror = () => mainImg.src = '/static/assets/no-image.png';

    overlay.innerHTML = `
        <button style="position:absolute;top:20px;right:20px;background:none;border:none;color:white;font-size:3.5rem;cursor:pointer;z-index:10;opacity:0.8;" onclick="closeFullscreenGallery()">×</button>
        <button id="prevBtn" style="position:absolute;left:30px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.15);border:none;color:white;font-size:4rem;padding:20px 15px;border-radius:50%;cursor:pointer;backdrop-filter:blur(10px);">‹</button>
        <button id="nextBtn" style="position:absolute;right:30px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.15);border:none;color:white;font-size:4rem;padding:20px 15px;border-radius:50%;cursor:pointer;backdrop-filter:blur(10px);">›</button>
    `;
    overlay.appendChild(mainImg);
    document.body.appendChild(overlay);
    setTimeout(() => overlay.style.opacity = '1', 10);

    let current = start;

    const show = () => {
        mainImg.style.opacity = '0';
        setTimeout(() => {
            mainImg.src = images[current];
            mainImg.style.opacity = '1';
        }, 200);
    };

    const prevBtn = overlay.querySelector('#prevBtn');
    const nextBtn = overlay.querySelector('#nextBtn');

    if (prevBtn) prevBtn.onclick = e => { e.stopPropagation(); current = (current - 1 + images.length) % images.length; show(); };
    if (nextBtn) nextBtn.onclick = e => { e.stopPropagation(); current = (current + 1) % images.length; show(); };

    overlay.onclick = e => { if (e.target === overlay) closeFullscreenGallery(); };

    const escHandler = e => { if (e.key === 'Escape') closeFullscreenGallery(); };
    document.addEventListener('keydown', escHandler);

    window.closeFullscreenGallery = () => {
        overlay.style.opacity = '0';
        setTimeout(() => {
            overlay.remove();
            document.removeEventListener('keydown', escHandler);
            delete window.closeFullscreenGallery;
        }, 400);
    };
}
    function filterProducts() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const rows = Array.from(document.querySelectorAll('.product-row'));
        rows.forEach(row => {
            row.style.display = row.textContent.toLowerCase().includes(term) ? '' : 'none';
        });
    }

    const themeToggle = document.getElementById('theme-toggle');
    const html = document.documentElement;
    if (localStorage.getItem('theme') === 'light') {
        html.setAttribute('data-theme', 'light');
        themeToggle && (themeToggle.checked = true);
    }
    themeToggle?.addEventListener('change', () => {
        const isLight = themeToggle.checked;
        html.setAttribute('data-theme', isLight ? 'light' : 'dark');
        localStorage.setItem('theme', isLight ? 'light' : 'dark');
    });

    filterProducts();

    document.addEventListener('click', function(e) {
        const row = e.target.closest('.product-row');
        if (!row) return;
        if (e.target.closest('.action-btn')) return; // не открывать при клике на кнопки
        showProductDetail(row);
    });


</script>

</body>
</html>