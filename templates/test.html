// admin_goods.js — РАБОЧАЯ ВЕРСИЯ ОТ 23.11.2025 — ФОТКИ 100% ДОХОДЯТ

fetch('/api/check_admin').then(r => r.json()).then(d => { if (!d.is_admin) location.href = '/404'; });

window.goodsImg = filename => `/static/uploads/goods/${filename}`;

function showAlert(msg, type = 'success') {
    const t = document.createElement('div');
    t.className = `zaza-toast ${type}`;
    t.innerHTML = `<span>${msg}</span><button onclick="this.parentElement.remove()">×</button>`;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 4000);
}

// ПРОСТЕЙШИЙ РАБОЧИЙ DRAG & DROP — НИКАКИХ DataTransfer БАГОВ
function initUploader(dropId, inputId, previewId) {
    const drop = document.getElementById(dropId);
    const input = document.getElementById(inputId);
    const preview = document.getElementById(previewId);

    drop.onclick = () => input.click();
    drop.ondragover = e => { e.preventDefault(); drop.classList.add('dragover'); };
    drop.ondragleave = drop.ondragend = () => drop.classList.remove('dragover');
    drop.ondrop = e => {
        e.preventDefault();
        drop.classList.remove('dragover');
        addFiles(e.dataTransfer.files);
    };
    input.onchange = () => addFiles(input.files);

    function addFiles(fileList) {
        const files = Array.from(fileList).filter(f => f.type.startsWith('image/'));
        if (!files.length) return;

        const dt = new DataTransfer();
        // Просто заменяем всё на новые файлы (для простоты)
        files.forEach(f => dt.items.add(f));
        input.files = dt.files;

        preview.innerHTML = '';
        files.forEach((f, i) => {
            const reader = new FileReader();
            reader.onload = e => {
                preview.innerHTML += `
                    <div class="image-item">
                        <img src="${e.target.result}">
                        ${i===0 ? '<div class="main-badge">Главная</div>' : ''}
                        <button type="button" onclick="this.parentElement.remove(); updateFiles('${inputId}')">×</button>
                    </div>`;
            };
            reader.readAsDataURL(f);
        });
        window.updateFiles = id => {
            const remaining = Array.from(preview.querySelectorAll('img')).map(img => {
                const src = img.src;
                const match = src.match(/^data:.+;base64,(.+)$/);
                if (!match) return null;
                const b64 = match[1];
                const bin = atob(b64);
                const arr = new Uint8Array(bin.length);
                for (let i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i);
                return new File([arr], "photo.jpg", { type: "image/jpeg" });
            }).filter(Boolean);
            const dt2 = new DataTransfer();
            remaining.forEach(f => dt2.items.add(f));
            document.getElementById(id).files = dt2.files;
        };
    }
}
initUploader('addDropZone', 'addFileInput', 'addPreview');
initUploader('editDropZone', 'editFileInput', 'editNewPreview');

// САМАЯ ПРОСТАЯ ОТПРАВКА — РАБОТАЕТ ВСЕГДА
async function addProduct() {
    const form = document.getElementById('addForm');
    const password = prompt('Пароль админа:');
    if (!password) return;

    const fd = new FormData();
    fd.append('action', 'add');
    fd.append('password', password);
    fd.append('title', form.title.value.trim());
    fd.append('price_rub', form.price_rub.value);
    fd.append('category', form.category.value.trim());
    fd.append('brand', form.brand?.value.trim() || '');
    fd.append('description', form.description.value);
    fd.append('stock', form.stock.value);
    fd.append('in_stock', form.in_stock.checked ? '1' : '0');

    const files = document.getElementById('addFileInput').files;
    for (let file of files) {
        fd.append('images', file);
    }

    // ДЕБАГ
    console.log("ОТПРАВЛЯЮ ФАЙЛЫ:", files.length);
    for (let f of files) console.log(f.name, f.size);

    const btn = document.getElementById('addSubmitBtn');
    btn.disabled = true;
    btn.innerHTML = 'Загрузка...';

    try {
        const r = await fetch('/admin', { method: 'POST', body: fd });
        const text = await r.text();
        console.log("Ответ сервера:", text);
        if (r.ok) {
            alert('ТОВАР ДОБАВЛЕН С ФОТКАМИ!');
            location.reload();
        } else {
            alert('ОШИБКА: ' + text);
        }
    } catch (e) {
        alert('Нет связи с сервером');
        console.error(e);
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'Добавить товар';
    }
}

// ПРИВЯЗЫВАЕМ К КНОПКЕ
document.getElementById('addSubmitBtn')?.addEventListener('click', e => {
    e.preventDefault();
    addProduct();
});