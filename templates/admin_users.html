<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Пользователи — Админка | Piligrim</title>
  <meta name="csrf-token" content="{{ csrf_token() }}">

  <script>
// Глобальное хранилище актуального токена
window.csrfToken = "{{ csrf_token() }}";

// Автоматически обновляем токен при любом успешном ответе от сервера
function updateCsrfTokenFromResponse(data) {
    if (data.csrf_token) {
        window.csrfToken = data.csrf_token;
        document.querySelector('meta[name="csrf-token"]')?.setAttribute('content', data.csrf_token);
    }
}

// Перехватываем ВСЕ fetch-запросы (POST, PUT, DELETE и т.д.)
const { fetch: origFetch } = window;
window.fetch = async (...args) => {
    let [resource, config] = args;
    
    // Только для мутирующих методов
    if (config && ['POST','PUT','DELETE','PATCH'].includes((config.method || 'GET').toUpperCase())) {
        config = config || {};
        config.headers = config.headers || {};
        config.headers['X-CSRF-Token'] = window.csrfToken;
        config.headers['X-Requested-With'] = 'XMLHttpRequest';
        
        // Если отправляем FormData — не трогаем Content-Type (браузер сам поставит с boundary)
        if (!(config.body instanceof FormData)) {
            config.headers['Content-Type'] = 'application/json';
        }
    }

    const response = await origFetch(resource, config);
    
    // Автоматически обновляем токен после любого успешного JSON-ответа
    if (response.ok && response.headers.get('content-type')?.includes('application/json')) {
        try {
            const data = await response.clone().json();
            updateCsrfTokenFromResponse(data);
        } catch (e) { /* не JSON — игнорируем */ }
    }

    return response;
};
  </script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Shadows+Into+Light&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/admin/admin_reviews.css">
    <link rel="stylesheet" href="/static/css/admin/admin_goods.css">
    <link rel="stylesheet" href="/static/css/admin/admin_users.css">


    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>


</head>
<body>
    <!-- Хедер -->
    <header>
        <a href="/" class="logo">
            <img src="/static/assets/logo.png" alt="ZAZA" class="logo-img">
        </a>
        <nav>
            <a href="/" class="nav-link">Главная</a>
        </nav>
    </header>

 <!-- САЙДБАР -->
<aside class="sidebar">
    <h3 class="sidebar-title">Админка</h3>
    <div class="sidebar-menu">
        <a href="/admin" class="sidebar-item"><i class="fas fa-box"></i><span>Товары</span></a>
        <a href="/admin_services" class="sidebar-item"><i class="fas fa-balance-scale"></i><span>Услуги</span></a>
        <a href="/admin_news" class="sidebar-item"><i class="fas fa-newspaper"></i><span>Новости</span></a>
        <a href="/carousel-editor" class="sidebar-item"><i class="fas fa-images"></i><span>Редактор баннеров</span></a>
        <a href="/admin_dispatch" class="sidebar-item"><i class="fas fa-paper-plane"></i><span>Рассылки</span></a>
        <a href="/admin_feedback" class="sidebar-item"><i class="fas fa-envelope"></i><span>Обратная связь<div class="sidebar-badge">{{ total_feedback }}</div></span></a>
        <a href="/admin_users" class="sidebar-item active"><i class="fas fa-users"></i><span>Пользователи<div class="sidebar-badge">{{ total_users }}</div></span></a>
        <a href="/admin_reviews" class="sidebar-item"><i class="fas fa-star"></i><span>Отзывы<div class="sidebar-badge">{{ total_reviews }}</div></span></a>
        <a href="/admin_orders" class="sidebar-item"><i class="fas fa-shopping-cart"></i><span>Заказы<div class="sidebar-badge">{{ total_orders }}</div></span></a>
    </div>
</aside>

    <!-- Основной контент -->
    <main class="main-content">
        <div class="admin-container">
            <h1 class="section-title">Пользователи</h1>

            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                {% for category, message in messages %}
                  <div class="flash {{ category }}">{{ message }}</div>
                {% endfor %}
              {% endif %}
            {% endwith %}

            <!-- КНОПКА СТАТИСТИКИ -->
            <div class="stats-toggle">
                <button class="stats-toggle-btn" id="toggleStatsBtn">
                    <i class="fas fa-chart-line"></i>
                    <span>Статистика посетителей</span>
                </button>
            </div>

            <!-- СТАТИСТИКА -->
            <div class="stats-section" id="statsSection">
                <div class="stats-header">
                    <div class="stats-title">Статистика</div>
                    <div class="filter-container">
                        <select id="periodSelect">
                            <option value="day">За день</option>
                            <option value="week">За неделю</option>
                            <option value="month">За месяц</option>
                            <option value="year">За год</option>
                        </select>
                        <button class="clear-stats-btn" id="clearAllBtn">Очистить всё</button>
                    </div>
                </div>

                <!-- Основные карточки -->
                <div class="stats-container">
                    <div class="stat-card">
                        <h3>Всего визитов</h3>
                        <p id="totalVisits">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Уникальных</h3>
                        <p id="uniqueVisitors">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Онлайн</h3>
                        <p id="currentOnline">0</p>
                    </div>
                </div>

                <!-- Кликабельные пункты -->
                <div class="stats-items" id="statsItems"></div>

                <!-- Динамический график -->
                <div class="chart-container" id="dynamicChartContainer" style="display:none;">
                    <canvas id="dynamicChart"></canvas>
                    <div class="chart-loading" id="chartLoading">Загрузка...</div>
                </div>
            </div>

            <!-- Поиск -->
            <form method="GET" class="search-form">
                <input type="text" name="phone" class="search-input" placeholder="Поиск по телефону..." 
                       value="{{ phone }}" id="phoneSearch">
                <input type="hidden" name="page" value="1">
                <button type="submit" style="display:none;"></button>
            </form>

            <!-- Пользователи -->
            <div class="users-list">
                {% for u in users %}
                <div class="user-item">
                    <div class="user-avatar">{{ u.phone[-2:] }}</div>
                    <div class="user-info">
                        <div class="user-phone">
                            {{ u.phone }}
                            <label class="admin-toggle" onclick="openAdminModal({{ u.id }}, {{ u.is_admin }})">
                                <input type="checkbox" {{ 'checked' if u.is_admin else '' }}>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="data">
                            <i class="fas fa-calendar"></i> {{ u.created_at|format_date }}
                            {% if u.is_blocked %}
                                <i class="fas fa-lock" style="color:#ff6666;" title="Заблокирован"></i>
                            {% else %}
                                <i class="fas fa-unlock" style="color:#ffffff;" title="Активен"></i>
                            {% endif %}
                        </div>
                        <div class="user-meta">
                            <i class="fas fa-shopping-cart"></i> 
                            <span class="user-cart-count">{{ u.cart_count }} в корзине</span>
                        </div>
                    </div>
                    {% if u.id != session.get('user_id') %}
                    <div class="user-actions-icons">
                        <button class="action-icon" onclick="openCartModal({{ u.id }})" title="Корзина">
                            <i class="fas fa-shopping-cart"></i>
                        </button>
                        <button class="action-icon" onclick="openBlockModal({{ u.id }}, {{ u.is_blocked }})">
                            <i class="fas {% if u.is_blocked %}fa-lock{% else %}fa-unlock{% endif %}"></i>
                        </button>
                        <button class="action-icon" onclick="openDeleteModal({{ u.id }})">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                    {% else %}
                    <div style="position:absolute;top:1rem;right:1rem;color:#ffffff;font-size:0.9rem;">
                        Это вы
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>

            <!-- Пагинация -->
            {% if total_pages > 1 %}
            <div class="pagination-container">
                <div class="pagination-info">
                    Показано {{ ((page-1)*per_page + 1) }}–{{ [page*per_page, total_users]|min }} из {{ total_users }}
                </div>
                <div class="pagination">
                    {% set url_base = '?phone=' + phone + '&page=' %}
                    {% if page > 1 %}
                    <a href="{{ url_base }}{{ page - 1 }}" class="page-link"><i class="fas fa-chevron-left"></i></a>
                    {% else %}
                    <span class="page-link disabled"><i class="fas fa-chevron-left"></i></span>
                    {% endif %}
                    {% set start_page = [page - 2, 1]|max %}
                    {% set end_page = [page + 2, total_pages]|min %}
                    {% if start_page > 1 %}
                    <a href="{{ url_base }}1" class="page-link">1</a>
                    {% if start_page > 2 %}<span class="page-dots">...</span>{% endif %}
                    {% endif %}
                    {% for p in range(start_page, end_page + 1) %}
                    <a href="{{ url_base }}{{ p }}" class="page-link {% if p == page %}active{% endif %}">{{ p }}</a>
                    {% endfor %}
                    {% if end_page < total_pages %}
                    {% if end_page < total_pages - 1 %}<span class="page-dots">...</span>{% endif %}
                    <a href="{{ url_base }}{{ total_pages }}" class="page-link">{{ total_pages }}</a>
                    {% endif %}
                    {% if page <page < total_pages %}
                    <a href="{{ url_base }}{{ page + 1 }}" class="page-link"><i class="fas fa-chevron-right"></i></a>
                    {% else %}
                    <span class="page-link disabled"><i class="fas fa-chevron-right"></i></span>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </main>

    <!-- Модалки -->
    <div class="modal-overlay" id="cartModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Корзина пользователя</h2>
                <button class="modal-close" onclick="closeCartModal()">×</button>
            </div>
            <div id="cartContent">Загрузка...</div>
            <div class="modal-actions">
                <button style="background: var(--white); color: var(--dark);" onclick="clearUserCart()">Очистить корзину</button>
                <button class="cancel-btn" onclick="closeCartModal()">Закрыть</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="blockModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="blockTitle">Заблокировать пользователя?</h2>
                <button class="modal-close" onclick="closeBlockModal()">×</button>
            </div>
            <form method="POST">
                <input type="hidden" name="action" id="blockAction">
                <input type="hidden" name="user_id" id="blockUserId">
                <div class="form-group">
                    <label>Пароль админа</label>
                    <input type="password" name="password" required placeholder="Введите пароль">
                </div>
                <div class="modal-actions">
                    <button type="submit" id="blockBtn" style="background: #ff6666; color: var(--white);">Заблокировать</button>
                    <button type="button" class="cancel-btn" onclick="closeBlockModal()">Отмена</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Удалить аккаунт навсегда?</h2>
                <button class="modal-close" onclick="closeDeleteModal()">×</button>
            </div>
            <form method="POST">
                <input type="hidden" name="action" value="delete_user">
                <input type="hidden" name="user_id" id="deleteUserId">
                <div class="form-group">
                    <label>Пароль админа</label>
                    <input type="password" name="password" required placeholder="Введите пароль">
                </div>
                <div class="modal-actions">
                    <button type="submit" style="background: #ff3366; color: var(--white);">УДАЛИТЬ НАВСЕГДА</button>
                    <button type="button" class="cancel-btn" onclick="closeDeleteModal()">Отмена</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="adminModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="adminTitle">Выдать админ-права?</h2>
                <button class

-modal-close" onclick="closeAdminModal()">×</button>
            </div>
            <form method="POST">
                <input type="hidden" name="action" value="edit_user">
                <input type="hidden" name="user_id" id="adminUserId">
                <input type="hidden" name="is_admin" id="adminValue" value="1">
                <div class="form-group">
                    <label>Пароль админа</label>
                    <input type="password" name="password" required placeholder="Введите пароль">
                </div>
                <div class="modal-actions">
                    <button type="submit" id="adminBtn" style="background: var(--white); color: var(--dark);">Выдать</button>
                    <button type="button" class="cancel-btn" onclick="closeAdminModal()">Отмена</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ВИСЯЩИЙ ТУМБЛЕР ТЕМЫ -->
<div class="theme-toggle-hanging">
  <input type="checkbox" id="theme-toggle" class="theme-toggle-input">
  <label for="theme-toggle" class="theme-toggle-label">
    <div class="rope top"></div>
    <div class="bulb">
      <div class="bulb-light"></div>
      <div class="bulb-glow"></div>
    </div>
    <div class="rope bottom"></div>
  </label>
</div>

<script>
    // === Глобальные переменные ===
    let dynamicChart = null;
    let currentStatsData = null;
    let currentChartType = null;
    let isLoading = false;

    const statsTypes = [
        { key: 'visits',      label: 'Всего визитов (сессии)', icon: 'fa-chart-line' },
        { key: 'unique',      label: 'Уникальные по IP',       icon: 'fa-user-check' },
        { key: 'non-unique',  label: 'Все запросы',            icon: 'fa-globe' },
        { key: 'online',      label: 'Текущий онлайн',         icon: 'fa-circle-dot' },
        { key: 'avg-time',    label: 'Среднее время',          icon: 'fa-clock' },
        { key: 'top-pages',   label: 'Топ-страницы',           icon: 'fa-list-ol' },
        { key: 'activity',    label: 'Активность по часам',    icon: 'fa-chart-area' }
    ];

    // === Перерисовываем пункты + вешаем клики ===
    function renderStatsItems() {
        const container = document.getElementById('statsItems');
        container.innerHTML = statsTypes.map(t => `
            <div class="stats-item" data-type="${t.key}">
                <span><i class="fas ${t.icon}"></i> ${t.label}</span>
                <button class="clear-btn" data-type="${t.key}">Очистить</button>
            </div>
        `).join('');

        // Навешиваем обработчики заново
        container.addEventListener('click', function(e) {
            const item = e.target.closest('.stats-item');
            const clearBtn = e.target.closest('.clear-btn');

            // Клик по кнопке "Очистить"
            if (clearBtn) {
                e.stopPropagation();
                clearPeriod(clearBtn.dataset.type);
                return;
            }

            // Клик по пункту графика
            if (item) {
                document.querySelectorAll('.stats-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                showChart(item.dataset.type);
            }
        });
    }

    // === Загрузка статистики ===
    async function loadStats() {
        if (isLoading) return;
        isLoading = true;
        const period = document.getElementById('periodSelect').value;

        try {
            const res = await fetch(`/api/stats?period=${period}`);
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const data = await res.json();

            document.getElementById('totalVisits').textContent = (data.total_visits || 0).toLocaleString();
            document.getElementById('uniqueVisitors').textContent = (data.unique_visitors || 0).toLocaleString();
            document.getElementById('currentOnline').textContent = data.current_online || 0;

            currentStatsData = data;


        } catch (e) {
            console.error(e);
            alert('Ошибка загрузки статистики');
        } finally {
            isLoading = false;
        }
    }

    // === ПЕРЕКЛЮЧЕНИЕ ТЕМЫ ===
const toggle = document.getElementById('theme-toggle');
const html = document.documentElement;

if (localStorage.getItem('theme') === 'light') {
  html.setAttribute('data-theme', 'light');
  if (toggle) toggle.checked = true;
} else {
  html.setAttribute('data-theme', 'dark');
  localStorage.setItem('theme', 'dark');
}

toggle?.addEventListener('change', () => {
  const isLight = toggle.checked;
  html.setAttribute('data-theme', isLight ? 'light' : 'dark');
  localStorage.setItem('theme', isLight ? 'light' : 'dark');
});

function showChart(type) {
    if (!currentStatsData) return;
    currentChartType = type;
    const container = document.getElementById('dynamicChartContainer');
    const loading = document.getElementById('chartLoading');

    container.style.display = 'block';
    if (dynamicChart) {
        dynamicChart.destroy();
        dynamicChart = null;
    }

    // === ТЕКСТОВЫЕ БЛОКИ: онлайн и среднее время (единственный рабочий блок!) ===
    if (type === 'avg-time' || type === 'online') {
        const isLight = document.documentElement.getAttribute('data-theme') === 'light';
        const textColor     = isLight ? '#111111' : '#ffffff';
        const accentColor   = isLight ? '#00ff9d'  : '#ffffff';

        let text = '';
        if (type === 'avg-time') {
            const secs = currentStatsData.avg_time_on_site || 0;
            const mins = Math.floor(secs / 60);
            const sec  = secs % 60;
            text = `Среднее время: <strong>${mins} мин ${sec} сек</strong>`;
        } else {
            text = `Сейчас онлайн: <strong>${currentStatsData.current_online || 0}</strong>`;
        }

        container.innerHTML = `
            <div style="
                display: flex;
                align-items: center;
                justify-content: center;
                height: 100%;
                font-size: 2.4rem;
                font-weight: 500;
                color: ${textColor};
                text-align: center;
            ">
                ${text.replace('<strong>', `<strong style="color:${accentColor}; font-weight:800;">`)}
            </div>`;
        return;
    }

    // === Если данных нет ===
    let rawData = [];
    switch (type) {
        case 'visits':      rawData = currentStatsData.visits_data || []; break;
        case 'unique':      rawData = currentStatsData.unique_data || []; break;
        case 'non-unique':  rawData = currentStatsData.non_unique_data || []; break;
        case 'top-pages':   rawData = currentStatsData.top_pages || []; break;
        case 'activity':    rawData = currentStatsData.activity_map || []; break;
    }

    if (!rawData || rawData.length === 0) {
        container.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#999;font-size:1.5rem;">
            Нет данных за выбранный период
        </div>`;
        return;
    }

    // === Восстанавливаем canvas для обычных графиков ===
    container.innerHTML = '<canvas id="dynamicChart"></canvas><div class="chart-loading" id="chartLoading">Загрузка...</div>';
    loading.style.display = 'block';

    requestAnimationFrame(() => {
        loading.style.display = 'none';

        const labels = rawData.map(x => x.label || x.path || x.hour || '—');
        const values = rawData.map(x => x.value || x.views || x.active_sessions || 0);
        const isBar = type === 'top-pages';

        const isLight = document.documentElement.getAttribute('data-theme') === 'light';

        const config = {
            type: isBar ? 'bar' : 'line',
            data: {
                labels,
                datasets: [{
                    label: isBar ? 'Просмотры' : 'Количество',
                    data: values,
                    backgroundColor: isBar
                        ? (isLight ? 'rgba(0, 255, 157, 0.85)' : 'rgba(255,255,255,0.9)')
                        : (isLight ? 'rgba(0, 255, 157, 0.18)' : 'rgba(255,255,255,0.15)'),
                    borderColor: isLight ? '#00ff9d' : '#ffffff',
                    borderWidth: isLight ? 3 : 2,
                    fill: !isBar,
                    tension: 0.4,
                    pointRadius: 5,
                    pointHoverRadius: 8,
                    pointBackgroundColor: isLight ? '#00ff9d' : '#ffffff',
                    pointBorderColor: isLight ? '#000000' : '#ffffff',
                    pointBorderWidth: isLight ? 2 : 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: !isBar, labels: { color: isLight ? '#333' : '#ccc' } } },
                scales: {
                    y: { beginAtZero: true, ticks: { color: isLight ? '#333' : '#ccc' }, grid: { color: isLight ? 'rgba(0,0,0,0.08)' : 'rgba(255,255,255,0.08)' } },
                    x: { ticks: { color: isLight ? '#333' : '#ccc' }, grid: { color: isLight ? 'rgba(0,0,0,0.08)' : 'rgba(255,255,255,0.08)' } }
                }
            }
        };

        const canvas = document.getElementById('dynamicChart');
        if (canvas) dynamicChart = new Chart(canvas, config);
    });
}
    // === Очистка конкретного типа ===
    async function clearPeriod(type) {
        const password = prompt('Пароль админа для очистки:');
        if (!password) return;

        const period = document.getElementById('periodSelect').value;
        const res = await fetch('/api/clear_visits_period', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `password=${encodeURIComponent(password)}&period=${period}&type=${type}`
        });

        if (res.ok) {
            alert('Очищено!');
            loadStats();
        } else {
            alert('Неверный пароль или ошибка');
        }
    }

    // === Полная очистка ===
    document.getElementById('clearAllBtn').addEventListener('click', async () => {
        const password = prompt('Пароль для ПОЛНОЙ очистки ВСЕЙ статистики:');
        if (!password) return;

        const res = await fetch('/api/clear_visits', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `password=${encodeURIComponent(password)}`
        });

        if (res.ok) {
            alert('Вся статистика удалена!');
            currentStatsData = null;
            currentChartType = null;
            document.getElementById('dynamicChartContainer').style.display = 'none';
            document.querySelectorAll('.stats-item').forEach(i => i.classList.remove('active'));
            loadStats();
        } else {
            alert('Ошибка');
        }
    });

    // === Открытие/закрытие блока статистики ===
// === Открытие/закрытие блока статистики (РАБОЧИЙ ТУМБЛЕР) ===
document.getElementById('toggleStatsBtn').addEventListener('click', () => {
    const section = document.getElementById('statsSection');
    const btn = document.getElementById('toggleStatsBtn');
    const chartContainer = document.getElementById('dynamicChartContainer');

    const isOpen = section.classList.contains('open');
    
    if (isOpen) {
        // === ЗАКРЫВАЕМ ===
        section.classList.remove('open');
        btn.classList.remove('open');

        // Полностью скрываем и очищаем график
        chartContainer.style.display = 'none';
        chartContainer.innerHTML = '<canvas id="dynamicChart"></canvas><div class="chart-loading" id="chartLoading">Загрузка...</div>';
        
        if (dynamicChart) {
            dynamicChart.destroy();
            dynamicChart = null;
        }
        currentChartType = null;
        document.querySelectorAll('.stats-item').forEach(i => i.classList.remove('active'));
    } else {
        // === ОТКРЫВАЕМ ===
        section.classList.add('open');
        btn.classList.add('open');
        
        renderStatsItems();
        loadStats();
    }
});

    // === Смена периода ===
    document.getElementById('periodSelect').addEventListener('change', loadStats);

    // === Модалки (оставил без изменений) ===
    let currentUserId = null;

    function openCartModal(id) {
        currentUserId = id;
        const cont = document.getElementById('cartContent');
        cont.innerHTML = '<p style="text-align:center;padding:2rem;color:#aaa;"><i class="fas fa-spinner fa-spin"></i> Загрузка...</p>';
        fetch(`/api/user_cart/${id}`).then(r => r.ok ? r.json() : Promise.reject()).then(data => {
            cont.innerHTML = data.length ? '<div class="cart-items">' + data.map(i => `
                <div class="cart-item">
                    <img src="${i.image_url || '/static/no-image.png'}" onerror="this.src='/static/no-image.png'">
                    <div><strong>${i.title}</strong><br><small>${i.price_str} × ${i.quantity}</small></div>
                </div>`).join('') + '</div>' : '<p style="text-align:center;color:#aaa;">Корзина пуста</p>';
        }).catch(() => cont.innerHTML = '<p style="color:#ff6666;">Ошибка</p>');
        document.getElementById('cartModal').classList.add('active');
    }

    function clearUserCart() {
        if (!confirm('Очистить корзину?')) return;
        const p = prompt('Пароль админа:');
        if (!p) return;
        fetch(`/api/clear_user_cart/${currentUserId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `password=${encodeURIComponent(p)}`
        }).then(r => r.ok ? alert('Очищено') : alert('Ошибка')).then(() => openCartModal(currentUserId));
    }

    function openBlockModal(id, blocked) {
        document.getElementById('blockUserId').value = id;
        document.getElementById('blockAction').value = blocked ? 'unblock_user' : 'block_user';
        document.getElementById('blockTitle').textContent = blocked ? 'Разблокировать?' : 'Заблокировать?';
        document.getElementById('blockBtn').textContent = blocked ? 'Разблокировать' : 'Заблокировать';
        document.getElementById('blockBtn').style.background = blocked ? '#fff' : '#ff6666';
        document.getElementById('blockBtn').style.color = blocked ? '#000' : '#fff';
        document.getElementById('blockModal').classList.add('active');
    }

    function openDeleteModal(id) { document.getElementById('deleteUserId').value = id; document.getElementById('deleteModal').classList.add('active'); }
    function openAdminModal(id, isAdmin) {
        document.getElementById('adminUserId').value = id;
        document.getElementById('adminValue').value = isAdmin ? '0' : '1';
        document.getElementById('adminTitle').textContent = isAdmin ? 'Забрать права?' : 'Выдать права?';
        document.getElementById('adminBtn').textContent = isAdmin ? 'Забрать' : 'Выдать';
        document.getElementById('adminBtn').style.background = isAdmin ? '#ff6666' : '#fff';
        document.getElementById('adminBtn').style.color = isAdmin ? '#fff' : '#000';
        document.getElementById('adminModal').classList.add('active');
    }

    function closeCartModal()   { document.getElementById('cartModal').classList.remove('active'); }
    function closeBlockModal()  { document.getElementById('blockModal').classList.remove('active'); }
    function closeDeleteModal() { document.getElementById('deleteModal').classList.remove('active'); }
    function closeAdminModal()  { document.getElementById('adminModal').classList.remove('active'); }

    document.querySelectorAll('.modal-overlay').forEach(el => el.addEventListener('click', e => {
        if (e.target === el) el.classList.remove('active');
    }));

    document.getElementById('phoneSearch')?.addEventListener('input', () => {
        clearTimeout(window.searchTimer);
        window.searchTimer = setTimeout(() => document.querySelector('.search-form').submit(), 600);
    });

    window.addEventListener('scroll', () => {
        document.querySelector('header').classList.toggle('scrolled', window.scrollY > 50);
    });

    // Инициализация
    renderStatsItems();
</script>
</body>
</html>