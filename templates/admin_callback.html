<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Обратная связь — Админка | ZAZA</title>
      <meta name="csrf-token" content="{{ csrf_token() }}">

  <script>
// Глобальное хранилище актуального токена
window.csrfToken = "{{ csrf_token() }}";

// Автоматически обновляем токен при любом успешном ответе от сервера
function updateCsrfTokenFromResponse(data) {
    if (data.csrf_token) {
        window.csrfToken = data.csrf_token;
        document.querySelector('meta[name="csrf-token"]')?.setAttribute('content', data.csrf_token);
    }
}

// Перехватываем ВСЕ fetch-запросы (POST, PUT, DELETE и т.д.)
const { fetch: origFetch } = window;
window.fetch = async (...args) => {
    let [resource, config] = args;
    
    // Только для мутирующих методов
    if (config && ['POST','PUT','DELETE','PATCH'].includes((config.method || 'GET').toUpperCase())) {
        config = config || {};
        config.headers = config.headers || {};
        config.headers['X-CSRF-Token'] = window.csrfToken;
        config.headers['X-Requested-With'] = 'XMLHttpRequest';
        
        // Если отправляем FormData — не трогаем Content-Type (браузер сам поставит с boundary)
        if (!(config.body instanceof FormData)) {
            config.headers['Content-Type'] = 'application/json';
        }
    }

    const response = await origFetch(resource, config);
    
    // Автоматически обновляем токен после любого успешного JSON-ответа
    if (response.ok && response.headers.get('content-type')?.includes('application/json')) {
        try {
            const data = await response.clone().json();
            updateCsrfTokenFromResponse(data);
        } catch (e) { /* не JSON — игнорируем */ }
    }

    return response;
};
  </script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

    <link rel="stylesheet" href="/static/css/admin/admin_reviews.css">
    <link rel="stylesheet" href="/static/css/admin/admin_feedback.css">

    <style>
        #subsBody tr.selected {
    background: rgba(100, 200, 255, 0.15) !important;
    outline: 2px solid var(--accent);
}
.subscriber-actions button {
    background: rgba(255,255,255,0.08);
    border: none;
    width: 38px;
    height: 38px;
    border-radius: 12px;
    color: #fff;
    cursor: pointer;
    font-size: 1.1rem;
    transition: all 0. 0.2s;
}
.subscriber-actions button:hover {
    background: rgba(255,255,255,0.15);
    transform: scale(1.1);
}
.subscriber-actions button.delete { color: #ff6b6b; }
.subscriber-actions button:first-child { color: var(--accent); }
    </style>

</head>
<body>

    <header>
        <a href="/" class="logo"><img src="/static/assets/logo.png" alt="ZAZA" class="logo-img"></a>
        <nav style="margin-left: auto;"><a href="/" class="nav-link">Главная</a></nav>
    </header>

<aside class="sidebar">
    <h3 class="sidebar-title">Админка</h3>
    <div class="sidebar-menu">
        <a href="/admin" class="sidebar-item"><i class="fas fa-box"></i><span>Товары</span></a>
        <a href="/admin_services" class="sidebar-item"><i class="fas fa-balance-scale"></i><span>Услуги</span></a>
        <a href="/admin_news" class="sidebar-item"><i class="fas fa-newspaper"></i><span>Новости</span></a>
        <a href="/carousel-editor" class="sidebar-item"><i class="fas fa-images"></i><span>Редактор баннеров</span></a>
        <a href="/admin_dispatch" class="sidebar-item"><i class="fas fa-paper-plane"></i><span>Рассылки</span></a>
        <a href="/admin_feedback" class="sidebar-item active"><i class="fas fa-envelope"></i><span>Обратная связь<div class="sidebar-badge">{{ total_feedback }}</div></span></a>
        <a href="/admin_users" class="sidebar-item"><i class="fas fa-users"></i><span>Пользователи<div class="sidebar-badge">{{ total_users }}</div></span></a>
        <a href="/admin_reviews" class="sidebar-item"><i class="fas fa-star"></i><span>Отзывы<div class="sidebar-badge">{{ total_reviews }}</div></span></a>
        <a href="/admin_orders" class="sidebar-item"><i class="fas fa-shopping-cart"></i><span>Заказы<div class="sidebar-badge">{{ total_orders }}</div></span></a>
    </div>
</aside>

    <main class="main-content">
        <div class="admin-container">
            <h1 class="section-title">Обратная связь</h1>

            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                {% for category, message in messages %}
                  <div class="flash {{ 'success' if category != 'error' else 'error' }}">{{ message | safe }}</div>
                {% endfor %}
              {% endif %}
            {% endwith %}

            <div class="filters">
                <input type="text" id="searchInput" class="search-input" placeholder="Поиск по ФИО, email, телефону, тексту..." autocomplete="off">

                <div class="custom-select">
                    <div class="custom-select-trigger"><span class="custom-select-text">За всё время</span><i class="fas fa-chevron-down custom-select-arrow"></i></div>
                    <div class="custom-select-options">
                        <div class="custom-select-option" data-value="">За всё время</div>
                        <div class="custom-select-option" data-value="today">Сегодня</div>
                        <div class="custom-select-option" data-value="7days">Последние 7 дней</div>
                        <div class="custom-select-option" data-value="30days">Последние 30 дней</div>
                        <div class="custom-select-option" data-value="custom">Выбрать период...</div>
                    </div>
                    <input type="hidden" id="dateFilter" value="">
                </div>
            </div>

            <div class="selection-controls">
                <button class="btn-zaza-primary" id="startSelectionBtn" onclick="enterSelectionMode()">Выбрать</button>
                <div class="bulk-actions" id="bulkActions">
                    <button class="btn-zaza-primary" id="deleteSelectedBtn" onclick="prepareBulkDelete()">
                        Удалить выбранные (<span id="selectedCount">0</span>)
                    </button>
                    <button class="btn-zaza-danger" onclick="prepareDeleteAll()">Удалить все</button>
                    <button style="background:#444;color:#fff;padding:0.7rem 1.3rem;border-radius:12px;border:none;cursor:pointer;" onclick="exitSelectionMode()">Отмена</button>
                </div>
            </div>

            <input type="date" id="dateFrom" style="display:none;">
            <input type="date" id="dateTo" style="display:none;">

            <div id="feedbackContainer">
                {% if feedbacks|length == 0 %}
                <div style="text-align:center;padding:8rem 0;color:var(--gray);">
                    <i class="fas fa-inbox" style="font-size:6rem;margin-bottom:1.5rem;opacity:0.6;"></i>
                    <p style="font-size:1.6rem;">Пока нет заявок</p>
                </div>
                {% else %}
                {% for f in feedbacks %}
                <div class="review-item clickable-feedback"
                     data-id="{{ f.id }}"
                     data-name="{{ f.name|e }}"
                     data-email="{{ f.email|e }}"
                     data-phone="{{ f.phone|e if f.phone else '' }}"
                     data-message="{{ f.message|replace('\n', '[BR]')|e }}"
                     data-created="{{ f.created_at[:16] }}">
                     
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                        <div>
                            <div class="review-user">{{ f.name }}</div>
                            <div class="review-date"><i class="far fa-calendar-alt"></i> {{ f.created_at[:16] }}</div>
                        </div>
                        <button class="action-btn delete" onclick="event.stopPropagation(); prepareSingleDelete({{ f.id }})" style="background:none;border:none;color:#ff4444;font-size:1.4rem;cursor:pointer;">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>

                    <div class="review-info-line" onclick="event.stopPropagation(); copyToClipboard('{{ f.email|e }}')">
                        <i class="fas fa-envelope"></i> {{ f.email }}
                    </div>

                    {% if f.phone %}
                    <div class="review-info-line" style="margin-top:0.5rem;" onclick="event.stopPropagation(); copyToClipboard('{{ f.phone|e }}')">
                        <i class="fas fa-phone"></i> {{ f.phone }}
                    </div>
                    {% endif %}

                    <div class="review-text-preview">
                        {{ f.message|replace('\n', '<br>')|safe }}
                        <span class="read-more" onclick="event.stopPropagation(); openFullFeedback(this.closest('.review-item'))">
                            Читать полностью
                        </span>
                    </div>
                </div>
                {% endfor %}
                {% endif %}
            </div>

            <div class="pagination">
                <button class="page-link" id="prevBtn" onclick="changePage(-1)" disabled>Пред.</button>
                <span id="pageInfo">Страница 1 из 1</span>
                <button class="page-link" id="nextBtn" onclick="changePage(1)" disabled>След.</button>
            </div>
        </div>
    </main>

    <!-- Модалки -->
    <div id="dateRangeModal" class="modal-overlay" onclick="if(event.target===this) closeModal('dateRangeModal')">
        <div class="modal">
            <button class="modal-close" onclick="closeModal('dateRangeModal')">×</button>
            <h3>Выберите период</h3>
            <div style="margin-top:1.5rem;">
                <label>С даты</label><input type="date" id="modalDateFrom" class="search-input">
                <label style="margin-top:1rem;display:block;">По дату</label><input type="date" id="modalDateTo" class="search-input">
            </div>
            <div style="margin-top:2rem;display:flex;gap:1rem;">
                <button id="applyDateBtn" class="btn-zaza-primary" disabled>Применить</button>
                <button style="background:#444;color:#fff;padding:0.7rem 1.3rem;border-radius:12px;border:none;cursor:pointer;" onclick="closeModal('dateRangeModal')">Отмена</button>
            </div>
        </div>
    </div>

    <div id="deleteConfirmModal" class="modal-overlay" onclick="if(event.target===this) closeModal('deleteConfirmModal')">
        <div class="modal">
            <button class="modal-close" onclick="closeModal('deleteConfirmModal')">×</button>
            <h3><i class="fas fa-exclamation-triangle" style="color:#ff4444;"></i> Подтвердите удаление</h3>
            <p id="deleteConfirmText" style="margin:1.5rem 0; color:#ddd; line-height:1.6;"></p>
            <input type="password" id="deletePassword" placeholder="Пароль администратора" autofocus autocomplete="off" style="width:100%;padding:1rem;background:#222;border:1px solid #444;border-radius:12px;color:#fff;">
            <div class="flash error" id="deletePasswordError" style="display:none;margin-top:0.5rem;"></div>
            <div style="margin-top:2rem;display:flex;gap:1rem;">
                <button class="btn-zaza-danger" onclick="executeDelete()">Удалить</button>
                <button style="background:#444;color:#fff;padding:0.7rem 1.3rem;border-radius:12px;border:none;cursor:pointer;" onclick="closeModal('deleteConfirmModal')">Отмена</button>
            </div>
        </div>
    </div>

    <div id="fullFeedbackModal" class="modal-overlay" onclick="if(event.target===this) closeModal('fullFeedbackModal')">
        <div class="modal" style="max-width:720px;">
            <button class="modal-close" onclick="closeModal('fullFeedbackModal')">×</button>
            <h2 style="margin:0 0 1.8rem; color:var(--accent);">Полная заявка</h2>
            <div style="background:rgba(30,30,35,0.9); border-radius:16px; padding:1.8rem; border:1px solid #333;">
                <div style="margin-bottom:1.2rem;"><strong style="color:#888;">Имя:</strong> <span id="modalName" style="margin-left:0.8rem; color:#fff; font-size:1.1rem;"></span></div>
                <div style="margin-bottom:1.2rem;"><strong style="color:#888;">Дата:</strong> <span id="modalDate" style="margin-left:0.8rem; color:var(--accent);"></span></div>
                <div style="margin-bottom:1.2rem;"><strong style="color:#888;">Email:</strong> <span id="modalEmail" style="margin-left:0.8rem; color:#fff; word-break:break-all;"></span></div>
                <div id="modalPhoneWrapper" style="margin-bottom:1.2rem; display:none;">
                    <strong style="color:#888;">Телефон:</strong> <span id="modalPhone" style="margin-left:0.8rem; color:#fff;"></span>
                </div>
                <div style="margin-top:2rem; padding-top:1.5rem; border-top:1px solid #444;">
                    <strong style="color:#888; display:block; margin-bottom:0.8rem;">Сообщение:</strong>
                    <div id="modalMessage" style="color:#ddd; line-height:1.75; white-space: pre-wrap; background:#111; padding:1.2rem; border-radius:12px; border:1px solid #333; max-height:60vh; overflow-y:auto;"></div>
                </div>
            </div>
            <div style="margin-top:2rem;">
                <button class="btn-zaza-primary" onclick="closeModal('fullFeedbackModal')">Закрыть</button>
            </div>
        </div>
    </div>

    <div class="theme-toggle-hanging">
    <input type="checkbox" id="theme-toggle" class="theme-toggle-input">
    <label for="theme-toggle" class="theme-toggle-label" aria-label="Переключить тему">
        <div class="rope top"></div>
        <div class="bulb">
            <div class="bulb-light"></div>
            <div class="bulb-glow"></div>
        </div>
        <div class="rope bottom"></div>
    </label>
</div>

<script src="/static/js/admin/admin_feedback.js" defer></script>


</body>
</html>