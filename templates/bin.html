<!DOCTYPE html>
<head>
  <script>
    // Определяем тему ещё до первого рендера
    const savedTheme = localStorage.getItem('theme');
    const prefersLight = window.matchMedia('(prefers-color-scheme: light)').matches;
    const theme = savedTheme || (prefersLight ? 'light' : 'dark');

    // Сразу ставим атрибут
    document.documentElement.setAttribute('data-theme', theme);

    // И сразу форсируем правильный фон лоадера
    document.documentElement.style.backgroundColor = theme === 'light' ? '#ffffff' : '#000000';
  </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="csrf-token" content="{{ csrf_token() }}">

  <script>
// Глобальное хранилище актуального токена
window.csrfToken = "{{ csrf_token() }}";

// Автоматически обновляем токен при любом успешном ответе от сервера
function updateCsrfTokenFromResponse(data) {
    if (data.csrf_token) {
        window.csrfToken = data.csrf_token;
        document.querySelector('meta[name="csrf-token"]')?.setAttribute('content', data.csrf_token);
    }
}

// Перехватываем ВСЕ fetch-запросы (POST, PUT, DELETE и т.д.)
const { fetch: origFetch } = window;
window.fetch = async (...args) => {
    let [resource, config] = args;
    
    // Только для мутирующих методов
    if (config && ['POST','PUT','DELETE','PATCH'].includes((config.method || 'GET').toUpperCase())) {
        config = config || {};
        config.headers = config.headers || {};
        config.headers['X-CSRF-Token'] = window.csrfToken;
        config.headers['X-Requested-With'] = 'XMLHttpRequest';
        
        // Если отправляем FormData — не трогаем Content-Type (браузер сам поставит с boundary)
        if (!(config.body instanceof FormData)) {
            config.headers['Content-Type'] = 'application/json';
        }
    }

    const response = await origFetch(resource, config);
    
    // Автоматически обновляем токен после любого успешного JSON-ответа
    if (response.ok && response.headers.get('content-type')?.includes('application/json')) {
        try {
            const data = await response.clone().json();
            updateCsrfTokenFromResponse(data);
        } catch (e) { /* не JSON — игнорируем */ }
    }

    return response;
};
  </script>

<style>
  /* Цвет грузовика — чёрный в светлой теме, белый в тёмной */
html[data-theme="light"] .fa-truck { color: #000 !important; }
html[data-theme="dark"]  .fa-truck { color: #fff !important; }
</style>
<!-- Этот скрипт — магия, которая заставляет медиа-запросы сработать сразу на 100% устройств -->
<script>
  // Если вдруг браузер думает, что ширина >1024px — принудительно говорим, что это мобильник
  if (window.innerWidth <= 1024 && !document.body.classList.contains('mobile-layout')) {
    document.body.classList.add('mobile-layout');
  }
</script>

  <title>Корзина — Piligrim</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <!-- Твои основные стили -->
  <link rel="stylesheet" href="/static/css/search.css">
  <link rel="stylesheet" href="/static/css/auth.css">
  <link rel="stylesheet" href="/static/css/cart.css">
  <link rel="stylesheet" href="/static/css/ai.css">
  <link rel="stylesheet" href="/static/css/contacts.css">
  <link rel="stylesheet" href="/static/css/bins.css">


  <style>
  /* Анимация шторки сверху вниз — только на мобильных */
  @media (max-width: 1026px) {
    #multiOrderModal {
      align-items: flex-start !important;
      padding-top: env(safe-area-inset-top);
    }

    #multiOrderModal .modal-inner {
      width: 100%;
      max-width: none;
      height: auto;
      max-height: 96vh;
      border-radius: 0 0 32px 32px !important;
      transform: translateY(-100%);
      transition: transform 0.55s cubic-bezier(0.22, 1, 0.36, 1);
    }

    #multiOrderModal.show .modal-inner {
      transform: translateY(0);
    }

    /* Граббер как у iOS */
    #multiOrderModal .ios-grabber {
      width: 40px;
      height: 5px;
      background: rgba(255,255,255,0.3);
      border-radius: 3px;
      margin: 12px auto 8px;
    }
  }
</style>
<style>
@media (max-width: 1026px) {
  #multiOrderModal {
    background: rgba(0,0,0,0.65);
    backdrop-filter: blur(20px);
  }
}
</style>
  <style>
@keyframes slideDown {
  from { transform: translateX(-50%) translateY(-100px); opacity: 0; }
  to   { transform: translateX(-50%) translateY(0); opacity: 1; }
}
#global-cart-flood-alert i { font-size: 1.8rem; }

</style>

</head>
<body>
  

  <!-- ВЕРХНИЙ ХЕДЕР — ТОЛЬКО НА ДЕСКТОПЕ -->
<header class="main-header desktop-only">
  <a href="/" class="logo">
    <img src="/static/assets/logo.png" alt="Piligrim" class="logo-img">
  </a>

  <nav class="desktop-nav">
    <a href="/" class="nav-link">Главная</a>
    <a href="/goods" class="nav-link">Товары</a>
    <a href="/services" class="nav-link">Услуги</a>
    <a href="/news" class="nav-link">Новости</a>
    <a href="/about_company" class="nav-link">О компании</a>
    <a href="/contacts" class="nav-link">Контакты</a>
  </nav>

  <div class="header-right">
    <div class="header-icons">
      <!-- Поиск -->
      <div class="search-wrapper">
        <div class="search-container">
          <div class="search-icon"><i class="fas fa-search"></i></div>
          <input type="text" class="search-input" id="searchInput" placeholder="Поиск...">
          <button id="searchClear" class="search-clear">×</button>
        </div>
        <div id="autocompleteList" class="autocomplete-list"></div>
      </div>

      <!-- Вход -->
      <button id="authBtn" class="icon-btn"><i class="fas fa-user"></i></button>

      <!-- Корзина — мини-дропдаун (как на contacts.html) -->
      <div class="cart-wrapper">
        <button class="icon-btn" id="cartBtn">
          <i class="fas fa-shopping-bag"></i>
          <span class="cart-count" id="cartCount">0</span>
        </button>

        <div id="miniCartDropdown" class="mini-cart-dropdown">
          <div class="mini-cart-header">
            <div class="mini-cart-title">Корзина</div>
          </div>
          <div class="mini-cart-items" id="miniCartItems">
            <div class="mini-cart-empty">Корзина пуста</div>
          </div>
          <div class="mini-cart-footer">
            <div class="mini-cart-total" id="miniCartTotal">Итого: 0 ₽</div>
            <button class="go-to-cart-btn" id="goToCartBtn">Оформить</button>
          </div>
        </div>
      </div>

      <!-- ПОДДЕРЖКА — ОДИН ID НА ВСЁМ САЙТЕ! -->
      <button class="icon-btn" id="feedbackBtn"><i class="fas fa-envelope"></i></button>
    </div>
  </div>
</header>

  <!-- НИЖНЯЯ ПАНЕЛЬ — ТОЛЬКО НА МОБИЛЬНЫХ -->
  <nav class="mobile-bottom-bar">
    <button class="bottom-bar-btn" id="mobileSearchBtn" data-label="Поиск">
      <i class="fas fa-search"></i>
    </button>

    <button class="bottom-bar-btn" id="mobileAuthBtn" data-label="Вход">
      <i class="fas fa-user"></i>
    </button>

    <button class="bottom-bar-btn active" id="openSidebarMenu" data-label="Меню">
      <i class="fas fa-bars"></i>
    </button>

    <button class="bottom-bar-btn" id="mobileCartBtn" data-label="Корзина">
      <i class="fas fa-shopping-bag"></i>
      <span class="cart-count" id="mobileCartCount">0</span>
    </button>

<button class="bottom-bar-btn" id="feedbackBtnMobile" data-label="Поддержка">
  <i class="fas fa-envelope"></i>
</button>
  </nav>

  <!-- МОБИЛЬНОЕ МЕНЮ — ШТОРКА СЛЕВА -->
  <div class="mobile-sidebar" id="mobileSidebar">
    <div class="sidebar-top">
      <button class="sidebar-close" id="closeSidebar" aria-label="Закрыть меню">
        <i class="fas fa-chevron-left"></i>
      </button>
      <img src="/static/assets/logo.png" alt="Piligrim" class="sidebar-logo-big">
    </div>

    <nav class="sidebar-nav-modern">
      <div class="nav-divider top"></div>
      
      <a href="/" class="sidebar-link-modern">Главная</a>
      <a href="/goods" class="sidebar-link-modern">Товары</a>
      <a href="/services" class="sidebar-link-modern">Услуги</a>
      <a href="/news" class="sidebar-link-modern">Новости</a>
      <a href="/about_company" class="sidebar-link-modern">О компании</a>
      <a href="/contacts" class="sidebar-link-modern">Контакты</a>
      <a href="/profile" class="sidebar-link-modern">Личный кабинет</a>
      
      <div class="nav-divider bottom"></div>
    </nav>

    <div class="sidebar-bottom-theme">
      <div class="sidebar-theme-toggle">
        <input type="checkbox" id="theme-toggle-sidebar" class="theme-toggle-input">
        <label for="theme-toggle-sidebar" class="theme-toggle-label">
          <i class="fas fa-moon"></i>
          <i class="fas fa-sun"></i>
        </label>
      </div>
    </div>
  </div>

  <!-- ПОЛНОЭКРАННЫЙ ПОИСК ДЛЯ ПЛАНШЕТОВ -->
  <div class="tablet-search-full" id="tabletSearchSheet">
    <div class="tablet-search-backdrop"></div>
    <div class="tablet-search-header-full">
      <button class="tablet-search-back" id="closeTabletSearch">
        <i class="fas fa-arrow-left"></i>
      </button>
      <div class="tablet-search-input-wrapper-full">
        <i class="fas fa-search"></i>
        <input type="text" id="tabletSearchInput" placeholder="Поиск по каталогу..." autocomplete="off">
        <button class="tablet-search-clear" id="tabletSearchClear">×</button>
      </div>
    </div>
    <div class="tablet-search-empty" id="tabletEmptyState">
      <i class="fas fa-search"></i>
      <p>Начните вводить запрос...</p>
    </div>
    <div id="tabletAutocompleteList" class="tablet-autocomplete-list-full"></div>
  </div>

<!-- НОВЫЙ МОБИЛЬНЫЙ ПОИСК — СВЕРХУ, КАК В WILDBERRIES 2025 -->
<div class="mobile-search-sheet" id="mobileSearchSheet">
  <div class="mobile-search-header">
    <div class="sheet-handle"></div>
    
    <button class="mobile-search-back" id="closeMobileSearchTop">←</button>
    
    <div class="mobile-search-input-wrapper">
      <i class="fas fa-search"></i>
      <input 
        type="text" 
        class="mobile-search-input" 
        id="mobileSearchInput" 
        placeholder="Поиск по каталогу..." 
        autocomplete="off"
      >
      <button class="mobile-search-clear" id="mobileSearchClear">×</button>
    </div>
  </div>
<!-- МОБИЛЬНЫЙ АДАПТИВНЫЙ АЛЕРТ (только ≤1026px) -->
<div id="mobileAlert" class="mobile-alert">
  <div class="mobile-alert-content">
    <div class="mobile-alert-icon">Warning</div>
    <div class="mobile-alert-message" id="mobileAlertMessage">Сообщение</div>
    <button class="mobile-alert-btn" id="mobileAlertClose">Понятно</button>
  </div>
</div>

  <!-- Результаты поиска -->
  <div class="mobile-search-results-content" id="mobileSearchResults">
    
    <!-- КРАСИВОЕ ПУСТОЕ СОСТОЯНИЕ — ЭТО ТО САМОЕ, ЧЕГО ТЕБЕ НЕ ХВАТАЛО -->
    <div class="search-empty-state" id="mobileEmptyState">
      <div class="empty-icon">
        <i class="fas fa-search"></i>
      </div>
      <div class="empty-title">Введите название товара</div>
      <div class="empty-subtitle">
        Например: iPhone 16, кроссовки Nike, кофеварка
      </div>
    </div>

    <!-- Сюда вставляются результаты автокомплита -->
    <div id="mobileAutocompleteList" class="mobile-autocomplete-list"></div>
  </div>
</div>

  <!-- МОБИЛЬНАЯ КОРЗИНА — SHEET -->
  <div class="mobile-cart-sheet" id="mobileCartSheet">
    <div class="sheet-backdrop" id="mobileCartBackdrop"></div>
    <div class="sheet-container">
      <div class="sheet-handle"></div>
      <div class="sheet-header">
        <div class="cart-header-icon">
          <i class="fas fa-shopping-bag"></i>
          <span class="cart-count" id="mobileCartHeaderCount">0</span>
        </div>
        <h3>Корзина</h3>
        <button class="sheet-close-btn" id="mobileCloseCart">×</button>
      </div>
      <div class="sheet-items" id="mobileMiniCartItems">
        <div style="padding:3rem 1.5rem;text-align:center;color:#888;">
          <i class="fas fa-shopping-bag" style="font-size:3rem;margin-bottom:1rem;opacity:0.3;"></i>
          <p>Корзина пуста</p>
        </div>
      </div>
      <div class="sheet-total">
        Итого: <strong id="mobileMiniCartTotal">0 ₽</strong>
      </div>
      <div class="sheet-footer">
        <button class="checkout-btn-full" id="mobileGoToCartBtn">
          Перейти к оформлению
        </button>
      </div>
    </div>
  </div>

  <!-- ВИСЯЩАЯ ЛАМПОЧКА — ОСТАЁТСЯ НА ВСЕХ СТРАНИЦАХ -->
  <div class="theme-toggle-hanging">
    <input type="checkbox" id="theme-toggle" class="theme-toggle-input">
    <label for="theme-toggle" class="theme-toggle-label">
      <div class="rope top"></div>
      <div class="bulb">
        <div class="bulb-light"></div>
        <div class="bulb-glow"></div>
      </div>
      <div class="rope bottom"></div>
    </label>
  </div>

<div id="floatingOrderBar" style="
  position: fixed;
  bottom: max(28px, env(safe-area-inset-bottom));
  left: 50%;
  transform: translateX(-50%);
  z-index: 97;
  pointer-events: none;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.45s cubic-bezier(0.22,1,0.36,1), transform 0.5s cubic-bezier(0.22,1,0.36,1);
  font-weight: 700;
  font-size: 15px;
  color: #ffffff;
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  backdrop-filter: none !important;
  padding: 0;
  border-radius: 0;
">
  <div id="multiOrderPill" style="
    cursor: pointer;
    background: var(--pill-bg, rgba(28,28,30,0.88));
    backdrop-filter: blur(32px);
    -webkit-backdrop-filter: blur(32px);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 28px;
    padding: 1rem 1.8rem;
    display: flex;
    align-items: center;
    gap: 1.2rem;
    box-shadow: 0 16px 40px rgba(0,0,0,0.24);
    transition: all 0.4s cubic-bezier(0.22,1,0.36,1);
    pointer-events: auto;
    max-width: calc(100vw - 40px);
    box-sizing: border-box;
  "
  onmouseover="this.style.transform='translateY(-8px)'; this.style.boxShadow='0 28px 56px rgba(0,0,0,0.38)'"
  onmouseout="this.style.transform=''; this.style.boxShadow='0 16px 40px rgba(0,0,0,0.24)'">

  <!-- Только грузовик. Число никогда не видно -->
<i class="fas fa-truck" style="font-size:1.9rem; flex-shrink:0;"></i>

<!-- Оставляем span только для JS, но он полностью скрыт и не мешает -->
<span id="activeOrdersBadge" style="position:absolute; left:-9999px; opacity:0; pointer-events:none;"></span>

    <!-- Текст -->
    <div style="flex:1; min-width:0;">
      <div style="font-weight:600; color:var(--text-primary); font-size:1.12rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
        <span id="pillMainText">Заказ №1423 в работе</span>
      </div>
      <div style="font-size:0.88rem; color:var(--text-secondary); margin-top:0.3rem; opacity:0.9;">
        <span id="pillSubText">Нажмите для подробностей</span>
      </div>
    </div>

    <i class="fas fa-chevron-up" style="font-size:1.4rem; color:var(--text-secondary);"></i>
  </div>
</div>

<!-- АНИМАЦИЯ ПОЯВЛЕНИЯ — ПРЯМО ЗДЕСЬ, ВНУТРИ БЛОКА -->
<style>
  @keyframes pillSlideUp {
    from {
      opacity: 0;
      transform: translateX(-50%) translateY(40px);
    }
    to {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  }
</style>


<!-- МОДАЛКА АКТИВНЫХ ЗАКАЗОВ — ОБНОВЛЁННЫЙ МИНИМАЛИСТИЧНЫЙ ДИЗАЙН 2025 -->
<div id="multiOrderModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.75); backdrop-filter:blur(32px); -webkit-backdrop-filter:blur(32px); z-index:9999; justify-content:center; align-items:center; padding:16px; box-sizing:border-box;">
  <div style="
    background:var(--modal-bg);
    backdrop-filter:blur(50px);
    border-radius:32px;
    width:100%; 
    max-width:720px; 
    max-height:94vh;
    overflow:hidden;
    box-shadow:0 32px 80px rgba(0,0,0,0.5);
    border:1px solid var(--modal-border);
    position:relative;
    display:flex;
    flex-direction:column;
  ">
    <!-- Граббер (iOS-style) -->
    <div style="height:56px; display:flex; align-items:center; justify-content:center; padding-top:env(safe-area-inset-top);">
      <div style="width:52px; height:6px; background:var(--grabber); border-radius:4px; opacity:0.4;"></div>
    </div>

    <!-- Заголовок — чуть компактнее и элегантнее -->
    <div style="padding:0 2rem 1.2rem; text-align:center;">
      <h2 style="margin:0; font-size:2.1rem; font-weight:800; color:var(--text-primary); letter-spacing:-0.8px;">
        Ваши заказы
      </h2>
      <p style="margin:0.6rem 0 0; color:var(--text-secondary); font-size:1.05rem; opacity:0.9;">
        <span id="activeOrdersCountText">Заказы</span> в обработке · Обновляется автоматически
      </p>
    </div>

    <!-- Список заказов — ПЛОТНЫЙ, КРАСИВЫЙ, СОВРЕМЕННЫЙ -->
    <div id="ordersVerticalList" style="
      flex:1;
      overflow-y:auto;
      padding:0 2rem 1rem;
      margin:0 -2rem;
      scrollbar-width:none;
      -webkit-overflow-scrolling:touch;
    ">
      <!-- JS будет вставлять сюда карточки -->
    </div>

    <!-- Кнопка "Закрыть" — тоньше и внизу прилипает -->
    <div style="padding:1rem 2rem 2rem; margin-top:auto; padding-bottom:calc(2rem + env(safe-area-inset-bottom));">
      <button type="button"
              onclick="closeMultiOrderModal()"
              style="
                width:100%; 
                background:var(--btn-bg); 
                color:var(--btn-fg);
                border:none; 
                padding:1.1rem; 
                border-radius:20px;
                font-size:1.15rem; 
                font-weight:600; 
                cursor:pointer;
                transition:all 0.35s cubic-bezier(0.22,0.61,0.36,1);
                backdrop-filter:blur(20px);
              "
              onmouseover="this.style.background='var(--btn-hover)'; this.style.transform='translateY(-2px)'"
              onmouseout="this.style.background='var(--btn-bg)'; this.style.transform=''">
        Закрыть
      </button>
    </div>
  </div>
</div>

<!-- ВЕРХНЯЯ ТЁМНАЯ ПОЛОСА + БЭКДРОП (ОБЯЗАТЕЛЬНО ДЛЯ feedback.js) -->
<div id="mobileFeedbackTop" style="display:none; position:fixed; top:0; left:0; right:0; height:140px; background:linear-gradient(to bottom, rgba(0,0,0,0.75), transparent); z-index:9997; pointer-events:none;"></div>

<!-- САМА ШТОРКА — СОВМЕСТИМА С ТВОИМ feedback.js + КРАСИВАЯ АНИМАЦИЯ -->
<div class="mobile-feedback-sheet" id="mobileFeedbackSheet">
  <!-- ХЕДЕР ШТОРКИ (как в iOS/Wildberries) -->
  <div class="sheet-header">
    <button class="sheet-back-btn" id="closeMobileFeedback">
      <i class="fas fa-chevron-left"></i>
    </button>
    <div class="sheet-title-wrapper">
      <i class="fas fa-envelope-open-text"></i>
      <h2>Обратная связь</h2>
    </div>
  </div>

  <!-- РУЧКА ДЛЯ ПАЛЬЦА (iOS стиль) -->
  <div class="sheet-handle"></div>

  <!-- ФОРМА (ЕДИНАЯ ДЛЯ ВСЕХ УСТРОЙСТВ) -->
  <form class="contact-form sheet-form" novalidate id="contactFormMobile">
    <!-- ИМЯ (уже заполнено из хедера) -->
    <div class="sheet-field">
      <label>Ваше имя</label>
      <input type="text" 
             class="name-input" 
             name="name" 
             placeholder="Ваше имя..." 
             required 
             autocomplete="name" />
    </div>

    <!-- ТЕЛЕФОН -->
    <div class="sheet-field phone-field-wrapper">
      <label>Телефон <span class="required">*</span></label>
      <input type="tel" 
             class="phone-input" 
             name="phone" 
             placeholder="+7 (___) ___-__-__" 
             pattern="\+7\s?\(\d{3}\)\s?\d{3}-\d{2}-\d{2}" 
             required />
    </div>

    <!-- EMAIL -->
    <div class="sheet-field">
      <label>Email <span class="required">*</span></label>
      <input type="email" 
             name="email" 
             placeholder="your@email.com" 
             required 
             autocomplete="email" />
    </div>

    <!-- СООБЩЕНИЕ -->
    <div class="sheet-field">
      <label>Сообщение <span class="required">*</span></label>
      <textarea name="message" 
                placeholder="Опишите ваш вопрос или предложение..." 
                rows="4" 
                required></textarea>
    </div>

    <!-- КНОПКА ОТПРАВКИ -->
    <button type="submit" class="sheet-submit-btn" id="submitBtnMobile">
      <span class="btn-text">Отправить заявку</span>
      <span class="btn-loading">
        <i class="fas fa-spinner fa-spin"></i>
      </span>
      <span class="btn-cooldown" style="display:none;">
        <span class="timer">30</span>с
      </span>
    </button>
  </form>
</div>
  <!-- КОНТЕНТ КОРЗИНЫ -->
<main>
  <!-- ПК-версия (остаётся как было) -->
  <div class="desktop-cart-left">
    <h1 class="page-title">Корзина</h1>
    <div id="cartItemsList" class="cart-items-desktop"></div>
    <div class="pagination" id="pagination" style="display:none;justify-content:center;margin-top:3rem;gap:1rem;"></div>
  </div>

  <div class="checkout-sidebar desktop-only">
    <h3 class="checkout-title">Итого</h3>
    <div class="summary-row"><span>Товаров:</span><strong id="summaryCount">0</strong></div>
    <div class="summary-row total"><span>К оплате:</span><strong id="summaryTotal">0 ₽</strong></div>
    <button class="checkout-btn" id="checkoutBtn" disabled>Оформить заказ</button>
    <button class="archive-btn" id="openArchiveBtn"><i class="fas fa-history"></i> Архив заказов</button>
  </div>

  <!-- МОБИЛЬНАЯ ВЕРСИЯ — ПРАВИЛЬНЫЙ ПОРЯДОК 2025 -->
  <div class="mobile-cart-layout">
    <header class="mobile-cart-header" style="border-bottom:none !important; box-shadow:none !important;">
  <h1 class="page-title">Корзина</h1>
  <button class="archive-btn-mobile" id="openArchiveBtn">
    <i class="fas fa-history"></i>
  </button>
</header>

    <!-- 1. БЛОК ИТОГО С ЛИНИЯМИ — СНАЧАЛА! -->
    <div class="mobile-summary-minimal">

      <div class="summary-content">
        <div class="summary-row"><span>Товаров:</span> <strong id="summaryCount">0</strong></div>
        <div class="summary-row total"><span>К оплате:</span> <strong id="summaryTotal">0 ₽</strong></div>
      </div>

    </div>

    <!-- 2. ТОВАРЫ — ПОД ИТОГОМ -->
    <div id="cartItemsList" class="cart-items-mobile"></div>

    <!-- 3. ПРИЛИПАЮЩАЯ КНОПКА — ВСЕГДА СНИЗУ -->
   <button class="checkout-btn-fixed" id="mobileCheckoutBtn" disabled>Оформить заказ</button>
  </div>
</main>
  <!-- МОДАЛКА АВТОРИЗАЦИИ  -->
<div id="authModal" class="auth-modal">
  <div class="auth-modal-content">
    <button class="close-modal" id="closeAuthModal">×</button>
    <h2 class="auth-title">Вход по номеру<br><span class="mobile-only">телефона</span></h2>

    <!-- ШАГ 1 — ВВОД НОМЕРА -->
    <div id="stepPhone" class="auth-step">
      <div class="country-selector">
        <div class="selected-country" id="selectedCountry">
          <span class="flag">RU</span>
          <span class="code">+7</span>
          <i class="fas fa-chevron-down"></i>
        </div>
        <div class="country-dropdown" id="countryDropdown">
          <div class="country-item" data-code="+7" data-flag="RU">Россия +7</div>
          <div class="country-item" data-code="+1" data-flag="US">USA +1</div>
          <div class="country-item" data-code="+44" data-flag="GB">UK +44</div>
        </div>
      </div>
      
      <input type="text" 
       name="honeypot" 
       id="honeypot" 
       tabindex="-1" 
       autocomplete="off" 
       style="position:absolute; left:-9999px; opacity:0; height:0; width:0; border:none; padding:0; margin:0;"
       aria-hidden="true">

<input type="hidden" name="fp_token" id="fp_token" value="">
      <input type="tel" id="phoneInput" placeholder="(999) 999 99 99" class="auth-input">

      <label class="checkbox-label required">
        <input type="checkbox" id="privacyCheck">
        <span class="custom-checkbox"></span>
        Согласен с <a href="/policy" target="_blank" class="privacy-link">политикой конфиденциальности</a>
      </label>

      <label class="checkbox-label">
        <input type="checkbox" id="subscribeCheck" checked>
        <span class="custom-checkbox"></span>
        Получать SMS с акциями и уведомлениями
      </label>

      <button id="sendCodeBtn" class="auth-btn" disabled>Получить код</button>
    </div>

    <!-- ШАГ 2 — ВВОД КОДА -->
    <div id="stepCode" class="auth-step" style="display:none;">
      <p class="auth-info">Код отправлен на <span id="maskedPhone"></span></p>
      <input type="text" id="codeInput" placeholder="____" maxlength="4" class="auth-input">
      <button id="verifyCodeBtn" class="auth-btn">Войти</button>
      <button id="resendCode" class="auth-link">Отправить повторно</button>
    </div>

    <!-- ШАГ 3 — УСПЕШНЫЙ ВХОД -->
    <div id="stepSuccess" class="auth-step" style="display:none;">
      <i class="fas fa-check-circle success-icon"></i>
      <h3>Добро пожаловаться!</h3>
      <p>Вы успешно вошли как <span id="welcomePhone"></span></p>
      <button id="closeSuccess" class="auth-btn">Продолжить</button>
    </div>
  </div>
</div>

<!-- МОДАЛКА ОБРАТНОЙ СВЯЗИ -->
  <div class="custom-alert" id="feedbackModal">
    <div class="alert-content">
      <button class="alert-close" id="closeFeedback">×</button>

      <div class="alert-icon">
        <i class="fas fa-envelope-open-text"></i>
      </div>

      <div class="alert-text">
        <strong>Обратная связь</strong>
        <span>Оставьте заявку — мы свяжемся с вами в ближайшее время</span>
      </div>

      <form class="contact-form" novalidate id="contactForm">
        <input type="text" placeholder="Ваше имя" name="name" required />
        
        <div class="phone-field-wrapper">
          <input type="tel" placeholder="+7 (___) ___-__-__" name="phone" pattern="\+7\s?\(\d{3}\)\s?\d{3}-\d{2}-\d{2}" required />

        </div>
        
        <input type="email" placeholder="Email" name="email" required />
        <textarea placeholder="Ваше сообщение" name="message" required></textarea>

        <button type="submit" id="submitBtn" class="alert-login-btn">
          <span class="btn-text">Отправить сообщение</span>
          <span class="btn-cooldown">Отправка... <span class="timer">30</span>с</span>
        </button>
      </form>
    </div>
  </div>


<!-- МОДАЛКА ОФОРМЛЕНИЯ ЗАКАЗА -->
<div id="checkoutModal" class="modal" style="display:none;">
  <div class="checkout-modal-beauty">
    <button class="close-modal" id="closeCheckout">×</button>

    <div class="checkout-header">
      <div class="checkout-icon">
        <i class="fas fa-shopping-bag"></i>
      </div>
      <h2>Оформление заказа</h2>
      <p>Осталось только подтвердить</p>
    </div>

    <div class="checkout-summary">
      <div class="summary-item">
        <span>Товаров в корзине</span>
        <strong id="checkoutCount">0</strong>
      </div>
      <div class="summary-item total">
        <span>К оплате</span>
        <strong id="checkoutTotal">0 ₽</strong>
      </div>
    </div>

    <form id="checkoutForm" class="checkout-form">
      <div class="input-group">
        <i class="fas fa-user"></i>
        <input type="text" id="fullName" placeholder="ФИО полностью" required autocomplete="name">
      </div>

      <!-- Номер телефона — если авторизован -->
      <div id="checkoutPhonePremium" class="phone-premium" style="display:none;">
        <div class="phone-premium-inner">
          <i class="fas fa-check-circle"></i>
          <div>
            <small>Вы вошли как</small>
            <div id="checkoutPhoneFormatted" class="phone-number-big"></div>
          </div>
        </div>
      </div>

      <!-- Ручной ввод номера — если вдруг не авторизован -->
      <div class="input-group" id="checkoutPhoneManual" style="display:none;">
        <i class="fas fa-phone"></i>
        <input type="tel" id="checkoutPhone" placeholder="+7 (999) 999-99-99" required autocomplete="tel">
      </div>

      <button type="submit" id="confirmOrderBtn" class="confirm-beauty-btn" form="checkoutForm">
  <span class="btn-text">Подтвердить заказ</span>
  <span class="btn-loader" style="display:none;">
    <i class="fas fa-spinner fa-spin"></i> Оформляем...
  </span>
</button>
    </form>

    <div class="checkout-footer">
      <small>Нажимая кнопку, вы соглашаетесь с <a href="/policy" target="_blank">политикой конфиденциальности</a></small>
    </div>
  </div>
</div>

<!-- МОДАЛКА ОТЗЫВОВ — АДАПТИВНАЯ 2025 (ПК + МОБИЛКА) -->
<div id="reviewModal" class="modal review-modal-mobile" style="display:none;">
  <div class="review-modal-apple">
    <button class="close-modal" id="closeReview">×</button>

    <div class="review-header-apple">
      <h2>Оцените покупку</h2>
      <p id="reviewItemName">Товар</p>
    </div>

    <!-- Звёзды — крупные и удобные для тача -->
    <div class="review-stars-apple" id="reviewStars">
      <i class="far fa-star" data-value="1"></i>
      <i class="far fa-star" data-value="2"></i>
      <i class="far fa-star" data-value="3"></i>
      <i class="far fa-star" data-value="4"></i>
      <i class="far fa-star" data-value="5"></i>
    </div>

    <!-- Текстовое поле — растягивается по высоте -->
    <textarea 
      id="reviewText" 
      placeholder="Поделитесь впечатлениями (по желанию)" 
      class="review-textarea-apple"
      rows="4"></textarea>

    <div class="review-buttons-apple">
      <button id="submitReview" class="review-btn-primary">Отправить</button>
      <button id="skipReview" class="review-btn-secondary">Пропустить</button>
    </div>
  </div>
</div>

<!-- КАРТОЧКА ТОВАРА  -->
<div class="product-modal" id="productModal">
  <div class="product-content">
    <!-- Крестик закрытия -->
    <button class="close-modal" onclick="closeProductModal()">
      <svg width="28" height="28" viewBox="0 0 28 28" fill="none">
        <path d="M6 6L22 22M6 22L22 6" stroke="currentColor" stroke-width="2.3" stroke-linecap="round"/>
      </svg>
    </button>

    <!-- Основной контейнер -->
    <div class="product-main">
      <img id="productImg" class="product-img" src="/static/assets/no-image.png" alt="Товар">

      <div class="product-info">
        <h3 id="productTitle" class="product-title">Загрузка...</h3>

        <div id="productStockInfo" 
     style="margin: 12px 0 8px; 
            font-size: 1rem; 
            font-weight: 600; 
            line-height: 1.4;">
</div>

        <!-- Рейтинг и отзывы -->
        <div class="product-rating">
          <div class="stars"></div>
          <span id="productReviewsCount" class="reviews-count">—</span>
        </div>

        <div id="productPrice" class="product-price">—</div>

        <div id="productDescription" class="product-description">Загрузка описания...</div>

        <!-- Кнопка "В корзину" -->
        <button id="addToCartModal" class="add-to-cart-btn">
          <i class="fas fa-shopping-cart"></i> В корзину
        </button>

        <!-- ОТЗЫВЫ — ТОЧНО КАК В НОВОСТЯХ -->
        <div class="product-reviews">
          <h4 class="reviews-title">Отзывы покупателей</h4>
          <div class="reviews-list" id="productReviewsList">
            <div style="text-align:center;padding:3rem;color:#888;">
              <i class="far fa-star" style="font-size:3rem;margin-bottom:1rem;display:block;opacity:0.6;"></i>
              <p>Отзывов пока нет</p>
              <small style="opacity:0.7;">Будьте первым!</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- АРХИВ ЗАКАЗОВ  -->
<div id="archiveModal" class="smart-archive">
  <div class="smart-sheet">

    <!-- Граббер только на мобильных -->
    <div class="grabber"></div>

    <!-- Крестик только на десктопе -->
    <button class="close-btn desktop-only" id="closeArchive">×</button>

    <div class="smart-header-fixed">
      <h2 class="smart-title">Мои заказы</h2>

      <!-- Табы — фиксированные -->
<div class="smart-tabs">
  <button class="tab-btn active" data-tab="active">
    Активные
  </button>
  <button class="tab-btn" data-tab="completed">
    Отмененные
  </button>
  <button class="tab-btn" data-tab="all">
    Все заказы
  </button>
</div>

      <!-- Поиск — тоже фиксированный, всегда под табами -->
      <div class="smart-search">
        <i class="fas fa-magnifying-glass"></i>
        <input type="text" id="orderSearch" placeholder="Поиск по номеру или товару...">
      </div>
    </div>

    <!-- Список заказов — теперь в отдельном скролле -->
    <div class="smart-list-container">
      <div id="ordersList" class="smart-list"></div>

      <div id="loadMoreContainer" class="smart-more">
        <button id="loadMoreBtn">Показать ещё</button>
      </div>

      <div class="smart-empty" id="emptyActive">
        <i class="fas fa-receipt" style="font-size:72px;margin-bottom:16px;opacity:0.3;"></i>
        <h3>Нет заказов</h3>
        <p>Здесь появятся ваши заказы</p>
      </div>
    </div>

  </div>
</div>

<!-- МОДАЛКА ОТМЕНЫ ЗАКАЗА -->

<div id="cancelOrderModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.88); backdrop-filter:blur(32px); z-index:99999; justify-content:center; align-items:center; padding:16px;">
  <div class="cancel-modal-inner">
    
    <!-- Граббер как в iOS -->
    <div class="ios-grabber"></div>
    
    <div class="cancel-modal-icon">
      <i class="fas fa-times-circle"></i>
    </div>

    <h2 class="cancel-modal-title">Отменить заказ?</h2>
    <p class="cancel-modal-text">
      Заказ №<strong id="cancelModalOrderId">000</strong> будет отменён.<br>
      Это действие нельзя будет отменить.
    </p>

    <textarea id="cancelReasonInput" placeholder="Обязательно укажите причину отмены..." 
              class="cancel-modal-textarea" required></textarea>

    <div class="cancel-modal-buttons">
      <button id="confirmCancelFinalBtn" class="cancel-btn-danger">
        Отменить заказ
      </button>
      <button onclick="document.getElementById('cancelOrderModal').style.display='none'" class="cancel-btn-secondary">
        Не отменять
      </button>
    </div>
  </div>
</div>
<!-- МОДАЛКА "АВТОРИЗУЙТЕСЬ" ПЕРЕД ОТПРАВКОЙ ФИДБЕКА -->
<div class="custom-alert" id="authAlert">
  <div class="alert-content">
    <button class="alert-close">×</button>
    <div class="alert-icon">
      <i class="fas fa-user-lock"></i>
    </div>
    <div class="alert-text">
      <strong>Авторизуйтесь</strong>
      <span>Для отправки сообщения нужно войти в аккаунт</span>
    </div>
    <button class="alert-login-btn" id="authBtnFeedback">Войти</button>
  </div>
</div>

  <!-- СКРИПТЫ -->
   <script src="/static/js/cart.js" defer></script>
  <script src="/static/js/search.js"></script>
  <script src="/static/js/auth.js"></script>     
  <script src="/static/js/feedback.js"></script>
  <script src="/static/js/contacts.js" defer></script>
  <script src="/static/js/ai.js"></script>
  <script src="/static/js/bin.js"></script>
  <script src="/static/js/cartt.js"></script>


<style>
@keyframes modalPop {
  from { transform:scale(0.9); opacity:0; }
  to { transform:scale(1); opacity:1; }
}
#multiOrderModal.show { animation:modalPop 0.5s cubic-bezier(0.22,0.61,0.36,1); }
#ordersCarousel::-webkit-scrollbar { display:none; }
</style>


<script>
const sidebar = document.getElementById('mobileSidebar');
if (sidebar) {
  let startX = 0, isDragging = false;
  const threshold = 80;

  const close = () => {
    sidebar.classList.remove('open');
    document.body.classList.remove('sidebar-open');
  };

  const handleStart = e => {
    if (!sidebar.classList.contains('open')) return;
    startX = e.touches?.[0].clientX || e.clientX;
    isDragging = true;
    sidebar.style.transition = 'none';
  };

  const handleMove = e => {
    if (!isDragging) return;
    const x = e.touches?.[0].clientX || e.clientX;
    const diff = x - startX;
    if (diff < 0) {
      e.preventDefault();
      sidebar.style.transform = `translateX(${diff}px)`;
    }
  };

  const handleEnd = e => {
    if (!isDragging) return;
    isDragging = false;
    const currentX = e.changedTouches?.[0]?.clientX || e.clientX || startX;
    const diff = currentX - startX;

    if (diff < -threshold) {
      sidebar.style.transition = 'transform 0.44s cubic-bezier(0.22, 1, 0.36, 1)';
      sidebar.style.transform = 'translateX(-100%)';
      setTimeout(() => {
        close();
        sidebar.style.transition = '';
        sidebar.style.transform = '';
      }, 450);
    } else {
      sidebar.style.transition = 'transform 0.38s cubic-bezier(0.2, 0.9, 0.3, 1)';
      sidebar.style.transform = 'translateX(0)';
      setTimeout(() => sidebar.style.transition = '', 380);
    }
  };

  document.getElementById('openSidebarMenu')?.addEventListener('click', () => {
    sidebar.classList.add('open');
    document.body.classList.add('sidebar-open');
  });

  document.getElementById('closeSidebar')?.addEventListener('click', close);

  document.addEventListener('touchstart', handleStart, { passive: true });
  document.addEventListener('touchmove', handleMove, { passive: false });
  document.addEventListener('touchend', handleEnd);

  document.addEventListener('click', e => {
    if (sidebar.classList.contains('open') && 
        !e.target.closest('#mobileSidebar') && 
        !e.target.closest('#openSidebarMenu')) {
      close();
    }
  });
}
</script>

<script defer>
// === ОБРАТНАЯ СВЯЗЬ — ПОЛНАЯ БЛОКИРОВКА БЕЗ АВТОРИЗАЦИИ (ПК + МОБИЛКА) ===
document.addEventListener("DOMContentLoaded", () => {

  const isAuthenticated = () => !!(sessionStorage.getItem('phone') || localStorage.getItem('phone'));

  // Тост-алерт (один раз)
  if (!window.showCustomAlert) {
    window.showCustomAlert = (text, isError = true) => {
      document.querySelectorAll('.toast-alert').forEach(t => t.remove());
      const toast = document.createElement('div');
      toast.className = `toast-alert ${isError ? 'error' : ''}`;
      toast.innerHTML = `
        <div class="alert-text">
          <strong>${isError ? 'Ошибка' : 'Успех'}</strong>
          <span>${text}</span>
        </div>
        <button class="alert-close">×</button>
      `;
      document.body.appendChild(toast);
      requestAnimationFrame(() => toast.classList.add('show'));
      toast.querySelector('.alert-close').onclick = () => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 500);
      };
      setTimeout(() => toast.isConnected && toast.classList.remove('show') && setTimeout(() => toast.remove(), 500), 5000);
    };
  }

  // === УДАЛЯЕМ ВСЕ СТАРЫЕ ОБРАБОТЧИКИ НА КНОПКАХ ===
  ['#feedbackBtn', '#feedbackBtnMobile'].forEach(selector => {
    document.querySelectorAll(selector).forEach(btn => {
      const newBtn = btn.cloneNode(true);
      btn.replaceWith(newBtn);
    });
  });

  // === ДЕСКТОПНАЯ КНОПКА (ПК) ===
  document.getElementById('feedbackBtn')?.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation();

    if (!isAuthenticated()) {
      showCustomAlert('Войдите в аккаунт', true);
      return;
    }

    // ТОЛЬКО если это ПК — открываем десктопную модалку
    if (window.innerWidth > 1024) {
      const modal = document.getElementById('feedbackModal');
      modal.classList.add('show');
      document.body.style.overflow = 'hidden';

      // Подставляем телефон
      const phone = sessionStorage.getItem('phone') || localStorage.getItem('phone');
      if (phone) {
        const clean = phone.replace(/\D/g, '');
        const formatted = clean.length === 11 
          ? `+7 (${clean.slice(1,4)}) ${clean.slice(4,7)}-${clean.slice(7,9)}-${clean.slice(9)}`
          : phone;
        const input = modal.querySelector('input[type="tel"]');
        if (input) input.value = formatted;

      }
    }
  });

  // === МОБИЛЬНАЯ КНОПКА ===
 // === МОБИЛЬНАЯ КНОПКА ПОДДЕРЖКИ — ПРАВИЛЬНЫЙ АЛЕРТ, КАК НА ДЕСКТОПЕ ===
document.getElementById('feedbackBtnMobile')?.addEventListener('click', function(e) {
  e.preventDefault();
  e.stopPropagation();

  if (!isAuthenticated()) {
    // ←←← ВОТ ТУТ БЫЛ ТОСТ, А ДОЛЖЕН БЫТЬ КРАСИВЫЙ АЛЕРТ
    const authAlert = document.getElementById('authAlert');
    authAlert.classList.add('show');
    document.body.style.overflow = 'hidden';

    // Кнопка "Войти" в алерте открывает модалку авторизации
    document.getElementById('authBtnFeedback')?.addEventListener('click', () => {
      authAlert.classList.remove('show');
      document.body.style.overflow = '';
      document.getElementById('authModal').style.display = 'flex';
    });

    // Закрытие алерта
    authAlert.querySelector('.alert-close')?.addEventListener('click', () => {
      authAlert.classList.remove('show');
      document.body.style.overflow = '';
    });

    // Клик вне контента — закрыть
    authAlert.addEventListener('click', (ev) => {
      if (ev.target === authAlert) {
        authAlert.classList.remove('show');
        document.body.style.overflow = '';
      }
    });

    return;
  }

  // Если авторизован — открываем мобильную шторку обратной связи
  const sheet = document.getElementById('mobileFeedbackSheet');
  sheet.classList.add('active');
  document.body.style.overflow = 'hidden';

  // Автозаполнение телефона
  const phone = sessionStorage.getItem('phone') || localStorage.getItem('phone');
  if (phone) {
    const clean = phone.replace(/\D/g, '');
    const formatted = clean.length === 11 
      ? `+7 (${clean.slice(1,4)}) ${clean.slice(4,7)}-${clean.slice(7,9)}-${clean.slice(9)}`
      : phone;
    const input = sheet.querySelector('input[type="tel"]');
    if (input) input.value = formatted;
  }
});

  // === ЗАКРЫТИЕ МОДАЛОК (чтобы не было конфликтов) ===
  document.getElementById('closeFeedback')?.addEventListener('click', () => {
    document.getElementById('feedbackModal').classList.remove('show');
    document.body.style.overflow = '';
  });

  document.getElementById('feedbackModal')?.addEventListener('click', e => {
    if (e.target === document.getElementById('feedbackModal')) {
      document.getElementById('feedbackModal').classList.remove('show');
      document.body.style.overflow = '';
    }
  });

  // Мобильная шторка — закрытие
  document.querySelectorAll('#closeMobileFeedback, .sheet-back-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.getElementById('mobileFeedbackSheet').classList.remove('active');
      document.body.style.overflow = '';
    });
  });
});
</script>
<script>
  // statuschain.js — ФИНАЛЬНАЯ ВЕРСИЯ 2025 — ИДЕАЛЬНЫЙ APPLE UI



let pollInterval = null;

function dispatchOrderStatusChange(orderId, status, isFinal = false) {
    document.dispatchEvent(new CustomEvent('orderStatusChanged', { detail: { orderId, status, isFinal } }));
}

function createStatusIcon(type) {
    const size = 64;
    const canvas = document.createElement('canvas');
    canvas.width = size;
    canvas.height = size;
    const ctx = canvas.getContext('2d');

    ctx.fillStyle = '#2a2a2a';
    ctx.fillRect(0, 0, size, size);
    ctx.lineWidth = 4.5;
    ctx.strokeStyle = '#fff';

    switch (type) {
        case 'pending': ctx.beginPath(); ctx.arc(32, 32, 20, 0, Math.PI*2); ctx.stroke(); ctx.beginPath(); ctx.moveTo(32, 32); ctx.lineTo(32, 17); ctx.stroke(); break;
        case 'processing':
            const t = 8;
            for (let i = 0; i < t; i++) {
                const a = (i / t) * Math.PI * 2;
                const x1 = 32 + 19 * Math.cos(a), y1 = 32 + 19 * Math.sin(a);
                const x2 = 32 + 24 * Math.cos(a), y2 = 32 + 24 * Math.sin(a);
                if (i === 0) ctx.moveTo(x2, y2); else ctx.lineTo(x2, y2); ctx.lineTo(x1, y1);
            }
            ctx.closePath(); ctx.stroke();
            ctx.beginPath(); ctx.arc(32, 32, 10, 0, Math.PI*2); ctx.stroke();
            break;
        case 'shipping':
            ctx.fillStyle = '#fff'; ctx.fillRect(16, 26, 32, 16); ctx.fillRect(40, 22, 12, 20);
            ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(24, 44, 6, 0, Math.PI*2); ctx.arc(40, 44, 6, 0, Math.PI*2); ctx.fill();
            break;
        case 'completed':
            ctx.beginPath(); ctx.moveTo(18, 32); ctx.lineTo(26, 40); ctx.lineTo(46, 20); ctx.lineWidth = 6.5; ctx.stroke();
            break;
        case 'cancelled':
            ctx.beginPath(); ctx.moveTo(20, 20); ctx.lineTo(44, 44); ctx.moveTo(44, 20); ctx.lineTo(20, 44);
            ctx.lineWidth = 6.5; ctx.strokeStyle = '#ff6b6b'; ctx.stroke();
            break;
    }
    return canvas.toDataURL();
}
window.startOrderChain = async function(orderId) {
    if (pollInterval) clearInterval(pollInterval);

    const chain = document.getElementById('orderChain');
    if (!chain) return;

    let statusBar = chain.querySelector('.order-status-mini');
    if (!statusBar) {
        statusBar = document.createElement('div');
        statusBar.className = 'order-status-mini';
        chain.appendChild(statusBar);
    }

    chain.style.display = 'block';

    // Кешируем элементы один раз
    let orderIdEl, totalEl, statusEl, fillEl, icons, itemsMini, cancelBtn;

    const poll = async () => {
    const isLight = document.documentElement.getAttribute('data-theme') === 'light';
    const isMobile = window.innerWidth <= 1026;

    try {
        const res = await fetch(`/api/order_status/${orderId}`);
        if (!res.ok) return;
        const data = await res.json();
        if (!data.status) return;

        const currentStep = ['pending','processing','shipping','completed'].indexOf(data.status);
        const isFinal = ['completed', 'cancelled'].includes(data.status);
        const progressWidth = currentStep > 0 ? (currentStep * 33.33 - 6) + '%' : '0%';

        dispatchOrderStatusChange(orderId, data.status, isFinal);

        // === ПЕРВЫЙ РАЗ — СОЗДАЁМ РАЗМЕТКУ БЕЗ ПЕРЕМЕННЫХ В СТИЛЯХ ===
        if (!statusBar.dataset.ready) {
            statusBar.innerHTML = `
<style>
    @keyframes fill-progress { from { width: 0%; } to { width: var(--progress); } }
    @keyframes pulse-glow-light { 0%,100%{box-shadow:0 0 0 0 transparent} 50%{box-shadow:0 0 20px 8px rgba(0,0,0,.25)} }
    @keyframes pulse-glow-dark  { 0%,100%{box-shadow:0 0 0 0 transparent} 50%{box-shadow:0 0 20px 8px rgba(255,255,255,.4)} }

    .order-status-mini { padding:20px; font-family:-apple-system; font-size:14px; background:var(--bg); border-top:1px solid var(--border); }
    .order-id { font-size:19px; font-weight:600; color:var(--text); }
    .mini-total { font-size:18px; font-weight:600; color:var(--muted); }
    .current-status { font-size:${isMobile?'16px':'22px'}; font-weight:700; color:var(--text); text-align:center; margin:12px 0; }
    .progress-row { display:flex; justify-content:space-between; align-items:center; position:relative; height:44px; padding:0 ${isMobile?'10px':'20px'}; }
    .progress-line { position:absolute; top:50%; left:${isMobile?'32px':'40px'}; right:${isMobile?'32px':'40px'}; height:2px; background:var(--line); border-radius:2px; z-index:1; }
    .progress-fill { position:absolute; top:50%; left:${isMobile?'32px':'40px'}; height:2px; background:var(--text); width:0%; animation:fill-progress 1.4s cubic-bezier(0.16,1,0.3,1) forwards; border-radius:2px; z-index:2; }
    .step-icon { width:44px; height:44px; border-radius:50%; background:var(--text); color:${isLight?'#fff':'#000'}; display:flex; align-items:center; justify-content:center; font-size:22px; z-index:3; transition:all .4s; }
    .step-icon.active { animation:var(--pulse) 3s infinite ease-in-out; }
    .items-mini { 
    display: flex; 
    gap: 12px; 
    padding: 20px 20px 20px calc(50% - 45px); /* ← магия центрирования */
    overflow-x: auto; 
    scrollbar-width: none;
    scroll-snap-type: x mandatory;
}
.items-mini > * { scroll-snap-align: center; flex-shrink: 0; }
    .item-img { width:90px; height:90px; border-radius:20px; object-fit:cover; box-shadow:0 6px 20px rgba(0,0,0,${isLight?'0.12':'0.45'}); }
</style>

<div class="mini-header"><div class="order-id"></div><div class="mini-total"></div></div>
<div class="status-block">
    <div class="current-status"></div>
    <div class="progress-row">
        <div class="progress-line"></div>
        <div class="progress-fill"></div>
        <div class="step-icon"><i class="fa-solid fa-credit-card"></i></div>
        <div class="step-icon"><i class="fa-regular fa-clock"></i></div>
        <div class="step-icon"><i class="fa-solid fa-truck-fast"></i></div>
        <div class="step-icon"><i class="fa-solid fa-check"></i></div>
    </div>
</div>
<div class="items-mini"></div>
<div class="cancel-wrapper" style="margin-top:18px;text-align:center"></div>
            `;

            // Кешируем элементы
            orderIdEl = statusBar.querySelector('.order-id');
            totalEl = statusBar.querySelector('.mini-total');
            statusEl = statusBar.querySelector('.current-status');
            fillEl = statusBar.querySelector('.progress-fill');
            icons = statusBar.querySelectorAll('.step-icon');
            itemsMini = statusBar.querySelector('.items-mini');
            cancelBtn = statusBar.querySelector('.cancel-wrapper');

            statusBar.dataset.ready = "yes";
        }

        // === ДАЛЕЕ — ТОЛЬКО ОБНОВЛЕНИЕ ДАННЫХ ===
        const prevStep = parseInt(statusBar.dataset.step || -1);

        // Обновляем CSS-переменные
        statusBar.style.setProperty('--bg', isLight ? '#f2f2f7' : '#111');
        statusBar.style.setProperty('--border', isLight ? '#ddd' : '#333');
        statusBar.style.setProperty('--text', isLight ? '#000' : '#fff');
        statusBar.style.setProperty('--muted', isLight ? '#666' : '#888');
        statusBar.style.setProperty('--line', isLight ? '#ddd' : '#444');
        statusBar.style.setProperty('--progress', progressWidth);
        statusBar.style.setProperty('--pulse', isLight ? 'pulse-glow-light' : 'pulse-glow-dark');

        // Только если статус изменился — анимируем прогресс и иконки
        if (currentStep !== prevStep) {
            statusBar.dataset.step = currentStep;
            statusEl.textContent = ['Ожидает оплаты','Собираем заказ','В доставке','Доставлено'][currentStep] || 'Ожидает';
            icons.forEach((icon, i) => {
                icon.classList.toggle('done', i < currentStep);
                icon.classList.toggle('active', i === currentStep);
            });
        }

        // Всегда обновляем (могут меняться)
        orderIdEl.textContent = data.display_id ? (data.display_id.startsWith('№') ? data.display_id : `№${data.display_id}`) : '№0000';
        totalEl.textContent = data.total_str || '';

        const visible = (data.items || []).slice(0,8);
        const hasMore = data.items?.length > 8;
                // === ТОВАРЫ — БЕЗ МИГАНИЯ И БЕЗ ОШИБОК ===
        const currentItemsKey = data.items?.map(i => `${i.image_url || ''}|${i.title}|${i.quantity}`).join(';;') || '';

        // Если товары не менялись — вообще ничего не трогаем
        if (statusBar.dataset.lastItemsKey === currentItemsKey && statusBar.dataset.itemsRendered) {
            // ничего не делаем — картинки остаются на месте
        } else {
            const visible = (data.items || []).slice(0, 8);
            const hasMore = data.items?.length > 8;

            itemsMini.innerHTML = visible.map(item => `
                <div class="item-mini">
                    <img src="${item.image_url || '/static/assets/no-image.png'}" class="item-img"
                         onerror="this.src='/static/assets/no-image.png'">
                    <div class="item-title">${item.title}</div>
                    <div class="item-details"><span>${item.quantity}×</span>${item.price_str || ''}</div>
                </div>
            `).join('') + (hasMore ? `
                <div class="item-mini" style="display:flex;align-items:center;justify-content:center;width:90px;">
                    <div style="font-size:22px;font-weight:900;color:var(--muted)">+${data.items.length-8}</div>
                </div>
            ` : '');

            statusBar.dataset.lastItemsKey = currentItemsKey;
            statusBar.dataset.itemsRendered = "yes";
        }

        cancelBtn.innerHTML = data.can_cancel && !isFinal ? `
            <button onclick="cancelOrder(${orderId})" style="padding:10px 24px;background:transparent;color:#ff3b30;border:2px solid #ff3b30;border-radius:16px;font-size:14.5px;font-weight:700;cursor:pointer;">
                Отменить заказ
            </button>` : '';

        if (isFinal) {
            clearInterval(pollInterval);
            pollInterval = null;
            setTimeout(() => {
                statusBar.style.opacity = '0';
                setTimeout(() => chain.style.display = 'none', 600);
            }, 7000);
        }

    } catch (e) { console.error(e); }
};

    poll();
    pollInterval = setInterval(poll, 3000);
};

// Остальное без изменений
window.cancelOrder = function(orderId) {
    document.getElementById('cancelModalOrderId').textContent = orderId;
    document.getElementById('cancelReasonInput').value = '';
    document.getElementById('cancelOrderModal').style.display = 'flex';
    setTimeout(() => document.getElementById('cancelReasonInput').focus(), 300);
};

document.getElementById('cancelOrderModal')?.addEventListener('click', e => e.target === this && (this.style.display = 'none'));

document.getElementById('confirmCancelFinalBtn')?.addEventListener('click', async function(e) {
    e.stopPropagation();
    const reason = document.getElementById('cancelReasonInput').value.trim();
    const orderId = parseInt(document.getElementById('cancelModalOrderId').textContent, 10);

    if (!reason || reason.length < 5) {
        if (window.reliableToast) reliableToast('Укажите причину', 'Минимум 5 символов', true);
        return;
    }

    this.disabled = true;
    this.textContent = 'Отменяем...';

    try {
        const res = await fetch('/api/cancel_order', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ order_id: orderId, reason }) });
        const data = await res.json();

        if (res.ok && data.success) {
            document.getElementById('cancelOrderModal').style.display = 'none';
            if (window.reliableToast) reliableToast('Заказ отменён', '', false);
            dispatchOrderStatusChange(orderId, 'cancelled', true);
            window.startOrderChain(orderId);
        } else {
            if (window.reliableToast) reliableToast('Ошибка', data.error || 'Не удалось отменить', true);
        }
    } catch {
        if (window.reliableToast) reliableToast('Нет связи', 'Проверьте интернет', true);
    } finally {
        this.disabled = false;
        this.textContent = 'Отменить заказ';
    }
});

// Остальной код отмены заказа (не меняется)
window.cancelOrder = function(orderId) {
    document.getElementById('cancelModalOrderId').textContent = orderId;
    document.getElementById('cancelReasonInput').value = '';
    document.getElementById('cancelOrderModal').style.display = 'flex';
    setTimeout(() => document.getElementById('cancelReasonInput').focus(), 300);
};

document.getElementById('cancelOrderModal')?.addEventListener('click', function(e) {
    if (e.target === this) this.style.display = 'none';
});

document.getElementById('confirmCancelFinalBtn')?.addEventListener('click', async function(e) {
    e.stopPropagation();

    const modal = document.getElementById('cancelOrderModal');
    const reasonInput = document.getElementById('cancelReasonInput');
    const reason = reasonInput.value.trim();
    const orderId = parseInt(document.getElementById('cancelModalOrderId').textContent, 10);

    if (!reason || reason.length < 5) {
        reasonInput.style.borderColor = '#ff4444';
        setTimeout(() => reasonInput.style.borderColor = '', 3000);
        if (window.reliableToast) reliableToast('Укажите причину', 'Минимум 5 символов', true);
        return;
    }

    const btn = this;
    btn.disabled = true;
    btn.textContent = 'Отменяем...';

    try {
        const res = await fetch('/api/cancel_order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ order_id: orderId, reason })
        });

        const data = await res.json();

        if (res.ok && data.success) {
            modal.style.display = 'none';
            if (window.reliableToast) reliableToast('Заказ отменён', '', false);
            dispatchOrderStatusChange(orderId, 'cancelled', true);
            window.startOrderChain(orderId);
        } else {
            if (window.reliableToast) reliableToast('Ошибка', data.error || 'Не удалось отменить', true);
        }
    } catch (err) {
        console.error(err);
        if (window.reliableToast) reliableToast('Нет связи', 'Проверьте интернет', true);
    } finally {
        btn.disabled = false;
        btn.textContent = 'Отменить заказ';
    }
    
});
// ОБНОВЛЕНИЕ СЧЁТЧИКОВ В ТАБАХ АРХИВА — ФИНАЛЬНАЯ ВЕРСИЯ 2025
// === ПРАВИЛЬНЫЕ СЧЁТЧИКИ ДЛЯ ТРЁХ ОТДЕЛЬНЫХ ТАБОВ (2025) ===
function updateArchiveTabsCounts() {
    // Считаем строго по статусам
    const activeCount     = allOrders.filter(o => 
        !['completed', 'cancelled'].includes(o.status)
    ).length;

    const cancelledCount  = allOrders.filter(o => o.status === 'cancelled').length;
    const completedCount  = allOrders.filter(o => o.status === 'completed').length;

    // Обновляем бейджи — проверь, какие у тебя ID у спанов!
    // Чаще всего так:
    document.querySelector('[data-tab="active"] span')?.then?.(b => b.textContent = activeCount > 0 ? activeCount : '');
// Нет! Так нельзя!

// Правильно:
const activeBadge = document.querySelector('[data-tab="active"] span');
if (activeBadge) activeBadge.textContent = activeCount > 0 ? activeCount : '';

const cancelledBadge = document.querySelector('[data-tab="cancelled"] span');
if (cancelledBadge) cancelledBadge.textContent = cancelledCount > 0 ? cancelledCount : '';

const completedBadge = document.querySelector('[data-tab="completed"] span');
if (completedBadge) completedBadge.textContent = completedCount > 0 ? completedCount : '';

    // Если у тебя ID, а не data-tab — подставь свои:
    // document.getElementById('activeCountBadge')?.textContent = activeCount || '';
    // document.getElementById('cancelledCountBadge')?.textContent = cancelledCount || '';
    // document.getElementById('completedCountBadge')?.textContent = completedCount || '';
}

// Вызываем при переключении табов (на всякий случай с небольшой задержкой)
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    setTimeout(updateArchiveTabsCounts, 300); // даём время на загрузку новых заказов
  });
});
</script>
</body>
</html>