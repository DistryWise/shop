<!DOCTYPE html>
<head>
  <script>
    // Определяем тему ещё до первого рендера
    const savedTheme = localStorage.getItem('theme');
    const prefersLight = window.matchMedia('(prefers-color-scheme: light)').matches;
    const theme = savedTheme || (prefersLight ? 'light' : 'dark');

    // Сразу ставим атрибут
    document.documentElement.setAttribute('data-theme', theme);

    // И сразу форсируем правильный фон лоадера
    document.documentElement.style.backgroundColor = theme === 'light' ? '#ffffff' : '#000000';
  </script>
  <meta charset="UTF-8" />
  <!-- В <head> — обязательно самый первый мета-тег после charset -->
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="csrf-token" content="{{ csrf_token() }}">

  <script>
// Глобальное хранилище актуального токена
window.csrfToken = "{{ csrf_token() }}";

// Автоматически обновляем токен при любом успешном ответе от сервера
function updateCsrfTokenFromResponse(data) {
    if (data.csrf_token) {
        window.csrfToken = data.csrf_token;
        document.querySelector('meta[name="csrf-token"]')?.setAttribute('content', data.csrf_token);
    }
}

// Перехватываем ВСЕ fetch-запросы (POST, PUT, DELETE и т.д.)
const { fetch: origFetch } = window;
window.fetch = async (...args) => {
    let [resource, config] = args;
    
    // Только для мутирующих методов
    if (config && ['POST','PUT','DELETE','PATCH'].includes((config.method || 'GET').toUpperCase())) {
        config = config || {};
        config.headers = config.headers || {};
        config.headers['X-CSRF-Token'] = window.csrfToken;
        config.headers['X-Requested-With'] = 'XMLHttpRequest';
        
        // Если отправляем FormData — не трогаем Content-Type (браузер сам поставит с boundary)
        if (!(config.body instanceof FormData)) {
            config.headers['Content-Type'] = 'application/json';
        }
    }

    const response = await origFetch(resource, config);
    
    // Автоматически обновляем токен после любого успешного JSON-ответа
    if (response.ok && response.headers.get('content-type')?.includes('application/json')) {
        try {
            const data = await response.clone().json();
            updateCsrfTokenFromResponse(data);
        } catch (e) { /* не JSON — игнорируем */ }
    }

    return response;
};
  </script>


<!-- Этот скрипт — магия, которая заставляет медиа-запросы сработать сразу на 100% устройств -->
<script>
  // Если вдруг браузер думает, что ширина >1024px — принудительно говорим, что это мобильник
  if (window.innerWidth <= 1024 && !document.body.classList.contains('mobile-layout')) {
    document.body.classList.add('mobile-layout');
  }
</script>
  <title>Услуги — Piligrim · 2025</title>

  <!-- Шрифты и иконки -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;900&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Alex+Brush&display=swap" rel="stylesheet">

  <!-- Основные стили страницы услуг -->
  <link rel="stylesheet" href="/static/css/services.css">

  <!-- Стили хедера, поиска, корзины, авторизации, AI  -->
  <link rel="stylesheet" href="/static/css/search.css">
  <link rel="stylesheet" href="/static/css/auth.css">
  <link rel="stylesheet" href="/static/css/cart.css">
  <link rel="stylesheet" href="/static/css/ai.css">
  <link rel="stylesheet" href="/static/css/contacts.css">

</head>
<body>

  <!-- ЛОАДЕР -->
  <div class="loader" id="pageLoader"></div>

  <!-- ==================== ПОЛНЫЙ ХЕДЕР  ==================== -->
 <header class="main-header desktop-only">
  <a href="/" class="logo">
    <img src="/static/assets/logo.png" alt="Piligrim" class="logo-img">
  </a>

  <nav class="desktop-nav">
    <a href="/" class="nav-link">Главная</a>
    <a href="/goods" class="nav-link">Товары</a>
    <a href="/services" class="nav-link active">Услуги</a>
    <a href="/news" class="nav-link">Новости</a>
    <a href="/about_company" class="nav-link">О компании</a>
    <a href="/contacts" class="nav-link">Контакты</a>
  </nav>

  <div class="header-right">
    <div class="header-icons">
      <!-- Поиск -->
      <div class="search-wrapper">
        <div class="search-container">
          <div class="search-icon"><i class="fas fa-search"></i></div>
          <input type="text" class="search-input" id="searchInput" placeholder="Поиск...">
          <button id="searchClear" class="search-clear">×</button>
        </div>
        <div id="autocompleteList" class="autocomplete-list"></div>
      </div>

      <!-- Вход -->
      <button id="authBtn" class="icon-btn"><i class="fas fa-user"></i></button>

      <!-- Корзина — мини-дропдаун (как на contacts.html) -->
      <div class="cart-wrapper">
        <button class="icon-btn" id="cartBtn">
          <i class="fas fa-shopping-bag"></i>
          <span class="cart-count" id="cartCount">0</span>
        </button>

        <div id="miniCartDropdown" class="mini-cart-dropdown">
          <div class="mini-cart-header">
            <div class="mini-cart-title">Корзина</div>
          </div>
          <div class="mini-cart-items" id="miniCartItems">
            <div class="mini-cart-empty">Корзина пуста</div>
          </div>
          <div class="mini-cart-footer">
            <div class="mini-cart-total" id="miniCartTotal">Итого: 0 ₽</div>
            <button class="go-to-cart-btn" id="goToCartBtn">Оформить</button>
          </div>
        </div>
      </div>

      <!-- ПОДДЕРЖКА — ОДИН ID НА ВСЁМ САЙТЕ! -->
      <button class="icon-btn" id="feedbackBtn"><i class="fas fa-envelope"></i></button>
    </div>
  </div>
</header>


  <!-- МОБИЛЬНАЯ НИЖНЯЯ ПАНЕЛЬ -->
<nav class="mobile-bottom-bar">
  <button class="bottom-bar-btn" id="mobileSearchBtn" data-label="Поиск">
    <i class="fas fa-search"></i>
  </button>

  <button class="bottom-bar-btn" id="mobileAuthBtn" data-label="Вход">
    <i class="fas fa-user"></i>
  </button>

  <button class="bottom-bar-btn active" id="openSidebarMenu" data-label="Меню">
    <i class="fas fa-bars"></i>
  </button>

  <button class="bottom-bar-btn" id="mobileCartBtn" data-label="Корзина">
    <i class="fas fa-shopping-bag"></i>
    <span class="cart-count" id="mobileCartCount">0</span>
  </button>

  <button class="bottom-bar-btn" id="feedbackBtnMobile" data-label="Поддержка">
    <i class="fas fa-envelope"></i>
  </button>
</nav>

  <!-- МОДАЛКА ОБРАТНОЙ СВЯЗИ -->
  <div class="custom-alert" id="feedbackModal">
    <div class="alert-content">
      <button class="alert-close" id="closeFeedback">×</button>

      <div class="alert-icon">
        <i class="fas fa-envelope-open-text"></i>
      </div>

      <div class="alert-text">
        <strong>Обратная связь</strong>
        <span>Оставьте заявку — мы свяжемся с вами в ближайшее время</span>
      </div>

      <form class="contact-form" novalidate id="contactForm">
        <input type="text" placeholder="Ваше имя" name="name" required />
        
        <div class="phone-field-wrapper">
          <input type="tel" placeholder="+7 (___) ___-__-__" name="phone" pattern="\+7\s?\(\d{3}\)\s?\d{3}-\d{2}-\d{2}" required />
          <button type="button" class="edit-phone-btn" style="display:none;">Изменить</button>
        </div>
        
        <input type="email" placeholder="Email" name="email" required />
        <textarea placeholder="Ваше сообщение" name="message" required></textarea>

        <button type="submit" id="submitBtn" class="alert-login-btn">
          <span class="btn-text">Отправить сообщение</span>
          <span class="btn-cooldown">Отправка... <span class="timer">30</span>с</span>
        </button>
      </form>
    </div>
  </div>

  <!-- МОДАЛКА АВТОРИЗАЦИИ  -->
<div id="authModal" class="auth-modal">
  <div class="auth-modal-content">
    <button class="close-modal" id="closeAuthModal">×</button>
    <h2 class="auth-title">Вход по номеру<br><span class="mobile-only">телефона</span></h2>

    <!-- ШАГ 1 — ВВОД НОМЕРА -->
    <div id="stepPhone" class="auth-step">
      <div class="country-selector">
        <div class="selected-country" id="selectedCountry">
          <span class="flag">RU</span>
          <span class="code">+7</span>
          <i class="fas fa-chevron-down"></i>
        </div>
        <div class="country-dropdown" id="countryDropdown">
          <div class="country-item" data-code="+7" data-flag="RU">Россия +7</div>
          <div class="country-item" data-code="+1" data-flag="US">USA +1</div>
          <div class="country-item" data-code="+44" data-flag="GB">UK +44</div>
        </div>
      </div>
      
      <input type="text" 
       name="honeypot" 
       id="honeypot" 
       tabindex="-1" 
       autocomplete="off" 
       style="position:absolute; left:-9999px; opacity:0; height:0; width:0; border:none; padding:0; margin:0;"
       aria-hidden="true">

<input type="hidden" name="fp_token" id="fp_token" value="">
      <input type="tel" id="phoneInput" placeholder="(999) 999 99 99" class="auth-input">

      <label class="checkbox-label required">
        <input type="checkbox" id="privacyCheck">
        <span class="custom-checkbox"></span>
        Согласен с <a href="/policy" target="_blank" class="privacy-link">политикой конфиденциальности</a>
      </label>

      <label class="checkbox-label">
        <input type="checkbox" id="subscribeCheck" checked>
        <span class="custom-checkbox"></span>
        Получать SMS с акциями и уведомлениями
      </label>

      <button id="sendCodeBtn" class="auth-btn" disabled>Получить код</button>
    </div>

    <!-- ШАГ 2 — ВВОД КОДА -->
    <div id="stepCode" class="auth-step" style="display:none;">
      <p class="auth-info">Код отправлен на <span id="maskedPhone"></span></p>
      <input type="text" id="codeInput" placeholder="____" maxlength="4" class="auth-input">
      <button id="verifyCodeBtn" class="auth-btn">Войти</button>
      <button id="resendCode" class="auth-link">Отправить повторно</button>
    </div>

    <!-- ШАГ 3 — УСПЕШНЫЙ ВХОД -->
    <div id="stepSuccess" class="auth-step" style="display:none;">
      <i class="fas fa-check-circle success-icon"></i>
      <h3>Добро пожаловаться!</h3>
      <p>Вы успешно вошли как <span id="welcomePhone"></span></p>
      <button id="closeSuccess" class="auth-btn">Продолжить</button>
    </div>
  </div>
</div>



<!-- КАРТОЧКА ТОВАРА  -->
<div class="product-modal" id="productModal">
  <div class="product-content">
    <!-- Крестик закрытия -->
    <button class="close-modal" onclick="closeProductModal()">
      <svg width="28" height="28" viewBox="0 0 28 28" fill="none">
        <path d="M6 6L22 22M6 22L22 6" stroke="currentColor" stroke-width="2.3" stroke-linecap="round"/>
      </svg>
    </button>

    <!-- Основной контейнер -->
    <div class="product-main">
      <img id="productImg" class="product-img" src="/static/assets/no-image.png" alt="Товар">

      <div class="product-info">
        <h3 id="productTitle" class="product-title">Загрузка...</h3>

        <div id="productStockInfo" 
     style="margin: 12px 0 8px; 
            font-size: 1rem; 
            font-weight: 600; 
            line-height: 1.4;">
</div>

        <!-- Рейтинг и отзывы -->
        <div class="product-rating">
          <div class="stars"></div>
          <span id="productReviewsCount" class="reviews-count">—</span>
        </div>

        <div id="productPrice" class="product-price">—</div>

        <div id="productDescription" class="product-description">Загрузка описания...</div>

        <!-- Кнопка "В корзину" -->
        <button id="addToCartModal" class="add-to-cart-btn">
          <i class="fas fa-shopping-cart"></i> В корзину
        </button>

        <!-- ОТЗЫВЫ — ТОЧНО КАК В НОВОСТЯХ -->
        <div class="product-reviews">
          <h4 class="reviews-title">Отзывы покупателей</h4>
          <div class="reviews-list" id="productReviewsList">
            <div style="text-align:center;padding:3rem;color:#888;">
              <i class="far fa-star" style="font-size:3rem;margin-bottom:1rem;display:block;opacity:0.6;"></i>
              <p>Отзывов пока нет</p>
              <small style="opacity:0.7;">Будьте первым!</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- Поиск для планшетов (ноутбуки 768–1024px) -->
<div class="tablet-search-full" id="tabletSearchSheet">
  <div class="tablet-search-backdrop"></div>
  <div class="tablet-search-header-full">
    <button class="tablet-search-back" id="closeTabletSearch">
      <i class="fas fa-arrow-left"></i>
    </button>
    <div class="tablet-search-input-wrapper-full">
      <i class="fas fa-search"></i>
      <input type="text" id="tabletSearchInput" placeholder="Поиск по каталогу..." autocomplete="off">
      <button class="tablet-search-clear" id="tabletSearchClear">×</button>
    </div>
  </div>
  <div class="tablet-search-empty" id="tabletEmptyState">
    <i class="fas fa-search"></i>
    <p>Начните вводить запрос...</p>
  </div>
  <div id="tabletAutocompleteList" class="tablet-autocomplete-list-full"></div>
</div>

<!-- Мобильный поиск (шторка снизу) -->
<div class="mobile-search-sheet" id="mobileSearchSheet">
  <div class="mobile-search-header">
    <div class="sheet-handle"></div>
    <button class="mobile-search-back" id="closeMobileSearchTop">←</button>
    <div class="mobile-search-input-wrapper">
      <i class="fas fa-search"></i>
      <input type="text" class="mobile-search-input" id="mobileSearchInput" placeholder="Поиск по каталогу..." autocomplete="off">
      <button class="mobile-search-clear" id="mobileSearchClear">×</button>
    </div>
  </div>

  <div class="mobile-search-results-content" id="mobileSearchResults">
    <div class="search-empty-state" id="mobileEmptyState">
      <div class="empty-icon"><i class="fas fa-search"></i></div>
      <div class="empty-title">Введите название товара</div>
      <div class="empty-subtitle">Например: iPhone 16, кроссовки Nike, кофеварка</div>
    </div>
    <div id="mobileAutocompleteList" class="mobile-autocomplete-list"></div>
  </div>
</div>

<!-- Мобильная корзина (шторка) -->
<div class="mobile-cart-sheet" id="mobileCartSheet">
  <div class="sheet-backdrop" id="mobileCartBackdrop"></div>
  <div class="sheet-container">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <div class="cart-header-icon">
        <i class="fas fa-shopping-bag"></i>
        <span class="cart-count" id="mobileCartHeaderCount">0</span>
      </div>
      <h3>Корзина</h3>
      <button class="sheet-close-btn" id="mobileCloseCart">×</button>
    </div>
    <div class="sheet-items" id="mobileMiniCartItems">
      <div style="padding:3rem 1.5rem;text-align:center;color:#888;">
        <i class="fas fa-shopping-bag" style="font-size:3rem;margin-bottom:1rem;opacity:0.3;"></i>
        <p>Корзина пуста</p>
      </div>
    </div>
    <div class="sheet-total">
      Итого: <strong id="mobileMiniCartTotal">0 ₽</strong>
    </div>
    <div class="sheet-footer">
      <button class="checkout-btn-full" id="mobileGoToCartBtn">
        Перейти к оформлению
      </button>
    </div>
  </div>
</div>

<!-- Алерт «Авторизуйтесь» перед отправкой сообщения -->
<div class="custom-alert" id="authAlert">
  <div class="alert-content">
    <button class="alert-close">×</button>
    <div class="alert-icon">
      <i class="fas fa-user-lock"></i>
    </div>
    <div class="alert-text">
      <strong>Авторизуйтесь</strong>
      <span>Для отправки сообщения нужно войти в аккаунт</span>
    </div>
    <button class="alert-login-btn" id="authBtnFeedback">Войти</button>
  </div>
</div>

<!-- Мобильная обратная связь (шторка 2025) -->
<div class="mobile-feedback-top" id="mobileFeedbackTop"></div>
<div class="mobile-feedback-sheet" id="mobileFeedbackSheet">
  <div class="sheet-header">
    <button class="sheet-back-btn" id="closeMobileFeedback">
      <i class="fas fa-chevron-left"></i>
    </button>
    <div class="sheet-title-wrapper">
      <i class="fas fa-envelope-open-text"></i>
      <h2>Обратная связь</h2>
    </div>
  </div>
  <div class="sheet-handle"></div>
  
  <form class="contact-form sheet-form" novalidate id="contactFormMobile">
    <div class="sheet-field">
      <label>Ваше имя</label>
      <input type="text" class="name-input" name="name" placeholder="Ваше имя..." required autocomplete="name" />
    </div>
    <div class="sheet-field phone-field-wrapper">
      <label>Телефон <span class="required">*</span></label>
      <input type="tel" class="phone-input" name="phone" placeholder="+7 (___) ___-__-__" pattern="\+7\s?\(\d{3}\)\s?\d{3}-\d{2}-\d{2}" required />
    </div>
    <div class="sheet-field">
      <label>Email <span class="required">*</span></label>
      <input type="email" name="email" placeholder="your@email.com" required autocomplete="email" />
    </div>
    <div class="sheet-field">
      <label>Сообщение <span class="required">*</span></label>
      <textarea name="message" placeholder="Опишите ваш вопрос или предложение..." rows="4" required></textarea>
    </div>
    <button type="submit" class="sheet-submit-btn" id="submitBtnMobile">
      <span class="btn-text">Отправить заявку</span>
      <span class="btn-loading"><i class="fas fa-spinner fa-spin"></i></span>
      <span class="btn-cooldown" style="display:none;"><span class="timer">30</span>с</span>
    </button>
  </form>
</div>

<!-- Боковое меню (свайп влево) -->
<div class="mobile-sidebar" id="mobileSidebar">
  <div class="sidebar-top">
    <button class="sidebar-close" id="closeSidebar">
      <i class="fas fa-chevron-left"></i>
    </button>
    <img src="/static/assets/logo.png" alt="Piligrim" class="sidebar-logo-big">
  </div>

  <nav class="sidebar-nav-modern">
    <div class="nav-divider top"></div>
    <a href="/" class="sidebar-link-modern">Главная</a>
    <a href="/goods" class="sidebar-link-modern">Товары</a>
    <a href="/services" class="sidebar-link-modern active">Услуги</a>
    <a href="/news" class="sidebar-link-modern">Новости</a>
    <a href="/about_company" class="sidebar-link-modern">О компании</a>
    <a href="/contacts" class="sidebar-link-modern">Контакты</a>
    <a href="/profile" class="sidebar-link-modern">Личный кабинет</a>
    <div class="nav-divider bottom"></div>
  </nav>

  <div class="sidebar-bottom-theme">
    <div class="sidebar-theme-toggle">
      <input type="checkbox" id="theme-toggle" class="theme-toggle-input">
      <label for="theme-toggle" class="theme-toggle-label">
        <i class="fas fa-moon"></i>
        <i class="fas fa-sun"></i>
      </label>
    </div>
  </div>
</div>

<!-- AI-ассистент (иконка внизу справа) -->
<div id="ai-assistant">
  <svg viewBox="0 0 100 100" class="ai-robot" xmlns="http://www.w3.org/2000/svg">
    <!-- ... (весь SVG из about_company.html — он работает) -->
    <defs>
      <linearGradient id="goldGrad" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stop-color="#f5d78a"/>
        <stop offset="100%" stop-color="#d4af37"/>
      </linearGradient>
      <linearGradient id="suitGrad" x1="0%" y1="0%" x2="0%" y2="100%">
        <stop offset="0%" stop-color="#2d2d2d"/>
        <stop offset="100%" stop-color="#1a1a1a"/>
      </linearGradient>
    </defs>
    <circle cx="50" cy="35" r="18" fill="url(#goldGrad)" stroke="#b8975a" stroke-width="2"/>
    <circle cx="44" cy="32" r="4.5" fill="#000" opacity="0.9"/>
    <circle cx="56" cy="32" r="4.5" fill="#000" opacity="0.9"/>
    <circle cx="45.5" cy="31" r="1.8" fill="#fff"/>
    <circle cx="57.5" cy="31" r="1.8" fill="#fff"/>
    <circle cx="46" cy="30.5" r="1.2" fill="#fff" opacity="0.7"/>
    <circle cx="58" cy="30.5" r="1.2" fill="#fff" opacity="0.7"/>
    <path d="M30 52 L28 98 L72 98 L70 52 Q62 58 50 58 Q38 58 30 52 Z" fill="url(#suitGrad)" stroke="#000" stroke-width="2"/>
    <path d="M50 52 L42 64 L42 72" fill="none" stroke="#1a1a1a" stroke-width="3"/>
    <path d="M50 52 L58 64 L58 72" fill="none" stroke="#1a1a1a" stroke-width="3"/>
    <path d="M50 58 L46 72 L50 78 L54 72 Z" fill="#8b1e1e"/>
    <polygon points="46,72 50,78 54,72" fill="#5c1212"/>
    <circle cx="50" cy="70" r="2.5" fill="#333"/>
    <circle cx="50" cy="78" r="2.5" fill="#333"/>
    <circle cx="50" cy="86" r="2.5" fill="#333"/>
    <rect x="24" y="58" width="12" height="28" rx="6" fill="url(#goldGrad)" stroke="#b8975a" stroke-width="1.5"/>
    <rect x="64" y="58" width="12" height="28" rx="6" fill="url(#goldGrad)" stroke="#b8975a" stroke-width="1.5"/>
    <g transform="translate(12, 68)">
      <rect x="0" y="0" width="28" height="36" rx="4" fill="#fff" stroke="#111" stroke-width="2"/>
      <rect x="2" y="2" width="24" height="30" rx="2" fill="#f0f0f0"/>
      <text x="14" y="11" font-family="Arial, sans-serif" font-size="5.5" fill="#000" text-anchor="middle" font-weight="bold">КОНСТИТУЦИЯ</text>
      <line x1="4" y1="15" x2="24" y2="15" stroke="#333" stroke-width="0.8"/>
      <line x1="4" y1="19" x2="24" y2="19" stroke="#333" stroke-width="0.8"/>
      <line x1="4" y1="23" x2="22" y2="23" stroke="#333" stroke-width="0.8"/>
      <line x1="4" y1="27" x2="20" y2="27" stroke="#333" stroke-width="0.8"/>
    </g>
    <path d="M42 24 Q46 20 50 24" fill="none" stroke="#fff" stroke-width="1.5" opacity="0.6"/>
  </svg>
</div>

<!-- AI чат -->
<div id="ai-chat" class="ai-chat-modal">
  <div class="ai-chat-header">
    <div class="ai-chat-title">
      <svg width="32" height="32" viewBox="0 0 100 100" style="margin-right:10px;">
        <use href="#goldGrad"/>
        <circle cx="50" cy="50" r="48" fill="url(#goldGrad)" stroke="#b8975a" stroke-width="2"/>
        <circle cx="38" cy="42" r="7" fill="#000" opacity="0.8"/>
        <circle cx="62" cy="42" r="7" fill="#000" opacity="0.8"/>
        <circle cx="39" cy="40" r="2.5" fill="#fff"/>
        <circle cx="63" cy="40" r="2.5" fill="#fff"/>
        <path d="M30 58 Q50 68 70 58" stroke="#000" stroke-width="2.5" fill="none" stroke-linecap="round"/>
        <g transform="translate(8, 62)">
          <rect x="0" y="0" width="30" height="38" rx="3" fill="#fff" stroke="#000" stroke-width="1.6"/>
          <text x="15" y="12" font-family="Arial" font-size="6.5" fill="#000" text-anchor="middle" font-weight="bold">КОНСТИТУЦИЯ</text>
        </g>
        <path d="M16 75 Q10 70 13 65" fill="none" stroke="#b8975a" stroke-width="7.5" stroke-linecap="round"/>
      </svg>
      <span>Юрист AI</span>
    </div>
    <div class="ai-header-buttons">
      <button class="ai-btn-minimize" onclick="toggleAIChatSize()" title="На весь экран">
        <i class="fas fa-expand-arrows-alt"></i>
      </button>
      <button class="ai-btn-close" onclick="closeAIChat()" title="Закрыть">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>
  <div class="ai-chat-body">
    <div class="ai-chat-messages"></div>
    <div class="ai-chat-input">
      <input type="text" id="ai-input" placeholder="Задайте юридический вопрос..." 
             onkeypress="if(event.key==='Enter' && this.value.trim()) { sendAIMessage(this.value); this.value=''; }">
      <button onclick="const inp = document.getElementById('ai-input'); if(inp.value.trim()) { sendAIMessage(inp.value); inp.value=''; }" title="Отправить">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>
</div>

<!-- Лампочка переключения темы -->
<div class="theme-toggle-hanging">
  <input type="checkbox" id="theme-toggle" class="theme-toggle-input">
  <label for="theme-toggle" class="theme-toggle-label">
    <div class="rope top"></div>
    <div class="bulb">
      <div class="bulb-light"></div>
      <div class="bulb-glow"></div>
    </div>
    <div class="rope bottom"></div>
  </label>
</div>

<!-- Кнопка наверх -->
<a href="#" class="back-to-top"><i class="fas fa-arrow-up"></i></a>
  
  <div class="white-overlay" id="whiteOverlay"></div>

  <section class="hero" id="hero">
    <div class="slide active"></div>
    <div class="slide"></div>
    <div class="slide"></div>
    <div class="slide"></div>
    <div class="void-cut"></div>
    <div class="scroll-indicator">Скролл вниз для входа</div>
  </section>

  <nav class="side-catalog" id="sideCatalog">
    <div class="catalog-toggle">CATALOGUE</div>
    <ul class="catalog-list"></ul>
  </nav>
  <div class="catalog-arrow-hint" id="catalogArrowHint"></div>

  <section class="light-zone" id="lightZone">
    <div class="sort-panel">
      <button class="sort-btn active" data-sort="default">DEFAULT</button>
      <button class="sort-btn" data-sort="price">PRICE ↑</button>
    </div>
    <div class="grid-controls">
      <button class="grid-btn active" data-cols="3">
        <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
      </button>
      <button class="grid-btn" data-cols="2">
        <svg viewBox="0 0 24 24"><rect x="3" y="3" width="9" height="18"/><rect x="14" y="3" width="9" height="18"/></svg>
      </button>
    </div>
    <div class="catalog-header"><h1>УСЛУГИ</h1></div>
<div class="hero-search-wrapper" style="max-width:1100px;margin:0 auto 180px;position:relative;">
  <div class="hero-search-container" style="position:relative;max-width:900px;margin:0 auto;">
    
    <input type="text" 
           class="hero-search" 
           id="search" 
           placeholder="Поиск..." 
           style="width:100%;background:transparent;border:none;border-bottom:3px solid #000;font-family:'Inter',sans-serif;font-weight:300;font-size:22px;letter-spacing:4px;color:#000;text-align:center;padding:20px 60px 20px 0;outline:none;box-sizing:border-box;"
           autocomplete="off">

    <div class="hero-search-icon" style="position:absolute;right:0;top:50%;transform:translateY(-50%);width:40px;height:40px;opacity:0.35;transition:all .8s cubic-bezier(.16,1,.3,1);pointer-events:none;">
      <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTEiIGN5PSIxMSIgcj0iNyIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjIuNCIvPgo8cGF0aCBkPSJNMTYuNSAxNi41TDIwLjUgMjAuNSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjIuNiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+Cjwvc3ZnPg==" alt="поиск" style="width:100%;height:100%;display:block;">
    </div>
  </div>
</div>
    <div class="grid" id="grid"></div>
    <div id="adBannerSection" class="noir-island-wrapper">
      <div class="secondary-carousel">
        <div class="carousel-inner" id="services-carousel-inner"></div>
        <div class="indicators"></div>
      </div>
    </div>
  </section>

  <div class="load-more-section">
    <button class="load-more-btn" type="button">LOAD MORE</button>
  </div>

  <!-- МОДАЛКА -->
  <div class="modal" id="modal"><button class="modal-close-btn" aria-label="Закрыть">
  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round">
    <line x1="18" y1="6" x2="6" y2="18"/>
    <line x1="6" y1="6" x2="18" y2="18"/>
  </svg>
</button><div class="close">×</div>
    <div class="modal-content">
      <div class="modal-gallery">
        <img id="modal-img" src="" alt="">
        <div class="gallery-thumbs" id="modal-thumbs"></div>
      </div>
      <div class="modal-info">
        <div class="info-header">
          <h3 id="modal-title"></h3>
          <div class="price" id="modal-price">₽ —</div>
        </div>
        <p id="modal-desc"></p>
        <div class="rating" id="modal-rating">
          <span class="stars">★★★★★</span>
          <span class="value">0.0</span>
          <span class="count">(0)</span>
        </div>
        <button class="order-btn" id="modal-order">ЗАКАЗАТЬ</button>
        <div class="reviews-section">
          <h4>ОТЗЫВЫ</h4>
          <div class="reviews" id="modal-reviews"></div>
          <p class="no-reviews" id="no-reviews">Отзывов пока нет</p>
        </div>
      </div>
    </div>
  </div>

  <footer id="footer">
    <span>© 2025 Piligrim · +7 (906) 217-38-69 · piligrim_service39@mail.ru</span>
  </footer>

  <!-- УВЕДОМЛЕНИЯ -->
  <div id="toast-container"></div>



<!-- КРАСИВАЯ КНОПКА ВЫХОДА ИЗ БЕЛОЙ ЗОНЫ — ФИНАЛЬНАЯ ВЕРСИЯ 2025 -->
<div id="exitWhiteZoneBtn">
  <span class="exit-text">НАВЕРХ · В NOIR</span>
  <div class="exit-arrow">
    <svg viewBox="0 0 38 38" fill="none" stroke="currentColor" stroke-width="1.7">
      <path d="M19 8v18M11 16l8-8 8 8"/>
    </svg>
  </div>
</div>

<script src="static/js/service.js"></script>
<script src="/static/js/search.js"></script>
<script src="/static/js/auth.js"></script>
<script src="/static/js/cart.js" defer></script>
<script src="/static/js/feedback.js"></script>
<script src="/static/js/ai.js"></script>
<script src="/static/js/contacts.js"></script>

<script>
      document.getElementById('search')?.addEventListener('focus', e => {
        e.target.nextElementSibling.style.opacity = '0.8';
        e.target.nextElementSibling.style.transform = 'translateY(-50%) scale(1.15)';
      });
      document.getElementById('search')?.addEventListener('blur', e => {
        e.target.nextElementSibling.style.opacity = '0.3';
        e.target.nextElementSibling.style.transform = 'translateY(-50%) scale(1)';
      });
</script>
    
<script>
    document.addEventListener('DOMContentLoaded', () => {
      document.body.classList.add('loaded');
      const loader = document.getElementById('pageLoader');
      setTimeout(() => loader.classList.add('hidden'), 900);



      // Хедер + кнопка наверх
      const header = document.querySelector('header');
      const backToTop = document.querySelector('.back-to-top');
      window.addEventListener('scroll', () => {
        const scrolled = window.pageYOffset;
        header.classList.toggle('scrolled', scrolled > 50);
        backToTop.classList.toggle('visible', scrolled > 500);
      });

      // Плавный скролл по якорям
      document.querySelectorAll('a[href^="#"], .nav-link, .back-to-top').forEach(link => {
        link.addEventListener('click', function(e) {
          const href = this.getAttribute('href');
          if (href === '#' || href.startsWith('#')) {
            e.preventDefault();
            const target = document.querySelector(href === '#' ? 'html' : href);
            if (target) {
              const offset = 80;
              const pos = target.getBoundingClientRect().top + window.pageYOffset - offset;
              window.scrollTo({top: pos, behavior: 'smooth'});
            }
          }
        });
      });
    });
  </script>

<!-- УСЛУГИ → КОРЗИНА -->
<div id="my-toast-container"></div>

<style>
  #my-toast-container{position:fixed;bottom:30px;right:30px;z-index:2147483647;pointer-events:none;font-family:'Inter',sans-serif}
  .mytoast{background:rgba(20,20,20,0.96);color:#fff;padding:18px 28px;margin-top:12px;border-radius:16px;min-width:360px;
    box-shadow:0 20px 60px rgba(0,0,0,0.6);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.12);
    display:flex;align-items:center;gap:16px;transform:translateX(420px);opacity:0;
    transition:all .75s cubic-bezier(.16,1,.3,1);pointer-events:auto;font-weight:500}
  .mytoast.show{transform:translateX(0);opacity:1}
  .mytoast.success{border-left:6px solid #00ff9d}
  .mytoast.error{border-left:6px solid #ff3b30}
  .mytoast i{font-size:1.7em}
</style>

<script>
// Ждём cart.js
document.addEventListener('DOMContentLoaded', () => {
  const check = setInterval(() => {
    if (window.addToCart && window.loadCart) {
      clearInterval(check);
      initServiceCart();
    }
  }, 50);
});

function toast(msg, type = 'success') {
  const c = document.getElementById('my-toast-container');
  const t = document.createElement('div');
  t.className = `mytoast ${type}`;
  t.innerHTML = `<i class="fas fa-${type==='success'?'check-circle':'exclamation-triangle'}"></i><span>${msg}</span>`;
  c.appendChild(t);
  setTimeout(() => t.classList.add('show'), 50);
  setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 800); }, 4000);
}

// ГЛОБАЛЬНАЯ ЗАЩИТА ОТ СПАМА — РАБОТАЕТ ВСЕГДА
let spamBlockUntil = 0;
function canClick() {
  const now = Date.now();
  if (now < spamBlockUntil) {
    const sec = Math.ceil((spamBlockUntil - now) / 1000);
    toast(`Слишком быстро! Подождите ${sec} сек.`, 'error');
    return false;
  }
  // 6 кликов за 3 секунды = бан на 30 сек
  if (!window.clickTimes) window.clickTimes = [];
  window.clickTimes = window.clickTimes.filter(t => now - t < 3000);
  window.clickTimes.push(now);
  if (window.clickTimes.length > 6) {
    spamBlockUntil = now + 30000;
    toast('Слишком много кликов! Блокировка 30 сек.', 'error');
    return false;
  }
  return true;
}

// Добавление услуги
async function addService(id) {
  if (!canClick()) return;

  const btn = document.getElementById('modal-order');
  btn.disabled = true;
  btn.textContent = 'Добавляем...';

  try {
    await window.addToCart(id, 'service', 1);
    
    btn.style.transform = 'scale(0.93)';
    setTimeout(() => btn.style.transform = '', 200);

    document.getElementById('modal')?.classList.remove('active');
    document.getElementById('whiteOverlay')?.classList.remove('active');


  } catch (e) {
    toast('Ошибка сети', 'error');
  } finally {
    setTimeout(() => {
      btn.disabled = false;
      btn.textContent = 'ЗАКАЗАТЬ';
    }, 800);
  }
}

// Главная инициализация — БЕЗ cloneNode (это и было причиной багов!)
function initServiceCart() {
  const btn = document.getElementById('modal-order');
  if (!btn) return;

  // УДАЛЯЕМ ВСЕ СТАРЫЕ ОБРАБОТЧИКИ ЧЕРЕЗ ОДИН РАЗОВЫЙ КЛИК
  btn.onclick = null;
  btn.replaceWith(btn.cloneNode(true));
  const newBtn = document.getElementById('modal-order');

  newBtn.addEventListener('click', function (e) {
    e.preventDefault();
    e.stopPropagation();
    const id = this.dataset.serviceId;
    if (id) addService(Number(id));
    else toast('ID услуги не найден', 'error');
  });

  // Обновление корзины при открытии
  document.getElementById('cartBtn')?.addEventListener('click', () => {
    setTimeout(() => window.loadCart?.(), 100);
  });

  console.log('УСЛУГИ → КОРЗИНА: финальная версия 2025 — ЗАЩИТА ОТ СПАМА РАБОТАЕТ');
}
</script>
<script>
// УНИВЕРСАЛЬНЫЙ АНТИСПАМ 2025 — РАБОТАЕТ НА ВСЕХ КНОПКАХ "В КОРЗИНУ" И ИЗМЕНЕНИЯ КОЛИЧЕСТВА
// Защищает от спама: + / – / удалить / любые onclick="addToCart(...)" / кнопки с классами
const GlobalAddToCartProtection = (() => {
  const STORAGE_KEY = 'cart_flood_protection_2025';
  const COOLDOWN_MS = 20000;    // 20 сек блок после спама
  const MAX_CLICKS = 9;         // сколько быстрых кликов разрешено

  let clickCount = 0;
  let resetTimer = null;
  let blockedUntil = 0;

  // Загружаем состояние
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      const data = JSON.parse(saved);
      blockedUntil = data.blockedUntil || 0;
    }
  } catch (e) {}

  const block = () => {
    blockedUntil = Date.now() + COOLDOWN_MS;
    localStorage.setItem(STORAGE_KEY, JSON.stringify({ blockedUntil }));

    // Красивый красный алерт с таймером
    const alert = document.createElement('div');
    alert.id = 'global-cart-flood-alert';
    alert.innerHTML = `
      <i class="fas fa-hand-paper"></i>
      <div>
        <strong>Слишком быстро!</strong><br>
        <small>Подождите <span class="timer">20</span> сек</small>
      </div>
    `;
    Object.assign(alert.style, {
      position: 'fixed', top: '20px', left: '50%', transform: 'translateX(-50%)',
      background: 'linear-gradient(135deg,#ff453a,#ff2d55)', color: 'white',
      padding: '16px 32px', borderRadius: '26px', fontSize: '1.15rem',
      fontWeight: '600', boxShadow: '0 20px 50px rgba(255,45,85,0.5)',
      backdropFilter: 'blur(20px)', display: 'flex', alignItems: 'center', gap: '14px',
      zIndex: '999999', animation: 'slideDown 0.5s ease'
    });
    document.body.appendChild(alert);

    let seconds = 20;
    const timerSpan = alert.querySelector('.timer');
    const interval = setInterval(() => {
      seconds--;
      timerSpan.textContent = seconds;
      if (seconds <= 0) {
        clearInterval(interval);
        alert.remove();
      }
    }, 1000);

    setTimeout(() => alert.remove(), COOLDOWN_MS + 1000);
  };

  return {
    check() {
      const now = Date.now();
      if (blockedUntil > now) return false;

      clickCount++;
      clearTimeout(resetTimer);
      resetTimer = setTimeout(() => { clickCount = 0; }, 10000);

      if (clickCount > MAX_CLICKS) {
        block();
        clickCount = 0;
        return false;
      }
      return true;
    }
  };
})();

// УНИВЕРСАЛЬНЫЙ ПЕРЕХВАТЧИК — ЛОВИТ ВСЁ
document.addEventListener('click', function(e) {
  const target = e.target.closest(
    'button, .add-to-cart-btn, .buy-btn, .apple-qty-btn, .apple-remove-btn, ' +
    '.quantity-btn, .clear-cart-btn, [onclick*="addToCart("]'
  );

  if (!target) return;

  // Проверяем, это действие с корзиной?
  const onclick = target.getAttribute('onclick') || '';
  const isCartAction = 
    onclick.includes('addToCart(') ||
    target.classList.contains('apple-qty-btn') ||
    target.classList.contains('apple-remove-btn') ||
    target.classList.contains('quantity-btn') ||
    target.classList.contains('clear-cart-btn') ||
    target.classList.contains('add-to-cart-btn') ||
    target.classList.contains('buy-btn');

  if (isCartAction && !GlobalAddToCartProtection.check()) {
    e.preventDefault();
    e.stopImmediatePropagation();
    e.stopPropagation();
    return false;
  }
}, true); // true = capture phase → срабатывает раньше всех остальных обработчиков

// Анимация алерта
document.head.insertAdjacentHTML('beforeend', `
<style>
@keyframes slideDown {
  from { transform: translateX(-50%) translateY(-100px); opacity: 0; }
  to   { transform: translateX(-50%) translateY(0); opacity: 1; }
}
#global-cart-flood-alert i { font-size: 1.8rem; }
</style>
`);
</script>

<script defer>
// =================== contacts-mini.js — только то, что нужно для news.html ===================
document.addEventListener("DOMContentLoaded", () => {
  // === ПРЕЛОАДЕР ===
  const loader = document.getElementById('loader');
  if (loader) {
    setTimeout(() => {
      loader.style.opacity = '0';
      setTimeout(() => loader.remove(), 600);
    }, 400);
  }

  // === BACK TO TOP ===
  const backIoTop = document.querySelector('.back-to-top');
  if (backIoTop) {
    window.addEventListener('scroll', () => {
      backIoTop.classList.toggle('visible', window.scrollY > 600);
    });
    backIoTop.addEventListener('click', e => {
      e.preventDefault();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  }

  // === ТЕМА (безопасно, даже если два toggle) ===
  const applyTheme = () => {
    const saved = localStorage.getItem('theme');
    const prefersLight = window.matchMedia('(prefers-color-scheme: light)').matches;
    const theme = saved || (prefersLight ? 'light' : 'dark');
    document.documentElement.setAttribute('data-theme', theme);

    document.querySelectorAll('#theme-toggle, #theme-toggle-hanging').forEach(el => {
      if (el) el.checked = (theme === 'light');
    });
  };
  applyTheme();

  document.addEventListener('change', e => {
    if (e.target.matches('#theme-toggle, #theme-toggle-hanging')) {
      const isLight = e.target.checked;
      document.documentElement.setAttribute('data-theme', isLight ? 'light' : 'dark');
      localStorage.setItem('theme', isLight ? 'light' : 'dark');
    }
  });

  // === МОБИЛЬНЫЙ САЙДБАР (свайп влево) — ИСПРАВЛЕННАЯ ВЕРСИЯ БЕЗ ОШИБОК ===
  const sidebar = document.getElementById('mobileSidebar');
  if (sidebar) {
    let startX = 0, isDragging = false;
    const threshold = 80;

    const close = () => {
      sidebar.classList.remove('active');
      document.body.classList.remove('sidebar-open');
    };

    const handleStart = e => {
      if (!sidebar.classList.contains('active')) return;
      startX = e.touches?.[0].clientX || e.clientX;
      isDragging = true;
      sidebar.style.transition = 'none';
    };

    const handleMove = e => {
      if (!isDragging) return;
      const x = e.touches?.[0].clientX || e.clientX;
      const diff = x - startX;
      if (diff < 0) {
        e.preventDefault();
        sidebar.style.transform = `translateX(${diff}px)`;
      }
    };

    const handleEnd = () => {
      if (!isDragging) return;
      isDragging = false;
      const diff = (event?.changedTouches?.[0]?.clientX || event?.clientX || startX) - startX;
      if (diff < -threshold) {
        sidebar.style.transition = 'transform 0.4s ease';
        sidebar.style.transform = 'translateX(-100%)';
        setTimeout(() => {
          close();
          sidebar.style.transition = '';
          sidebar.style.transform = '';
        }, 400);
      } else {
        sidebar.style.transition = 'transform 0.3s ease';
        sidebar.style.transform = 'translateX(0)';
        setTimeout(() => sidebar.style.transition = '', 300);
      }
    };

    // Открытие
    document.getElementById('openSidebarMenu')?.addEventListener('click', () => {
      sidebar.classList.add('active');
      document.body.classList.add('sidebar-open');
    });

    document.getElementById('closeSidebar')?.addEventListener('click', close);

    // Свайп + клик вне
    document.addEventListener('touchstart', handleStart, { passive: true });
    document.addEventListener('touchmove', handleMove, { passive: false });
    document.addEventListener('touchend', handleEnd);

    document.addEventListener('click', e => {
      if (sidebar.classList.contains('active') && 
          !e.target.closest('#mobileSidebar') && 
          !e.target.closest('#openSidebarMenu')) close();
    });
  }

  // === МОБИЛЬНАЯ ОБРАТНАЯ СВЯЗЬ — свайп вниз (исправлено) ===
  const feedbackSheet = document.getElementById('mobileFeedbackSheet');
  if (feedbackSheet) {
    let startY = 0, dragging = false;
    const threshold = 120;

    const close = () => {
      feedbackSheet.classList.remove('active');
      document.body.style.overflow = '';
    };

    feedbackSheet.addEventListener('touchstart', e => {
      if (!feedbackSheet.classList.contains('active')) return;
      startY = e.touches[0].clientY;
      dragging = true;
      feedbackSheet.style.transition = 'none';
    }, { passive: true });

    feedbackSheet.addEventListener('touchmove', e => {
      if (!dragging) return;
      const y = e.touches[0].clientY;
      const diff = y - startY;
      if (diff > 0) {
        e.preventDefault();
        feedbackSheet.style.transform = `translateY(${diff}px)`;
      }
    }, { passive: false });

    feedbackSheet.addEventListener('touchend', () => {
      if (!dragging) return;
      dragging = false;
      const diff = (event?.changedTouches?.[0]?.clientY || startY) - startY;
      if (diff > threshold) {
        feedbackSheet.style.transition = 'transform 0.4s ease';
        feedbackSheet.style.transform = 'translateY(100%)';
        setTimeout(() => {
          close();
          feedbackSheet.style.transition = '';
          feedbackSheet.style.transform = '';
        }, 400);
      } else {
        feedbackSheet.style.transition = 'transform 0.3s ease';
        feedbackSheet.style.transform = 'translateY(0)';
        setTimeout(() => feedbackSheet.style.transition = '', 300);
      }
    });

    // Кнопки закрытия
    document.querySelectorAll('#closeMobileFeedback, .sheet-back-btn').forEach(btn => {
      btn.addEventListener('click', close);
    });
  }
});
// === МОБИЛЬНЫЙ САЙДБАР — РАБОЧАЯ ВЕРСИЯ 2025 (с классом .open) ===
const sidebar = document.getElementById('mobileSidebar');
if (sidebar) {
  let startX = 0, isDragging = false;
  const threshold = 80;

  const close = () => {
    sidebar.classList.remove('open');        // ← .open!
    document.body.classList.remove('sidebar-open');
  };

  const handleStart = e => {
    if (!sidebar.classList.contains('open')) return;
    startX = e.touches?.[0].clientX || e.clientX;
    isDragging = true;
    sidebar.style.transition = 'none';
  };

  const handleMove = e => {
    if (!isDragging) return;
    const x = e.touches?.[0].clientX || e.clientX;
    const diff = x - startX;
    if (diff < 0) {
      e.preventDefault();
      sidebar.style.transform = `translateX(${diff}px)`;
    }
  };

  const handleEnd = e => {
    if (!isDragging) return;
    isDragging = false;
    const currentX = e.changedTouches?.[0]?.clientX || e.clientX || startX;
    const diff = currentX - startX;

    if (diff < -threshold) {
      sidebar.style.transition = 'transform 0.44s cubic-bezier(0.22, 1, 0.36, 1)';
      sidebar.style.transform = 'translateX(-100%)';
      setTimeout(() => {
        close();
        sidebar.style.transition = '';
        sidebar.style.transform = '';
      }, 450);
    } else {
      sidebar.style.transition = 'transform 0.38s cubic-bezier(0.2, 0.9, 0.3, 1)';
      sidebar.style.transform = 'translateX(0)';
      setTimeout(() => sidebar.style.transition = '', 380);
    }
  };

  document.getElementById('openSidebarMenu')?.addEventListener('click', () => {
    sidebar.classList.add('open');           // ← .open!
    document.body.classList.add('sidebar-open');
  });

  document.getElementById('closeSidebar')?.addEventListener('click', close);

  document.addEventListener('touchstart', handleStart, { passive: true });
  document.addEventListener('touchmove', handleMove, { passive: false });
  document.addEventListener('touchend', handleEnd);

  document.addEventListener('click', e => {
    if (sidebar.classList.contains('open') && 
        !e.target.closest('#mobileSidebar') && 
        !e.target.closest('#openSidebarMenu')) {
      close();
    }
  });
}
</script>

<script>
// === МИНИ-КОРЗИНА — РАБОЧАЯ ВЕРСИЯ ИЗ contacts.js (2025) ===
document.addEventListener("DOMContentLoaded", () => {
  const cartBtn = document.getElementById('cartBtn');
  const miniCart = document.getElementById('miniCartDropdown');
  if (!cartBtn || !miniCart) return;

  const cartWrapper = cartBtn.closest('.cart-wrapper');
  let hoverTimeout;

  const openCart = () => {
    clearTimeout(hoverTimeout);
    miniCart.classList.add('show');
    if (typeof updateCart === 'function') updateCart();
  };

  const closeCart = () => {
    hoverTimeout = setTimeout(() => {
      if (!miniCart.matches(':hover') && !cartBtn.matches(':hover')) {
        miniCart.classList.remove('show');
      }
    }, 300);
  };

  // Hover (только на десктопе)
  if (window.innerWidth > 860) {
    cartBtn.addEventListener('mouseenter', openCart);
    cartWrapper.addEventListener('mouseleave', closeCart);
    miniCart.addEventListener('mouseenter', () => clearTimeout(hoverTimeout));
  }

  // Клик (для мобильных + если hover не сработал)
  cartBtn.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    miniCart.classList.toggle('show');
    if (miniCart.classList.contains('show') && typeof updateCart === 'function') updateCart();
  });

  // Закрытие по клику вне
  document.addEventListener('click', (e) => {
    if (!cartWrapper.contains(e.target)) {
      miniCart.classList.remove('show');
    }
  });

  // Перейти в корзину
  document.getElementById('goToCartBtn')?.addEventListener('click', () => {
    location.href = '/bin';
  });
});
</script>
<script defer>
// === ОБРАТНАЯ СВЯЗЬ — ПОЛНАЯ БЛОКИРОВКА БЕЗ АВТОРИЗАЦИИ (ПК + МОБИЛКА) ===
document.addEventListener("DOMContentLoaded", () => {

  const isAuthenticated = () => !!(sessionStorage.getItem('phone') || localStorage.getItem('phone'));

  // Тост-алерт (один раз)
  if (!window.showCustomAlert) {
    window.showCustomAlert = (text, isError = true) => {
      document.querySelectorAll('.toast-alert').forEach(t => t.remove());
      const toast = document.createElement('div');
      toast.className = `toast-alert ${isError ? 'error' : ''}`;
      toast.innerHTML = `
        <div class="alert-text">
          <strong>${isError ? 'Ошибка' : 'Успех'}</strong>
          <span>${text}</span>
        </div>
        <button class="alert-close">×</button>
      `;
      document.body.appendChild(toast);
      requestAnimationFrame(() => toast.classList.add('show'));
      toast.querySelector('.alert-close').onclick = () => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 500);
      };
      setTimeout(() => toast.isConnected && toast.classList.remove('show') && setTimeout(() => toast.remove(), 500), 5000);
    };
  }

  // === УДАЛЯЕМ ВСЕ СТАРЫЕ ОБРАБОТЧИКИ НА КНОПКАХ ===
  ['#feedbackBtn', '#feedbackBtnMobile'].forEach(selector => {
    document.querySelectorAll(selector).forEach(btn => {
      const newBtn = btn.cloneNode(true);
      btn.replaceWith(newBtn);
    });
  });

  // === ДЕСКТОПНАЯ КНОПКА (ПК) ===
  document.getElementById('feedbackBtn')?.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation();

    if (!isAuthenticated()) {
      showCustomAlert('Войдите в аккаунт', true);
      return;
    }

    // ТОЛЬКО если это ПК — открываем десктопную модалку
    if (window.innerWidth > 1024) {
      const modal = document.getElementById('feedbackModal');
      modal.classList.add('show');
      document.body.style.overflow = 'hidden';

      // Подставляем телефон
      const phone = sessionStorage.getItem('phone') || localStorage.getItem('phone');
      if (phone) {
        const clean = phone.replace(/\D/g, '');
        const formatted = clean.length === 11 
          ? `+7 (${clean.slice(1,4)}) ${clean.slice(4,7)}-${clean.slice(7,9)}-${clean.slice(9)}`
          : phone;
        const input = modal.querySelector('input[type="tel"]');
        if (input) input.value = formatted;

      }
    }
  });

  // === МОБИЛЬНАЯ КНОПКА ===
 // === МОБИЛЬНАЯ КНОПКА ПОДДЕРЖКИ — ПРАВИЛЬНЫЙ АЛЕРТ, КАК НА ДЕСКТОПЕ ===
document.getElementById('feedbackBtnMobile')?.addEventListener('click', function(e) {
  e.preventDefault();
  e.stopPropagation();

  if (!isAuthenticated()) {
    // ←←← ВОТ ТУТ БЫЛ ТОСТ, А ДОЛЖЕН БЫТЬ КРАСИВЫЙ АЛЕРТ
    const authAlert = document.getElementById('authAlert');
    authAlert.classList.add('show');
    document.body.style.overflow = 'hidden';

    // Кнопка "Войти" в алерте открывает модалку авторизации
    document.getElementById('authBtnFeedback')?.addEventListener('click', () => {
      authAlert.classList.remove('show');
      document.body.style.overflow = '';
      document.getElementById('authModal').style.display = 'flex';
    });

    // Закрытие алерта
    authAlert.querySelector('.alert-close')?.addEventListener('click', () => {
      authAlert.classList.remove('show');
      document.body.style.overflow = '';
    });

    // Клик вне контента — закрыть
    authAlert.addEventListener('click', (ev) => {
      if (ev.target === authAlert) {
        authAlert.classList.remove('show');
        document.body.style.overflow = '';
      }
    });

    return;
  }

  // Если авторизован — открываем мобильную шторку обратной связи
  const sheet = document.getElementById('mobileFeedbackSheet');
  sheet.classList.add('active');
  document.body.style.overflow = 'hidden';

  // Автозаполнение телефона
  const phone = sessionStorage.getItem('phone') || localStorage.getItem('phone');
  if (phone) {
    const clean = phone.replace(/\D/g, '');
    const formatted = clean.length === 11 
      ? `+7 (${clean.slice(1,4)}) ${clean.slice(4,7)}-${clean.slice(7,9)}-${clean.slice(9)}`
      : phone;
    const input = sheet.querySelector('input[type="tel"]');
    if (input) input.value = formatted;
  }
});

  // === ЗАКРЫТИЕ МОДАЛОК (чтобы не было конфликтов) ===
  document.getElementById('closeFeedback')?.addEventListener('click', () => {
    document.getElementById('feedbackModal').classList.remove('show');
    document.body.style.overflow = '';
  });

  document.getElementById('feedbackModal')?.addEventListener('click', e => {
    if (e.target === document.getElementById('feedbackModal')) {
      document.getElementById('feedbackModal').classList.remove('show');
      document.body.style.overflow = '';
    }
  });

  // Мобильная шторка — закрытие
  document.querySelectorAll('#closeMobileFeedback, .sheet-back-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.getElementById('mobileFeedbackSheet').classList.remove('active');
      document.body.style.overflow = '';
    });
  });
});
</script>

<!-- КНОПКА ФИЛЬТРА НА МОБИЛКЕ -->
<div id="mobileCatalogTrigger">
  <i class="fas fa-sliders-h"></i>
</div>

<!-- ШТОРКА КАТАЛОГА НА МОБИЛКЕ -->
<div id="mobileCatalogOverlay">
  <div id="mobileCatalogSheet">
    <div class="mobile-catalog-close">×</div>
    <ul class="catalog-list"></ul>
  </div>
</div>

<script>
// МОБИЛЬНАЯ ШТОРКА КАТАЛОГА — УЛЬТРА-ПРЕМИУМ ВЕРСИЯ 2025 (ИДЕАЛЬНО РАБОТАЕТ)
document.addEventListener('DOMContentLoaded', () => {
  const trigger   = document.getElementById('mobileCatalogTrigger');
  const overlay   = document.getElementById('mobileCatalogOverlay');
  const sheet     = document.getElementById('mobileCatalogSheet');
  const closeBtn  = sheet?.querySelector('.mobile-catalog-close');
  const catalogList = sheet?.querySelector('.catalog-list');

  if (!trigger || !overlay || !sheet || !closeBtn || !catalogList) {
    console.error('Мобильная шторка каталога не найдена!');
    return;
  }

  let startX = 0;
  let currentX = 0;
  let isDragging = false;
  let isClosing = false;
  const threshold = 120;
  const sheetWidth = sheet.offsetWidth; // фиксируем ширину один раз

  // === КОПИРОВАНИЕ КАТАЛОГА ===
  const copyCatalog = () => {
    const original = document.querySelector('#sideCatalog .catalog-list');
    if (!original) return;

    catalogList.innerHTML = original.innerHTML;

    const activeOriginal = original.querySelector('li.active');
    if (activeOriginal) {
      const filter = activeOriginal.querySelector('[data-filter]')?.dataset.filter;
      if (filter) {
        const mobileActive = catalogList.querySelector(`[data-filter="${filter}"]`)?.closest('li');
        if (mobileActive) {
          catalogList.querySelectorAll('li').forEach(li => li.classList.remove('active'));
          mobileActive.classList.add('active');
        }
      }
    }
  };

  // === ОТКРЫТИЕ ===
  const openSheet = () => {
    if (isClosing || sheet.classList.contains('active')) return;
    copyCatalog();
    overlay.classList.add('active');
    sheet.classList.add('active');
    sheet.style.transform = 'translateX(0)'; // принудительно на весь экран
    document.body.style.overflow = 'hidden';
  };

  // === ЗАКРЫТИЕ ===
  const closeSheet = () => {
    if (isClosing || !sheet.classList.contains('active')) return;
    isClosing = true;

    sheet.classList.remove('active');
    overlay.classList.remove('active');

    const onEnd = () => {
      sheet.style.transition = '';
      sheet.style.transform = 'translateX(-100%)';
      document.body.style.overflow = '';
      isClosing = false;
      sheet.removeEventListener('transitionend', onEnd);
    };
    sheet.addEventListener('transitionend', onEnd);
    setTimeout(onEnd, 600);
  };

  // === КНОПКИ ===
  trigger.addEventListener('click', openSheet);
  closeBtn.addEventListener('click', closeSheet);
  overlay.addEventListener('click', e => e.target === overlay && closeSheet());

  // === УМНЫЙ СВАЙП (СЛЕВА → ОТКРЫТЬ, СПРАВА → ЗАКРЫТЬ) ===
  const handleStart = (e) => {
    if (isClosing) return;
    startX = currentX = e.touches?.[0].clientX || e.clientX;
    isDragging = true;
    sheet.style.transition = 'none';
  };

  const handleMove = (e) => {
    if (!isDragging) return;
    currentX = e.touches?.[0].clientX || e.clientX;
    const diff = currentX - startX;

    // Открыта — свайп СПРАВА НАЛЕВО
    if (sheet.classList.contains('active')) {
      if (diff < 0) {
        e.preventDefault();
        // Ограничиваем: не даём уйти правее 0
        const limited = Math.max(diff, -sheetWidth);
        sheet.style.transform = `translateX(${limited}px)`;
      }
    }
    // Закрыта — свайп СЛЕВА НАПРАВО от края
    else if (startX <= 60 && diff > 0) {
      e.preventDefault();
      // Ограничиваем: не даём открыть больше чем на ширину шторки
      const limited = Math.min(diff, sheetWidth);
      sheet.style.transform = `translateX(${limited - sheetWidth}px)`;
    }
  };

  const handleEnd = () => {
    if (!isDragging) return;
    isDragging = false;

    const diff = currentX - startX;

    // Закрываем
    if (sheet.classList.contains('active') && diff < -threshold) {
      closeSheet();
    }
    // Открываем
    else if (!sheet.classList.contains('active') && startX <= 60 && diff > threshold) {
      openSheet();
    }
    // Возвращаем на место
    else {
      sheet.style.transition = 'transform 0.44s cubic-bezier(0.22, 1, 0.36, 1)';
      sheet.style.transform = sheet.classList.contains('active')
        ? 'translateX(0)'
        : 'translateX(-100%)';
      setTimeout(() => sheet.style.transition = '', 450);
    }
  };

  // === СЛУШАТЕЛИ ===
  document.addEventListener('touchstart', handleStart, { passive: true });
  document.addEventListener('touchmove', handleMove, { passive: false });
  document.addEventListener('touchend', handleEnd);

  // Для десктопа (тест)
  document.addEventListener('mousedown', handleStart);
  document.addEventListener('mousemove', e => isDragging && handleMove(e));
  document.addEventListener('mouseup', handleEnd);

  // === КЛИК ПО ФИЛЬТРУ ===
  catalogList.addEventListener('click', e => {
    const clicked = e.target.closest('[data-filter]');
    if (!clicked) return;

    const filterValue = clicked.dataset.filter;
    if (!filterValue) return;

    closeSheet();

    document.querySelectorAll('#sideCatalog .catalog-list li').forEach(li => li.classList.remove('active'));
    const desktopItem = document.querySelector(`#sideCatalog .catalog-list [data-filter="${filterValue}"]`);
    if (desktopItem) {
      desktopItem.closest('li')?.classList.add('active');
    }

    if (typeof applyFiltersAndSort === 'function') {
      applyFiltersAndSort();
    }
  });
});
</script>
<script>
// СВАЙП ВНИЗ → ЗАКРЫТЬ МОДАЛКУ (ТОЛЬКО НА МОБИЛКЕ — БЕЗ МИГАНИЯ, НАВСЕГДА!)
(() => {
  const modal = document.getElementById('modal');
  if (!modal) return;

  let startY = 0;
  let isDragging = false;
  const threshold = 150;

  const isMobile = () => window.innerWidth <= 1024 || 'ontouchstart' in window;

  const handleStart = (e) => {
    if (!modal.classList.contains('active') || !isMobile()) return;

    const target = e.target;
    const scrollable = target.closest('.modal-info, .reviews-list, .modal-gallery');
    if (scrollable && scrollable.scrollTop > 10) return;

    startY = e.touches[0].clientY;
    isDragging = true;
    modal.style.transition = 'none';
  };

  const handleMove = (e) => {
    if (!isDragging) return;

    const currentY = e.touches[0].clientY;
    const diff = currentY - startY;

    if (diff > 0) {
      e.preventDefault();
      modal.style.transform = `translateY(${diff}px)`;
      const opacity = Math.max(0.3, 1 - diff / 600);
      modal.style.background = `rgba(0,0,0,${opacity})`;
    }
  };

  const handleEnd = () => {
    if (!isDragging) return;
    isDragging = false;

    const diff = parseInt(modal.style.transform.match(/-?\d+\.?\d*/)?.[0] || 0);

    if (diff > threshold) {
      modal.style.transition = 'transform 0.55s cubic-bezier(0.22,1,0.36,1), background 0.55s';
      modal.style.transform = 'translateY(110vh)';
      modal.style.background = 'rgba(0,0,0,0)';

      // ВЫЗЫВАЕМ ТОЛЬКО ГЛОБАЛЬНЫЙ closeModal — И БОЛЬШЕ НИКАКИХ fallback!
      setTimeout(() => {
        if (typeof window.closeModal === 'function') {
          window.closeModal();
        }
        // ← БЕЗ else! БЕЗ локальной closeModal()!
      }, 550);
    } else {
      modal.style.transition = 'transform 0.44s cubic-bezier(0.22,1,0.36,1), background 0.4s';
      modal.style.transform = 'translateY(0)';
      modal.style.background = 'rgba(0,0,0,0.92)';
      setTimeout(() => modal.style.transition = '', 450);
    }
  };

  modal.addEventListener('touchstart', handleStart, { passive: true });
  modal.addEventListener('touchmove', handleMove, { passive: false });
  modal.addEventListener('touchend', handleEnd);
})();
</script>
</body>
</html>
