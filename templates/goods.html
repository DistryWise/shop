<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Товары — Piligrim · 2025</title>

  <!-- Шрифты и иконки -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;900&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Alex+Brush&display=swap" rel="stylesheet">

  <!-- Основные стили страницы услуг -->
  <link rel="stylesheet" href="/static/css/services.css">

  <!-- Стили хедера, поиска, корзины, авторизации, AI и т.д. — ТОЧНО как на about_company -->
  <link rel="stylesheet" href="/static/css/search.css">
  <link rel="stylesheet" href="/static/css/auth.css">
  <link rel="stylesheet" href="/static/css/cart.css">
  <link rel="stylesheet" href="/static/css/ai.css">
  <link rel="stylesheet" href="/static/css/contacts.css">

  <!-- ЛОАДЕР + КУРСОР + ОСНОВНЫЕ СТИЛИ (точно как в about_company.css) -->
  

</head>
<body>

  <!-- ЛОАДЕР -->
  <div class="loader" id="pageLoader"></div>



  <!-- КАСТОМНЫЙ КУРСОР (из contacts) -->
  <div class="custom-cursor"></div>

  <!-- ==================== ПОЛНЫЙ ХЕДЕР ИЗ КОНТАКТОВ (с авторизацией, корзиной, обратной связью) ==================== -->
  <header>
    <a href="/" class="logo"><img src="/static/assets/logo.png" alt="Piligrim" class="logo-img"></a>
    <nav>
      <a href="/" class="nav-link">Главная</a>
      <a href="/goods" class="nav-link active">Товары</a>
      <a href="/services" class="nav-link">Услуги</a>
      <a href="/news" class="nav-link">Новости</a>
      <a href="/about_company" class="nav-link">О компании</a>
      <a href="/contacts" class="nav-link">Контакты</a>
    </nav>
    <div class="header-icons">
      <div class="search-wrapper">
        <div class="search-container">
          <div class="search-icon"><i class="fas fa-search"></i></div>
          <input type="text" class="search-input" id="searchInput" placeholder="Поиск...">
          <button id="searchClear" class="search-clear">×</button>
        </div>
        <div id="autocompleteList" class="autocomplete-list"></div>
      </div>
      <button id="authBtn" class="icon-btn"><i class="fas fa-user"></i></button>
      
      <div style="position: relative;">
        <button class="icon-btn" id="cartBtn">
          <i class="fas fa-shopping-bag"></i>
          <span class="cart-count" id="cartCount">0</span>
        </button>
        <div id="miniCartDropdown">
          <div class="mini-cart-header"><div class="mini-cart-title">Корзина</div></div>
          <div class="mini-cart-items" id="miniCartItems"><div class="mini-cart-empty">Корзина пуста</div></div>
          <div class="mini-cart-footer">
            <div class="mini-cart-total" id="miniCartTotal">Итого: 0.00 ₽</div>
            <button class="go-to-cart-btn" id="goToCartBtn">Оформить</button>
          </div>
        </div>
      </div>

      <button class="icon-btn" id="feedbackBtn"><i class="fas fa-envelope"></i></button>
    </div>
  </header>

  <!-- МОДАЛКА ОБРАТНОЙ СВЯЗИ -->
  <div class="custom-alert" id="feedbackModal">
    <div class="alert-content">
      <button class="alert-close" id="closeFeedback">×</button>

      <div class="alert-icon">
        <i class="fas fa-envelope-open-text"></i>
      </div>

      <div class="alert-text">
        <strong>Обратная связь</strong>
        <span>Оставьте заявку — мы свяжемся с вами в ближайшее время</span>
      </div>

      <form class="contact-form" novalidate id="contactForm">
        <input type="text" placeholder="Ваше имя" name="name" required />
        
        <div class="phone-field-wrapper">
          <input type="tel" placeholder="+7 (___) ___-__-__" name="phone" pattern="\+7\s?\(\d{3}\)\s?\d{3}-\d{2}-\d{2}" required />
          <button type="button" class="edit-phone-btn" style="display:none;">Изменить</button>
        </div>
        
        <input type="email" placeholder="Email" name="email" required />
        <textarea placeholder="Ваше сообщение" name="message" required></textarea>

        <button type="submit" id="submitBtn" class="alert-login-btn">
          <span class="btn-text">Отправить сообщение</span>
          <span class="btn-cooldown">Отправка... <span class="timer">30</span>с</span>
        </button>
      </form>
    </div>
  </div>

<!-- МОДАЛКА АВТОРИЗАЦИИ — ПОЛНОСТЬЮ РАБОЧАЯ ВЕРСИЯ -->
<div id="authModal" class="auth-modal">
  <div class="auth-modal-content">
    <button class="close-modal" id="closeAuthModal">×</button>
    <h2 class="auth-title">Вход по номеру телефона</h2>

    <!-- ШАГ 1 — ВВОД НОМЕРА -->
    <div id="stepPhone" class="auth-step">
      <div class="country-selector">
        <div class="selected-country" id="selectedCountry">
          <span class="flag">RU</span>
          <span class="code">+7</span>
          <i class="fas fa-chevron-down"></i>
        </div>
        <div class="country-dropdown" id="countryDropdown">
          <div class="country-item" data-code="+7" data-flag="RU">Россия +7</div>
          <div class="country-item" data-code="+1" data-flag="US">USA +1</div>
          <div class="country-item" data-code="+44" data-flag="GB">UK +44</div>
        </div>
      </div>

      <input type="tel" id="phoneInput" placeholder="(999) 999 99 99" class="auth-input">

      <!-- Обязательное согласие -->
      <label class="checkbox-label required">
        <input type="checkbox" id="privacyCheck">
        <span class="custom-checkbox"></span>
        Согласен с <a href="/policy" target="_blank" class="privacy-link">политикой конфиденциальности</a>
      </label>

      <!-- Автоматическая подписка на рассылку -->
      <label class="checkbox-label">
        <input type="checkbox" id="subscribeCheck" checked>
        <span class="custom-checkbox"></span>
        Получать SMS с акциями и уведомлениями
      </label>

      <button id="sendCodeBtn" class="auth-btn" disabled>Получить код</button>
    </div>

    <!-- ШАГ 2 — ВВОД КОДА -->
    <div id="stepCode" class="auth-step" style="display:none;">
      <p class="auth-info">Код отправлен на <span id="maskedPhone"></span></p>
      <input type="text" id="codeInput" placeholder="____" maxlength="4" class="auth-input">
      <button id="verifyCodeBtn" class="auth-btn">Войти</button>
      <button id="resendCode" class="auth-link">Отправить повторно</button>
    </div>

    <!-- ШАГ 3 — УСПЕШНЫЙ ВХОД -->
    <div id="stepSuccess" class="auth-step" style="display:none;">
      <i class="fas fa-check-circle success-icon"></i>
      <h3>Добро пожаловать!</h3>
      <p>Вы успешно вошли как <span id="welcomePhone"></span></p>
      <button id="closeSuccess" class="auth-btn">Продолжить</button>
    </div>
  </div>
</div>
<!-- КАРТОЧКА ТОВАРА — РАБОЧАЯ, КАК В ZAZA -->
<div class="product-modal" id="productModal">
  <div class="product-content">
    <!-- Крестик закрытия -->
    <button class="close-modal" onclick="closeProductModal()">
      <svg width="28" height="28" viewBox="0 0 28 28" fill="none">
        <path d="M6 6L22 22M6 22L22 6" stroke="currentColor" stroke-width="2.3" stroke-linecap="round"/>
      </svg>
    </button>

    <!-- Основной контейнер -->
    <div class="product-main">
      <img id="productImg" class="product-img" src="/static/assets/no-image.png" alt="Товар">

      <div class="product-info">
        <h3 id="productTitle" class="product-title">Загрузка...</h3>

        <!-- Рейтинг и отзывы -->
        <div class="product-rating">
          <div class="stars"></div>
          <span id="productReviewsCount" class="reviews-count">—</span>
        </div>

        <div id="productPrice" class="product-price">—</div>

        <div id="productDescription" class="product-description">Загрузка описания...</div>

        <!-- Кнопка "В корзину" -->
        <button id="addToCartModal" class="add-to-cart-btn">
          <i class="fas fa-shopping-cart"></i> В корзину
        </button>

        <!-- ОТЗЫВЫ — ТОЧНО КАК В НОВОСТЯХ -->
        <div class="product-reviews">
          <h4 class="reviews-title">Отзывы покупателей</h4>
          <div class="reviews-list" id="productReviewsList">
            <div style="text-align:center;padding:3rem;color:#888;">
              <i class="far fa-star" style="font-size:3rem;margin-bottom:1rem;display:block;opacity:0.6;"></i>
              <p>Отзывов пока нет</p>
              <small style="opacity:0.7;">Будьте первым!</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


  
  <div class="white-overlay" id="whiteOverlay"></div>

  <section class="hero" id="hero">
    <div class="slide active"></div>
    <div class="slide"></div>
    <div class="slide"></div>
    <div class="slide"></div>
    <div class="void-cut"></div>
    <div class="scroll-indicator">Скролл вниз для входа</div>
  </section>

  <nav class="side-catalog" id="sideCatalog">
    <div class="catalog-toggle">CATALOGUE</div>
    <ul class="catalog-list"></ul>
  </nav>
  <div class="catalog-arrow-hint" id="catalogArrowHint"></div>

  <section class="light-zone" id="lightZone">
    <div class="sort-panel">
      <button class="sort-btn active" data-sort="default">DEFAULT</button>
      <button class="sort-btn" data-sort="price">PRICE ↑</button>
    </div>
    <div class="grid-controls">
      <button class="grid-btn active" data-cols="3">
        <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
      </button>
      <button class="grid-btn" data-cols="2">
        <svg viewBox="0 0 24 24"><rect x="3" y="3" width="9" height="18"/><rect x="14" y="3" width="9" height="18"/></svg>
      </button>
    </div>
    <div class="catalog-header"><h1>Товары</h1></div>
<div class="search-wrapper" style="max-width:1100px;margin:0 auto 180px;position:relative;">
      <div class="search-container" style="position:relative;max-width:900px;margin:0 auto;">
        
        <input type="text" 
               class="search" 
               id="search" 
               placeholder="Поиск..." 
               style="width:100%;background:transparent;border:none;border-bottom:3px solid #000;font-family:'Inter',sans-serif;font-weight:300;font-size:22px;letter-spacing:4px;color:#000;text-align:center;padding:20px 60px 20px 0;outline:none;box-sizing:border-box;"
               autocomplete="off">

<div class="search-icon" style="position:absolute;right:0;top:50%;transform:translateY(-50%);width:40px;height:40px;opacity:0.35;transition:all .8s cubic-bezier(.16,1,.3,1);pointer-events:none;">
  <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTEiIGN5PSIxMSIgcj0iNyIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjIuNCIvPgo8cGF0aCBkPSJNMTYuNSAxNi41TDIwLjUgMjAuNSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjIuNiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+Cjwvc3ZnPg==" alt="поиск" style="width:100%;height:100%;display:block;">
</div>
      </div>
    </div>
    <div class="grid" id="grid"></div>
    <div id="adBannerSection" class="noir-island-wrapper">
      <div class="secondary-carousel">
        <div class="carousel-inner" id="services-carousel-inner"></div>
        <div class="indicators"></div>
      </div>
    </div>
  </section>

  <div class="load-more-section">
    <button class="load-more-btn" type="button">LOAD MORE</button>
  </div>

  <!-- МОДАЛКА -->
<!-- МОДАЛКА (ОДНА НА ВЕСЬ САЙТ — И НА УСЛУГИ, И НА ТОВАРЫ) -->
<div class="modal" id="modal">
  <button class="modal-close-btn" aria-label="Закрыть">
    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round">
      <line x1="18" y1="6" x2="6" y2="18"/>
      <line x1="6" y1="6" x2="18" y2="18"/>
    </svg>
  </button>
  <div class="close">×</div>
  <div class="modal-content">
    <div class="modal-gallery">
      <img id="modal-img" src="" alt="">
      <div class="gallery-thumbs" id="modal-thumbs"></div>
    </div>
    <div class="modal-info">
      <div class="info-header">
        <h3 id="modal-title"></h3>
        <div class="price" id="modal-price">₽ —</div>
      </div>
      <p id="modal-desc"></p>
      <div class="rating" id="modal-rating">
        <span class="stars">★★★★★</span>
        <span class="value">0.0</span>
        <span class="count">(0)</span>
      </div>
      <button class="order-btn" id="modal-order">ЗАКАЗАТЬ</button>
      <div class="reviews-section">
        <h4>ОТЗЫВЫ</h4>
        <div class="reviews" id="modal-reviews"></div>
        <p class="no-reviews" id="no-reviews">Отзывов пока нет</p>
      </div>
    </div>
  </div>
</div>

  <footer id="footer">
    <span>© 2025 Piligrim · NO ADDRESS · NO PHONE</span>
  </footer>

  <!-- УВЕДОМЛЕНИЯ -->
  <div id="toast-container"></div>



<!-- КРАСИВАЯ КНОПКА ВЫХОДА ИЗ БЕЛОЙ ЗОНЫ — ФИНАЛЬНАЯ ВЕРСИЯ 2025 -->
<div id="exitWhiteZoneBtn">
  <span class="exit-text">НАВЕРХ · В NOIR</span>
  <div class="exit-arrow">
    <svg viewBox="0 0 38 38" fill="none" stroke="currentColor" stroke-width="1.7">
      <path d="M19 8v18M11 16l8-8 8 8"/>
    </svg>
  </div>
</div>

<script src="static/js/goods.js"></script>
<script src="/static/js/search.js"></script>
<script src="/static/js/auth.js"></script>
<script src="/static/js/cart.js" defer></script>
<script src="/static/js/feedback.js"></script>
<script src="/static/js/ai.js"></script>
<script src="/static/js/contacts.js"></script>

<script>
      document.getElementById('search')?.addEventListener('focus', e => {
        e.target.nextElementSibling.style.opacity = '0.8';
        e.target.nextElementSibling.style.transform = 'translateY(-50%) scale(1.15)';
      });
      document.getElementById('search')?.addEventListener('blur', e => {
        e.target.nextElementSibling.style.opacity = '0.3';
        e.target.nextElementSibling.style.transform = 'translateY(-50%) scale(1)';
      });
</script>
    
<script>
    document.addEventListener('DOMContentLoaded', () => {
      document.body.classList.add('loaded');
      const loader = document.getElementById('pageLoader');
      setTimeout(() => loader.classList.add('hidden'), 900);

      // Кастомный курсор
      const cursor = document.querySelector('.custom-cursor');
      if(cursor){
        document.body.style.cursor = 'none';
        document.addEventListener('mousemove', e => {
          cursor.style.left = e.clientX + 'px';
          cursor.style.top = e.clientY + 'px';
        });
        document.querySelectorAll('a, button, input, textarea, [onclick], .clickable, .nav-link').forEach(el => {
          el.addEventListener('mouseenter', () => cursor.classList.add('hover'));
          el.addEventListener('mouseleave', () => cursor.classList.remove('hover'));
        });
      }

      // Хедер + кнопка наверх
      const header = document.querySelector('header');
      const backToTop = document.querySelector('.back-to-top');
      window.addEventListener('scroll', () => {
        const scrolled = window.pageYOffset;
        header.classList.toggle('scrolled', scrolled > 50);
        backToTop.classList.toggle('visible', scrolled > 500);
      });

      // Плавный скролл по якорям
      document.querySelectorAll('a[href^="#"], .nav-link, .back-to-top').forEach(link => {
        link.addEventListener('click', function(e) {
          const href = this.getAttribute('href');
          if (href === '#' || href.startsWith('#')) {
            e.preventDefault();
            const target = document.querySelector(href === '#' ? 'html' : href);
            if (target) {
              const offset = 80;
              const pos = target.getBoundingClientRect().top + window.pageYOffset - offset;
              window.scrollTo({top: pos, behavior: 'smooth'});
            }
          }
        });
      });
    });
  </script>

<!-- === КРАСИВЫЕ ТОСТЫ + КОРЗИНА + ЗАЩИТА ОТ СПАМА (2025 FINAL) === -->
<div id="my-toast-container"></div>

<style>
  #my-toast-container {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 2147483647;
    pointer-events: none;
    font-family: 'Inter', sans-serif;
  }
  .mytoast {
    background: rgba(20,20,20,0.96);
    color: #fff;
    padding: 18px 28px;
    margin-top: 12px;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.6);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.12);
    min-width: 360px;
    display: flex;
    align-items: center;
    gap: 16px;
    transform: translateX(420px);
    opacity: 0;
    transition: all 0.75s cubic-bezier(0.16, 1, 0.3, 1);
    pointer-events: auto;
    font-weight: 500;
  }
  .mytoast.show { transform: translateX(0); opacity: 1; }
  .mytoast.success { border-left: 6px solid #00ff9d; }
  .mytoast.error   { border-left: 6px solid #ff3b30; }
  .mytoast i { font-size: 1.7em; }

  /* Блокировка кнопки */
  button[disabled].spam-blocked {
    opacity: 0.5 !important;
    pointer-events: none !important;
    position: relative;
  }
  button[disabled].spam-blocked::after {
    content: "Подождите...";
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    font-size: 0.9em;
    color: #ff3b30;
    font-weight: 600;
  }
  button[disabled].spam-blocked {
  opacity: 1 !important;
  pointer-events: none !important;
  position: relative;
  background: rgba(20, 20, 20, 0.96) !important;  /* тёмный фон */
  border: 1px solid rgba(255, 255, 255, 0.15) !important;
  color: transparent !important;                /* скрываем оригинальный текст */
  cursor: default !important;
  transform: none !important;
}

button[disabled].spam-blocked::after {
  content: "Подождите...";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 1em;
  font-weight: 600;
  color: #ff3b30;
  text-shadow: 0 1px 3px rgba(0,0,0,0.5);
  white-space: nowrap;
  z-index: 10;
}

/* Если у тебя кнопка заказа имеет свой цвет (например зелёный или белый) — перебиваем его */
#modal-order[disabled].spam-blocked,
.add-to-cart-btn[disabled].spam-blocked,
.go-to-cart-btn[disabled].spam-blocked {
  background: rgba(20, 20, 20, 0.96) !important;
}
</style>

<script>
// === ТОСТЫ ===
function toast(message, type = 'success') {
  const container = document.getElementById('my-toast-container');
  const t = document.createElement('div');
  t.className = `mytoast ${type}`;
  t.innerHTML = `<i class="fas fa-${type==='success'?'check-circle':'exclamation-triangle'}"></i><span>${message}</span>`;
  container.appendChild(t);
  setTimeout(() => t.classList.add('show'), 50);
  setTimeout(() => {
    t.classList.remove('show');
    setTimeout(() => t.remove(), 800);
  }, 3600);
}
window.alert = (msg) => toast(msg, 'error');

// === ЗАЩИТА ОТ СПАМА (5 кликов → блок 30 сек) ===
let clickHistory = [];
let spamBlockedUntil = 0;

function isSpamBlocked() {
  const now = Date.now();
  clickHistory = clickHistory.filter(t => now - t < 20000);
  if (clickHistory.length >= 5) {
    spamBlockedUntil = now + 30000;
    return true;
  }
  return now < spamBlockedUntil;
}

function allowClick(blockedBtn) {
  if (isSpamBlocked()) {
    const remaining = Math.ceil((spamBlockedUntil - Date.now()) / 1000);
    toast(`Слишком быстро! Подождите ${remaining} сек.`, 'error');
    
    blockedBtn.disabled = true;
    blockedBtn.classList.add('spam-blocked');
    setTimeout(() => {
      blockedBtn.disabled = false;
      blockedBtn.classList.remove('spam-blocked');
    }, spamBlockedUntil - Date.now() + 100);
    return false;
  }
  clickHistory.push(Date.now());
  return true;
}
// === ФИНАЛЬНАЯ ВЕРСИЯ addToCartById — РАБОТАЕТ НА 100% ===

</script>
<script>
// УНИВЕРСАЛЬНЫЙ АНТИСПАМ 2025 — РАБОТАЕТ НА ВСЕХ КНОПКАХ "В КОРЗИНУ" И ИЗМЕНЕНИЯ КОЛИЧЕСТВА
// Защищает от спама: + / – / удалить / любые onclick="addToCart(...)" / кнопки с классами
const GlobalAddToCartProtection = (() => {
  const STORAGE_KEY = 'cart_flood_protection_2025';
  const COOLDOWN_MS = 20000;    // 20 сек блок после спама
  const MAX_CLICKS = 9;         // сколько быстрых кликов разрешено

  let clickCount = 0;
  let resetTimer = null;
  let blockedUntil = 0;

  // Загружаем состояние
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      const data = JSON.parse(saved);
      blockedUntil = data.blockedUntil || 0;
    }
  } catch (e) {}

  const block = () => {
    blockedUntil = Date.now() + COOLDOWN_MS;
    localStorage.setItem(STORAGE_KEY, JSON.stringify({ blockedUntil }));

    // Красивый красный алерт с таймером
    const alert = document.createElement('div');
    alert.id = 'global-cart-flood-alert';
    alert.innerHTML = `
      <i class="fas fa-hand-paper"></i>
      <div>
        <strong>Слишком быстро!</strong><br>
        <small>Подождите <span class="timer">20</span> сек</small>
      </div>
    `;
    Object.assign(alert.style, {
      position: 'fixed', top: '20px', left: '50%', transform: 'translateX(-50%)',
      background: 'linear-gradient(135deg,#ff453a,#ff2d55)', color: 'white',
      padding: '16px 32px', borderRadius: '26px', fontSize: '1.15rem',
      fontWeight: '600', boxShadow: '0 20px 50px rgba(255,45,85,0.5)',
      backdropFilter: 'blur(20px)', display: 'flex', alignItems: 'center', gap: '14px',
      zIndex: '999999', animation: 'slideDown 0.5s ease'
    });
    document.body.appendChild(alert);

    let seconds = 20;
    const timerSpan = alert.querySelector('.timer');
    const interval = setInterval(() => {
      seconds--;
      timerSpan.textContent = seconds;
      if (seconds <= 0) {
        clearInterval(interval);
        alert.remove();
      }
    }, 1000);

    setTimeout(() => alert.remove(), COOLDOWN_MS + 1000);
  };

  return {
    check() {
      const now = Date.now();
      if (blockedUntil > now) return false;

      clickCount++;
      clearTimeout(resetTimer);
      resetTimer = setTimeout(() => { clickCount = 0; }, 10000);

      if (clickCount > MAX_CLICKS) {
        block();
        clickCount = 0;
        return false;
      }
      return true;
    }
  };
})();

// УНИВЕРСАЛЬНЫЙ ПЕРЕХВАТЧИК — ЛОВИТ ВСЁ
document.addEventListener('click', function(e) {
  const target = e.target.closest(
    'button, .add-to-cart-btn, .buy-btn, .apple-qty-btn, .apple-remove-btn, ' +
    '.quantity-btn, .clear-cart-btn, [onclick*="addToCart("]'
  );

  if (!target) return;

  // Проверяем, это действие с корзиной?
  const onclick = target.getAttribute('onclick') || '';
  const isCartAction = 
    onclick.includes('addToCart(') ||
    target.classList.contains('apple-qty-btn') ||
    target.classList.contains('apple-remove-btn') ||
    target.classList.contains('quantity-btn') ||
    target.classList.contains('clear-cart-btn') ||
    target.classList.contains('add-to-cart-btn') ||
    target.classList.contains('buy-btn');

  if (isCartAction && !GlobalAddToCartProtection.check()) {
    e.preventDefault();
    e.stopImmediatePropagation();
    e.stopPropagation();
    return false;
  }
}, true); // true = capture phase → срабатывает раньше всех остальных обработчиков

// Анимация алерта
document.head.insertAdjacentHTML('beforeend', `
<style>
@keyframes slideDown {
  from { transform: translateX(-50%) translateY(-100px); opacity: 0; }
  to   { transform: translateX(-50%) translateY(0); opacity: 1; }
}
#global-cart-flood-alert i { font-size: 1.8rem; }
</style>
`);
</script>
<script>
// === ГЛОБАЛЬНАЯ ФУНКЦИЯ ЗАКРЫТИЯ МОДАЛКИ — РАБОТАЕТ ВЕЗДЕ ===
window.closeModal = function() {
  const modal = document.getElementById('modal');
  if (!modal) return;

  modal.classList.remove('active');
  document.body.style.overflow = '';

  // Убираем хеш из URL без перезагрузки
  if (window.location.hash) {
    history.replaceState(null, null, window.location.pathname + window.location.search);
  }
};

// === ЗАКРЫТИЕ ПО КРЕСТИКУ, ОВЕРЛЕЮ И ESC ===
document.addEventListener('DOMContentLoaded', () => {
  const modal = document.getElementById('modal');
  if (!modal) return;

  // Крестик
  document.querySelector('.modal-close-btn')?.addEventListener('click', closeModal);
  
  // Клик по оверлею
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });

  // ESC
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal.classList.contains('active')) {
      closeModal();
    }
  });
});
</script>

<script>
// Заменяем полностью этот скрипт внизу страницы
document.getElementById('modal-order')?.addEventListener('click', async function() {
  const button = this;
  const modal = document.getElementById('modal');
  if (!modal?.classList.contains('active')) return;

  const productId = modal.dataset.currentProductId;
  if (!productId) return toast('Ошибка: товар не найден', 'error');

  // === ЗАЩИТА ОТ ДВОЙНОГО КЛИКА ===
  if (button.disabled) return;
  
  // === МЕНЯЕМ СОСТОЯНИЕ КНОПКИ ===
  const originalText = button.textContent.trim();
  button.disabled = true;
  button.textContent = 'Добавляем...';

  try {
    const isService = location.pathname.includes('/services');
    await window.addToCart(productId, isService ? 'service' : 'product', 1);

    // Успешно — можно закрыть или оставить открытой
    closeModal();
    // toast уже показывает addToCart(), не дублируем
  } catch (err) {
    console.error('Ошибка добавления в корзину:', err);
    toast('Не удалось добавить товар. Попробуйте позже.', 'error');
  } finally {
    // ВСЕГДА ВОЗВРАЩАЕМ КНОПКУ В НОРМАЛЬНОЕ СОСТОЯНИЕ!
    setTimeout(() => {
      button.disabled = false;
      button.textContent = originalText; // "ЗАКАЗАТЬ"
    }, 300); // небольшая задержка, чтобы анимация не дёргалась
  }
});
</script>
</body>
</html>
